<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#faf9f7" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <title>Mavie | Salon Management Dashboard</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config - Premium Color Palette -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Premium Rose Gold & Navy Theme
                        primary: {
                            50: '#fdf8f6',
                            100: '#f9ebe5',
                            200: '#f4d7cb',
                            300: '#e9b8a5',
                            400: '#db9179',
                            500: '#c97458',  // Rose Gold accent
                            600: '#b85d42',
                            700: '#994a35',
                            800: '#7d3f2f',
                            900: '#68372b',
                        },
                        accent: {
                            50: '#f0f4f8',
                            100: '#d9e2ec',
                            200: '#bcccdc',
                            300: '#9fb3c8',
                            400: '#829ab1',
                            500: '#627d98',
                            600: '#486581',
                            700: '#334e68',  // Deep Navy
                            800: '#243b53',
                            900: '#102a43',
                        },
                        surface: {
                            50: '#faf9f7',
                            100: '#f5f3f0',
                            200: '#e8e6e1',
                            300: '#d3cfc7',
                            400: '#b8b2a7',
                            500: '#a39b8b',
                            600: '#857b6b',
                            700: '#6b6357',
                            800: '#504a41',
                            900: '#3d382f',
                        },
                        // Backwards compatible mavie colors (mapped to new palette)
                        mavie: {
                            50: '#faf9f7',    // surface-50
                            100: '#f5f3f0',   // surface-100
                            200: '#e8e6e1',   // surface-200
                            300: '#d3cfc7',   // surface-300 (beige tones)
                            400: '#c97458',   // primary-500 (Rose Gold)
                            500: '#a39b8b',   // surface-500
                            600: '#627d98',   // accent-500
                            700: '#486581',   // accent-600
                            800: '#334e68',   // accent-700 (Deep Navy)
                            900: '#243b53',   // accent-800
                        }
                    },
                    fontFamily: {
                        display: ['"Cormorant Garamond"', 'Georgia', 'serif'],
                        sans: ['"Inter"', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'soft-lg': '0 10px 40px -10px rgba(0, 0, 0, 0.1), 0 2px 10px -2px rgba(0, 0, 0, 0.04)',
                        'glow': '0 0 20px rgba(201, 116, 88, 0.15)',
                        'glow-accent': '0 0 20px rgba(72, 101, 129, 0.2)',
                    }
                }
            }
        }
    </script>

    <!-- Placeholder Comments -->
    <!-- Update:
         1. Overview Chart now shows Unit Price (Line) and New/Existing Customers (Stacked Bar).
         2. Added 'Incentive' KPI card that appears only when a specific staff is selected.
    -->

    <style>
        /* ===== Premium Base Styles ===== */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #faf9f7 0%, #f5f3f0 100%);
            min-height: 100vh;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 300px;
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }

        /* Premium Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #c97458, #db9179);
            border-radius: 10px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f5f3f0; }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #c97458, #db9179);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #b85d42; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .animate-slide-up { animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Premium Form Elements */
        select:disabled {
            background-color: #f5f3f0;
            color: #a39b8b;
            cursor: not-allowed;
            border-color: #e8e6e1;
            opacity: 0.7;
        }

        select, input {
            transition: all 0.2s ease;
        }

        select:focus, input:focus {
            box-shadow: 0 0 0 3px rgba(201, 116, 88, 0.15);
        }

        /* Edit Table Styles */
        .edit-input {
            width: 100%;
            min-width: 60px;
            padding: 8px 12px;
            border: 1px solid #e8e6e1;
            border-radius: 8px;
            text-align: right;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: white;
        }

        .edit-input:focus {
            outline: none;
            border-color: #c97458;
            box-shadow: 0 0 0 3px rgba(201, 116, 88, 0.1);
        }

        .edit-readonly {
            background-color: #faf9f7;
            color: #857b6b;
            border: none;
        }

        .changed-row {
            background: linear-gradient(90deg, rgba(201, 116, 88, 0.08), rgba(201, 116, 88, 0.03)) !important;
        }

        /* Device Mode Styles */
        body.mobile-mode { font-size: 16px; }
        body.mobile-mode .kpi-grid { grid-template-columns: 1fr !important; }
        body.mobile-mode .chart-container { max-width: 100% !important; height: 250px !important; }
        body.mobile-mode h1 { font-size: 1.5rem !important; }
        body.mobile-mode h2 { font-size: 1.25rem !important; }
        body.mobile-mode h3 { font-size: 1.1rem !important; }
        body.mobile-mode .tab-btn { font-size: 0.8rem !important; padding: 0.5rem 0.25rem !important; }
        body.mobile-mode table { font-size: 0.75rem !important; }
        body.mobile-mode input, body.mobile-mode select, body.mobile-mode button { font-size: 14px !important; }

        /* Mobile Accordion Styles */
        body.mobile-mode .mobile-accordion-header {
            cursor: pointer;
            background: linear-gradient(135deg, #334e68, #243b53);
            color: white;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(51, 78, 104, 0.2);
        }

        body.mobile-mode .mobile-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        body.mobile-mode .mobile-accordion-content.open {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        body.pc-mode { font-size: 14px; }
        body.pc-mode .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important; }
        body.pc-mode .chart-container { max-width: 600px !important; }

        /* Premium Cards */
        .premium-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(232, 230, 225, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .premium-card:hover {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        /* Gradient Backgrounds */
        .gradient-primary {
            background: linear-gradient(135deg, #c97458 0%, #db9179 100%);
        }

        .gradient-accent {
            background: linear-gradient(135deg, #334e68 0%, #486581 100%);
        }

        .gradient-surface {
            background: linear-gradient(135deg, #faf9f7 0%, #f5f3f0 100%);
        }

        /* KPI Card Accents */
        .kpi-accent-1 { border-left: 4px solid #c97458; }
        .kpi-accent-2 { border-left: 4px solid #334e68; }
        .kpi-accent-3 { border-left: 4px solid #627d98; }
        .kpi-accent-4 { border-left: 4px solid #e9b8a5; }
        .kpi-accent-5 { border-left: 4px solid #f59e0b; }

        /* Tab Styles */
        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #c97458, #db9179);
            transition: width 0.3s ease;
        }

        .tab-btn.active::after,
        .tab-btn:hover::after {
            width: 100%;
        }

        /* Premium Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #c97458 0%, #b85d42 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(201, 116, 88, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(201, 116, 88, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #334e68 0%, #243b53 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(51, 78, 104, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(51, 78, 104, 0.4);
        }

        /* Glass Effect */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* ===== Dark Mode Styles ===== */
        html.dark {
            color-scheme: dark;
        }

        .dark body {
            background: linear-gradient(135deg, #1a1c20 0%, #0f1114 100%) !important;
            color: #e8e6e1 !important;
        }

        /* Background Colors - New Palette */
        .dark .bg-surface-50,
        .dark .bg-white {
            background-color: #1e2024 !important;
        }

        .dark .bg-surface-100 {
            background-color: #262a2e !important;
        }

        .dark .bg-surface-200 {
            background-color: #2e3236 !important;
        }

        /* Text Colors - New Palette */
        .dark .text-accent-900,
        .dark .text-accent-800 {
            color: #f0ebe5 !important;
        }

        .dark .text-surface-500,
        .dark .text-surface-600 {
            color: #9fb3c8 !important;
        }

        .dark .text-primary-500 {
            color: #db9179 !important;
        }

        .dark .text-gray-500 {
            color: #9ca3af !important;
        }

        .dark .text-gray-600 {
            color: #bbb !important;
        }

        /* Border Colors - New Palette */
        .dark .border-surface-200,
        .dark .border-surface-300 {
            border-color: #3a3e42 !important;
        }

        /* Premium Cards in Dark Mode */
        .dark .premium-card {
            background: linear-gradient(135deg, #1e2024 0%, #262a2e 100%) !important;
            border-color: #3a3e42 !important;
        }

        .dark .premium-card:hover {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5), 0 2px 10px -2px rgba(201, 116, 88, 0.1);
        }

        /* KPI Cards in Dark Mode */
        .dark .kpi-card {
            background: linear-gradient(135deg, #1e2024 0%, #262a2e 100%) !important;
            border-color: #3a3e42 !important;
        }

        /* Cards & Shadows */
        .dark .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5) !important;
        }

        .dark .shadow-soft {
            box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.5), 0 10px 20px -2px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-soft-lg {
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6), 0 2px 10px -2px rgba(0, 0, 0, 0.4) !important;
        }

        /* Header */
        .dark header,
        .dark .header-premium {
            background: linear-gradient(135deg, rgba(30, 32, 36, 0.98) 0%, rgba(38, 42, 46, 0.98) 100%) !important;
            border-bottom-color: #3a3e42 !important;
        }

        /* Form Elements */
        .dark select,
        .dark input,
        .dark textarea {
            background-color: #262a2e !important;
            border-color: #3a3e42 !important;
            color: #e8e6e1 !important;
        }

        .dark select:focus,
        .dark input:focus,
        .dark textarea:focus {
            border-color: #c97458 !important;
            box-shadow: 0 0 0 3px rgba(201, 116, 88, 0.2) !important;
        }

        .dark select:disabled {
            background-color: #1a1c20 !important;
            color: #666 !important;
        }

        /* Tabs */
        .dark .tab-btn {
            color: #9fb3c8 !important;
        }

        .dark .tab-btn.active,
        .dark .tab-btn:hover {
            color: #f0ebe5 !important;
        }

        .dark .tab-btn::after {
            background: linear-gradient(90deg, #c97458, #db9179) !important;
        }

        /* Edit Table */
        .dark .edit-input {
            background-color: #262a2e !important;
            border-color: #3a3e42 !important;
            color: #e8e6e1 !important;
        }

        .dark .edit-readonly {
            background-color: #1a1c20 !important;
            color: #888 !important;
        }

        .dark .changed-row {
            background: linear-gradient(90deg, rgba(201, 116, 88, 0.15), rgba(201, 116, 88, 0.05)) !important;
        }

        /* Alert Colors */
        .dark .bg-blue-50 {
            background-color: #1e2a3a !important;
        }

        .dark .border-blue-400 {
            border-color: #3a5580 !important;
        }

        .dark .text-blue-800 {
            color: #7db3ff !important;
        }

        .dark .text-blue-600 {
            color: #8ac4ff !important;
        }

        .dark .bg-green-50 {
            background-color: #264232 !important;
        }

        .dark .border-green-400 {
            border-color: #3a8058 !important;
        }

        .dark .text-green-700 {
            color: #7de4b8 !important;
        }

        .dark .bg-yellow-50 {
            background-color: #423c26 !important;
        }

        .dark .border-yellow-400 {
            border-color: #80753a !important;
        }

        .dark .text-yellow-700 {
            color: #ffc85d !important;
        }

        .dark .bg-red-50 {
            background-color: #422630 !important;
        }

        .dark .border-red-400 {
            border-color: #803a50 !important;
        }

        .dark .text-red-700 {
            color: #ff9fb3 !important;
        }

        /* Chart.js Dark Mode Support */
        .dark .chart-container canvas {
            filter: brightness(0.95);
        }

        /* Mobile Accordion in Dark Mode */
        .dark body.mobile-mode .mobile-accordion-header {
            background: linear-gradient(135deg, #334e68, #243b53) !important;
        }

        /* Scrollbar in Dark Mode */
        .dark::-webkit-scrollbar-track,
        .dark .custom-scroll::-webkit-scrollbar-track {
            background: #1e2024 !important;
        }

        .dark::-webkit-scrollbar-thumb,
        .dark .custom-scroll::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #c97458, #994a35) !important;
        }

        /* Hover States */
        .dark .hover\:bg-surface-100:hover {
            background-color: #2e3236 !important;
        }

        /* KPI Cards in Dark Mode */
        .dark #kpi-incentive-card {
            background: linear-gradient(135deg, #334e68 0%, #243b53 100%) !important;
        }

        /* Staff Dashboard Cards in Dark Mode */
        .dark .border-2.border-primary-500 {
            border-color: #c97458 !important;
        }

        .dark .border-2.border-accent-700 {
            border-color: #486581 !important;
        }

        /* Transition for smooth dark mode toggle */
        body, header, .premium-card, .kpi-card, select, input, textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* Safe Area Support for iOS */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Touch Feedback */
        .touch-feedback:active {
            transform: scale(0.97);
            transition: transform 0.1s ease-in-out;
        }

        /* Accessibility: Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Period Buttons */
        .period-btn {
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .period-btn:hover {
            transform: translateY(-1px);
        }

        .period-btn.active {
            background: linear-gradient(135deg, #c97458 0%, #b85d42 100%) !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(201, 116, 88, 0.3);
        }

        .dark .period-btn {
            color: #9fb3c8 !important;
        }

        .dark .period-btn.active {
            background: linear-gradient(135deg, #c97458 0%, #b85d42 100%) !important;
            color: white !important;
        }

        .dark .period-btn:hover:not(.active) {
            background-color: #2e3236 !important;
        }

        /* Calendar Styles */
        #calendar-grid > div {
            transition: all 0.2s ease;
        }

        .dark #calendar-grid .bg-gray-50 {
            background-color: #2a2622 !important;
            border-color: #4a4540 !important;
        }

        .dark #calendar-grid .bg-blue-50 {
            background-color: #263548 !important;
            border-color: #3a5580 !important;
        }

        .dark #calendar-grid .bg-green-50 {
            background-color: #264232 !important;
            border-color: #3a8058 !important;
        }

        .dark #calendar-grid .bg-yellow-50 {
            background-color: #423c26 !important;
            border-color: #80753a !important;
        }

        .dark #calendar-grid .bg-orange-50 {
            background-color: #422f26 !important;
            border-color: #805a3a !important;
        }

        .dark #calendar-grid .bg-red-50 {
            background-color: #422630 !important;
            border-color: #803a50 !important;
        }

        /* KPI Card Hover Effect */
        #kpi-grid > div {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #kpi-grid > div:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark #kpi-grid > div:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Smooth Tab Transitions */
        .tab-content {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Hover Effects */
        .bg-white.rounded {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .bg-white.rounded:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .dark .bg-white.rounded:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Button Active State */
        button:active:not(:disabled) {
            transform: scale(0.98);
        }

        /* Focus Visible for Accessibility */
        button:focus-visible,
        select:focus-visible,
        input:focus-visible {
            outline: 2px solid #c97458;
            outline-offset: 2px;
        }

        .dark button:focus-visible,
        .dark select:focus-visible,
        .dark input:focus-visible {
            outline-color: #db9179;
        }

        /* KPI Card Styles */
        .kpi-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(232, 230, 225, 0.8);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15), 0 2px 10px -2px rgba(0, 0, 0, 0.08);
        }

        .kpi-card.accent-primary::before {
            background: linear-gradient(90deg, #c97458, #db9179);
        }

        .kpi-card.accent-navy::before {
            background: linear-gradient(90deg, #334e68, #486581);
        }

        .kpi-card.accent-gold::before {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .kpi-card.accent-success::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .kpi-card.accent-purple::before {
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        /* Header Styles */
        .header-premium {
            background: linear-gradient(135deg, rgba(250, 249, 247, 0.98) 0%, rgba(245, 243, 240, 0.98) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Logo Styles */
        .logo-text {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        .logo-subtitle {
            font-family: 'Inter', sans-serif;
            letter-spacing: 0.15em;
        }

        /* Premium Select */
        .select-premium {
            background: white;
            border: 1px solid #e8e6e1;
            border-radius: 10px;
            padding: 10px 36px 10px 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .select-premium:focus {
            border-color: #c97458;
            box-shadow: 0 0 0 3px rgba(201, 116, 88, 0.15);
        }

        .dark .select-premium {
            background: #262a2e !important;
            border-color: #3a3e42 !important;
        }

        /* Tab Container */
        .tab-container {
            border-bottom: 1px solid #e8e6e1;
        }

        .dark .tab-container {
            border-bottom-color: #3a3e42;
        }

        /* Responsive Header Improvements */
        @media (max-width: 640px) {
            .period-btn {
                padding: 6px 8px !important;
                font-size: 0.7rem !important;
            }
        }
    </style>
</head>
<body class="bg-surface-50 text-accent-900 font-sans antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-surface-50/90 dark:bg-accent-900/90 backdrop-blur-sm z-[100] flex items-center justify-center transition-opacity duration-300">
        <div class="text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 mb-4">
                <svg class="animate-spin w-12 h-12 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <p class="text-accent-700 dark:text-surface-300 font-medium" id="loading-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <p class="text-xs text-surface-500 mt-2" id="loading-subtext">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="min-h-screen flex flex-col">

        <!-- Header Section -->
        <header class="header-premium shadow-soft border-b border-surface-200 sticky top-0 z-50 safe-top">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center gap-4">

                <!-- Logo -->
                <div class="flex items-center gap-4">
                    <img src="assets/logo.png" alt="Mavie Logo" class="h-16 w-auto object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 gradient-primary text-white rounded-xl items-center justify-center text-2xl font-display tracking-widest hidden shadow-glow">M</div>
                    <div>
                        <h1 class="logo-text text-2xl text-accent-900 flex items-center gap-3">
                            Mavie
                            <span id="staff-mode-badge" class="hidden text-xs bg-primary-500 text-white px-3 py-1 rounded-full font-sans normal-case tracking-normal shadow-sm">å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰</span>
                        </h1>
                        <p class="logo-subtitle text-xs text-surface-500 font-medium uppercase">Eyelash Salon Dashboard</p>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Refresh Button -->
                    <button id="refresh-data-btn" onclick="refreshData()" class="bg-emerald-600 hover:bg-emerald-700 text-white py-2 px-4 rounded-lg flex items-center gap-2 transition font-medium shadow-sm" title="æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—">
                        <i data-lucide="refresh-cw" class="w-4 h-4" id="refresh-icon"></i>
                        <span class="hidden sm:inline text-sm">æ›´æ–°</span>
                    </button>

                    <!-- Dark Mode Toggle -->
                    <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="btn-secondary py-2 px-4 flex items-center gap-2" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">
                        <i data-lucide="moon" class="w-4 h-4" id="dark-mode-icon-lucide"></i>
                        <span id="dark-mode-label" class="hidden sm:inline text-sm">ãƒ€ãƒ¼ã‚¯</span>
                    </button>

                    <!-- Device Mode Toggle -->
                    <button id="device-toggle" onclick="toggleDeviceMode()" class="btn-primary py-2 px-4 flex items-center gap-2">
                        <i data-lucide="smartphone" class="w-4 h-4" id="device-icon-lucide"></i>
                        <span id="device-label" class="text-sm">ã‚¹ãƒãƒ›</span>
                    </button>

                    <!-- Store Selector -->
                    <div class="relative">
                        <select id="store-selector" onchange="handleStoreChange()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px]">
                            <option value="all">å…¨åº—èˆ—</option>
                            <option value="chiba">åƒè‘‰åº—</option>
                            <option value="honatsugi">æœ¬åšæœ¨åº—</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Staff Selector -->
                    <div class="relative">
                        <select id="staff-selector" onchange="updateDashboard()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px] disabled:opacity-50">
                            <option value="all">åº—èˆ—åˆè¨ˆ</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>

                    <!-- Period Quick Select -->
                    <div class="flex items-center gap-1 bg-surface-100 rounded-xl p-1.5 border border-surface-200">
                        <button onclick="setPeriodFilter('month')" id="period-month" class="period-btn px-3 py-1.5 text-xs font-medium active">ä»Šæœˆ</button>
                        <button onclick="setPeriodFilter('3months')" id="period-3months" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">3ãƒ¶æœˆ</button>
                        <button onclick="setPeriodFilter('6months')" id="period-6months" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">6ãƒ¶æœˆ</button>
                        <button onclick="setPeriodFilter('year')" id="period-year" class="period-btn px-3 py-1.5 text-xs font-medium text-surface-600 hover:bg-surface-200">1å¹´</button>
                    </div>

                    <!-- Date Selector (Year/Month) -->
                    <div class="relative">
                        <select id="date-selector" onchange="handleDateChange()" class="select-premium appearance-none text-accent-800 text-sm cursor-pointer min-w-[140px]">
                            <!-- JS Populated (2024-2030) -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-surface-500">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full safe-bottom">

            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-5 mb-10" id="kpi-grid">
                <!-- Sales -->
                <div class="kpi-card accent-primary p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg gradient-primary flex items-center justify-center">
                            <i data-lucide="trending-up" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-surface-500 uppercase tracking-wider">ç·å£²ä¸Š</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-accent-900" id="kpi-sales">Â¥0</h2>
                    <div class="mt-3 text-sm text-surface-600 flex items-center gap-1">
                        <i data-lucide="target" class="w-3 h-3"></i>
                        ç›®æ¨™æ¯”: <span id="kpi-goal-ratio" class="font-semibold text-primary-500">0%</span>
                    </div>
                </div>

                <!-- Customers -->
                <div class="kpi-card accent-navy p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg gradient-accent flex items-center justify-center">
                            <i data-lucide="users" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-surface-500 uppercase tracking-wider">ç·æ¥åº—æ•°</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-accent-900" id="kpi-customers">0<span class="text-lg font-sans font-normal ml-1 text-surface-500">å</span></h2>
                    <div class="mt-3 text-sm text-surface-600">
                        æ–°è¦: <span id="kpi-new" class="font-semibold text-primary-500">0</span>
                        <span class="mx-1 text-surface-400">/</span>
                        æ—¢å­˜: <span id="kpi-existing" class="font-semibold text-accent-600">0</span>
                    </div>
                </div>

                <!-- Unit Price -->
                <div class="kpi-card accent-success p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">
                            <i data-lucide="wallet" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-surface-500 uppercase tracking-wider">å¹³å‡å®¢å˜ä¾¡</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-accent-900" id="kpi-unit-price">Â¥0</h2>
                    <div class="mt-3 text-sm text-surface-600 flex items-center gap-1">
                        <i data-lucide="shopping-bag" class="w-3 h-3"></i>
                        ç‰©è²©è¾¼ã¿å¹³å‡
                    </div>
                </div>

                <!-- HPB Rate -->
                <div class="kpi-card accent-purple p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-violet-600 flex items-center justify-center">
                            <i data-lucide="calendar-check" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-surface-500 uppercase tracking-wider">HPBæ–°è¦æ¬¡å›äºˆç´„ç‡</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-accent-900" id="kpi-hpb-rate">0%</h2>
                    <p class="text-sm text-surface-600 mt-3">HPBäºˆç´„æ•°Ã·HPBæ–°è¦æ•°</p>
                </div>

                <!-- 5 Star Reviews -->
                <div class="kpi-card accent-gold p-6">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-amber-500 flex items-center justify-center">
                            <i data-lucide="star" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-surface-500 uppercase tracking-wider">â˜…5å£ã‚³ãƒŸç²å¾—æ•°</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-accent-900" id="kpi-reviews-5star">0</h2>
                    <p class="text-sm text-surface-600 mt-3">ç›®æ¨™é”æˆç‡: <span id="kpi-reviews-5star-rate" class="font-semibold text-amber-500">0%</span></p>
                </div>

                <!-- Incentive Card (Hidden by default, shown when staff selected) -->
                <div id="kpi-incentive-card" class="hidden kpi-card p-6 gradient-accent text-white">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-white/20 flex items-center justify-center">
                            <i data-lucide="gift" class="w-4 h-4 text-white"></i>
                        </div>
                        <p class="text-xs font-semibold text-white/80 uppercase tracking-wider">æ¨å®šã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–</p>
                    </div>
                    <h2 class="text-3xl font-display font-bold text-white" id="val-incentive">Â¥0</h2>
                    <p class="text-sm text-white/70 mt-3">â€»ä»Šæœˆã®æ¨å®šç²å¾—é¡</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-8 tab-container">
                <nav class="flex space-x-1 overflow-x-auto custom-scroll pb-px">
                    <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active py-3 px-4 font-medium text-sm text-accent-800 flex items-center gap-2">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                        ã‚µãƒãƒªãƒ¼
                    </button>
                    <!-- Staff Dashboard Tab (shown only when staff is selected) -->
                    <button onclick="switchTab('staff-dashboard')" id="tab-staff-dashboard" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 hidden flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </button>
                    <button onclick="switchTab('customers')" id="tab-customers" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-4 h-4"></i>
                        é¡§å®¢ãƒ»åª’ä½“åˆ†æ
                    </button>
                    <button onclick="switchTab('sales')" id="tab-sales" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="receipt" class="w-4 h-4"></i>
                        å£²ä¸Šè©³ç´°
                    </button>
                    <button onclick="switchTab('kpi')" id="tab-kpi" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="clipboard-list" class="w-4 h-4"></i>
                        KPIãƒ»æ—¥å ±
                    </button>
                    <!-- Calendar View Tab -->
                    <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                    </button>
                    <!-- Goal Setting Tab -->
                    <button onclick="switchTab('goal')" id="tab-goal" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="target" class="w-4 h-4"></i>
                        å£²ä¸Šç›®æ¨™è¨­å®š
                    </button>
                    <!-- Edit Tab -->
                    <button onclick="switchTab('edit')" id="tab-edit" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                        ãƒ‡ãƒ¼ã‚¿ç·¨é›†
                    </button>
                    <!-- Settings Tab -->
                    <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn py-3 px-4 font-medium text-sm text-surface-500 flex items-center gap-2">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        è¨­å®š
                    </button>
                </nav>
            </div>

            <!-- TAB: OVERVIEW -->
            <section id="content-overview" class="tab-content block space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6">å®¢å˜ä¾¡ãƒ»æ¥åº—å†…è¨³æ¨ç§»</h3>
                    <p class="text-xs text-mavie-500 mb-4">æ£’ã‚°ãƒ©ãƒ•: æ–°è¦/æ—¢å­˜ã®å†…è¨³ (å³è»¸) | æŠ˜ã‚Œç·š: å¹³å‡å®¢å˜ä¾¡ (å·¦è»¸)</p>
                    <div class="chart-container"><canvas id="overviewChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">æ–°è¦ vs æ—¢å­˜</h3>
                        <div class="flex items-center gap-6">
                            <div class="chart-container h-64 flex-1"><canvas id="customerRatioChart"></canvas></div>
                            <div class="flex-1 space-y-4">
                                <div class="bg-mavie-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-mavie-500">æ–°è¦</span><span class="font-bold" id="ratio-new-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-mavie-400 h-1.5" id="bar-new-rate" style="width:0%"></div></div>
                                </div>
                                <div class="bg-mavie-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-mavie-500">æ—¢å­˜</span><span class="font-bold" id="ratio-exist-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-mavie-800 h-1.5" id="bar-exist-rate" style="width:0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">æ–°è¦åª’ä½“ã‚·ã‚§ã‚¢</h3>
                        <div class="chart-container h-64"><canvas id="channelShareChart"></canvas></div>
                        <div class="mt-4 flex justify-center gap-4 text-xs text-mavie-500">
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-mavie-400"></span>HPB</div>
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-mavie-300"></span>minimo/Nailie</div>
                        </div>
                    </div>
                </div>

                <!-- AI Advice Section -->
                <div id="ai-advice-section" class="bg-gradient-to-br from-mavie-50 to-white rounded-lg shadow-sm border border-mavie-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-mavie-700 to-mavie-800 text-white px-6 py-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-bold flex items-center gap-2">
                                <span>ğŸ’¡</span> AIæ¥­å‹™æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
                            </h3>
                            <p class="text-xs text-mavie-100 mt-1">ç›®æ¨™é”æˆã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—</p>
                        </div>
                        <button onclick="getAIAdvice()" id="btn-ai-advice" class="bg-white text-mavie-800 px-4 py-2 rounded hover:bg-mavie-50 transition font-bold text-sm">
                            ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—
                        </button>
                    </div>
                    <div class="p-6" id="ai-advice-content">
                        <div class="text-center text-mavie-500 py-8">
                            <p class="text-sm">ã€Œã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€AIãŒç›®æ¨™é”æˆã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚</p>
                            <p class="text-xs mt-2">â€»äº‹å‰ã«è¨­å®šã‚¿ãƒ–ã§Gemini APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: STAFF DASHBOARD -->
            <section id="content-staff-dashboard" class="tab-content hidden space-y-8 animate-fade-in">
                <!-- Header with Staff Name -->
                <div class="bg-gradient-to-r from-mavie-800 to-mavie-900 text-white p-6 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-4xl">ğŸ‘¤</span>
                            <div>
                                <h2 class="text-2xl font-serif font-bold" id="staff-dashboard-name">ã‚¹ã‚¿ãƒƒãƒ•å</h2>
                                <p class="text-xs text-mavie-200 mt-1">å€‹äººã¨åº—èˆ—å…¨ä½“ã®æ¯”è¼ƒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
                            </div>
                        </div>
                        <button onclick="generateStaffURL()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition">
                            <span>ğŸ”—</span> å°‚ç”¨URLã‚’ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>
                </div>

                <!-- Comparison Grid: Personal vs Store -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Personal Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-mavie-400 overflow-hidden">
                        <div class="bg-mavie-400 text-white px-6 py-4">
                            <h3 class="text-lg font-serif font-bold flex items-center gap-2">
                                <span>ğŸ‘¤</span> ã‚ãªãŸã®å®Ÿç¸¾
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Sales -->
                            <div class="bg-mavie-50 p-4 rounded">
                                <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">ç·å£²ä¸Š</p>
                                <h3 class="text-3xl font-serif font-bold text-mavie-800" id="staff-personal-sales">Â¥0</h3>
                                <div class="mt-2 text-xs text-mavie-600">
                                    ç›®æ¨™: <span id="staff-personal-goal" class="font-bold">Â¥1,100,000</span>
                                    <span class="ml-2">é”æˆç‡: <span id="staff-personal-goal-rate" class="font-bold text-mavie-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-mavie-600">ç·æ¥åº—æ•°</span>
                                    <span class="text-xl font-bold text-mavie-800" id="staff-personal-customers">0å</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ–°è¦</span>
                                    <div>
                                        <span id="staff-personal-new" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-new-goal" class="font-bold text-mavie-600">30</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ—¢å­˜</span>
                                    <div>
                                        <span id="staff-personal-existing" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-existing-goal" class="font-bold text-mavie-600">90</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">å®¢å˜ä¾¡</span>
                                    <div>
                                        <span id="staff-personal-unit-price" class="font-bold text-mavie-800">Â¥0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-unit-price-goal" class="font-bold text-mavie-600">Â¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ–°è¦æ¬¡å›äºˆç´„ç‡</span>
                                    <div>
                                        <span id="staff-personal-new-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-new-res-rate-goal" class="font-bold text-mavie-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ¬¡å›äºˆç´„ç‡</span>
                                    <div>
                                        <span id="staff-personal-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-res-rate-goal" class="font-bold text-mavie-600">70%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">â˜…5å£ã‚³ãƒŸç²å¾—æ•°</span>
                                    <div>
                                        <span id="staff-personal-reviews" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-personal-reviews-goal" class="font-bold text-mavie-600">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Store Total Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-mavie-800 overflow-hidden">
                        <div class="bg-mavie-800 text-white px-6 py-4">
                            <h3 class="text-lg font-serif font-bold flex items-center gap-2">
                                <span>ğŸ¢</span> åº—èˆ—å…¨ä½“ã®å®Ÿç¸¾
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Sales -->
                            <div class="bg-mavie-50 p-4 rounded">
                                <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">ç·å£²ä¸Š</p>
                                <h3 class="text-3xl font-serif font-bold text-mavie-800" id="staff-store-sales">Â¥0</h3>
                                <div class="mt-2 text-xs text-mavie-600">
                                    ç›®æ¨™: <span id="staff-store-goal" class="font-bold">Â¥3,000,000</span>
                                    <span class="ml-2">é”æˆç‡: <span id="staff-store-goal-rate" class="font-bold text-mavie-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-mavie-600">ç·æ¥åº—æ•°</span>
                                    <span class="text-xl font-bold text-mavie-800" id="staff-store-customers">0å</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ–°è¦</span>
                                    <div>
                                        <span id="staff-store-new" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-new-goal" class="font-bold text-mavie-600">100</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ—¢å­˜</span>
                                    <div>
                                        <span id="staff-store-existing" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-existing-goal" class="font-bold text-mavie-600">300</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">å®¢å˜ä¾¡</span>
                                    <div>
                                        <span id="staff-store-unit-price" class="font-bold text-mavie-800">Â¥0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-unit-price-goal" class="font-bold text-mavie-600">Â¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ–°è¦æ¬¡å›äºˆç´„ç‡</span>
                                    <div>
                                        <span id="staff-store-new-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-new-res-rate-goal" class="font-bold text-mavie-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">æ¬¡å›äºˆç´„ç‡</span>
                                    <div>
                                        <span id="staff-store-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-res-rate-goal" class="font-bold text-mavie-600">70%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">â˜…5å£ã‚³ãƒŸç²å¾—æ•°</span>
                                    <div>
                                        <span id="staff-store-reviews" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / ç›®æ¨™: </span>
                                        <span id="staff-store-reviews-goal" class="font-bold text-mavie-600">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Incentive Details -->
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6 flex items-center gap-2">
                        <span>ğŸ’°</span> ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–è©³ç´°
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-mavie-800 to-mavie-900 text-white p-4 rounded-lg">
                            <p class="text-xs font-bold text-mavie-200 uppercase mb-1">ä»Šæœˆã®æ¨å®šã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–</p>
                            <div class="text-3xl font-serif font-bold" id="staff-incentive-total">Â¥0</div>
                        </div>

                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">åŸºæœ¬çµ¦</span>
                                <span class="font-bold text-mavie-800" id="staff-incentive-base">Â¥0</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">æ–½è¡“å£²ä¸Š (5%)</span>
                                <div class="text-right">
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-service-sales">æ–½è¡“å£²ä¸Š: Â¥0</div>
                                    <span class="font-bold text-mavie-800" id="staff-incentive-service">Â¥0</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">ç‰©è²©ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–</span>
                                <div class="text-right">
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-retail-sales">ç‰©è²©å£²ä¸Š: Â¥0</div>
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-retail-rate">(5%é©ç”¨)</div>
                                    <span class="font-bold text-mavie-800" id="staff-incentive-retail">Â¥0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-400">
                            <p class="text-xs font-bold text-blue-800 mb-1">ğŸ“Š è¨ˆç®—å¼</p>
                            <p class="text-xs text-blue-600">
                                åŸºæœ¬çµ¦ + æ–½è¡“å£²ä¸ŠÃ—5% + ç‰©è²©ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–<br>
                                <span class="text-blue-500">â€»ç‰©è²©ãŒ10ä¸‡å††ä»¥ä¸Šã®å ´åˆã€ç‰©è²©ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã¯10%ã§è¨ˆç®—</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Achievement Progress Bars -->
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6">ç›®æ¨™é”æˆã®é€²æ—</h3>
                    <div class="space-y-6">
                        <!-- Sales Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">å£²ä¸Šç›®æ¨™</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-sales-percent">0%</span> é”æˆ</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-400 to-mavie-800 h-4 transition-all duration-500" id="staff-progress-sales-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- New Customers Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">æ–°è¦æ•°ç›®æ¨™</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-new-percent">0%</span> é”æˆ</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-300 to-mavie-600 h-4 transition-all duration-500" id="staff-progress-new-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- Existing Customers Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">æ—¢å­˜æ•°ç›®æ¨™</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-existing-percent">0%</span> é”æˆ</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-300 to-mavie-600 h-4 transition-all duration-500" id="staff-progress-existing-bar" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-mavie-50 p-4 rounded border-l-4 border-mavie-400">
                        <p class="text-xs font-bold text-mavie-800 mb-1">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</p>
                        <p class="text-xs text-mavie-600">ã“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã¯ã€ã‚ãªãŸã®å€‹äººå®Ÿç¸¾ã¨åº—èˆ—å…¨ä½“ã®å®Ÿç¸¾ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚ç›®æ¨™ã¯ã€Œå£²ä¸Šç›®æ¨™è¨­å®šã€ã‚¿ãƒ–ã§è¨­å®šã§ãã¾ã™ã€‚</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-400">
                        <p class="text-xs font-bold text-blue-800 mb-1">ğŸ”— å°‚ç”¨URL</p>
                        <p class="text-xs text-blue-600">ä¸Šéƒ¨ã®ã€Œå°‚ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã€ãƒœã‚¿ãƒ³ã§ã€ã“ã®ã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ã®URLã‚’å–å¾—ã§ãã¾ã™ã€‚ãã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»–ã®ã‚¹ã‚¿ãƒƒãƒ•ã®è©³ç´°ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</p>
                    </div>
                </div>
            </section>

            <!-- TAB: CUSTOMERS -->
            <section id="content-customers" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">åª’ä½“åˆ¥ æ–°è¦é›†å®¢æ¨ç§»</h3>
                    <div class="chart-container"><canvas id="channelTrendChart"></canvas></div>
                </div>
            </section>

            <!-- TAB: SALES -->
            <section id="content-sales" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">æ±ºæ¸ˆæ–¹æ³•</h3>
                        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">å‰²å¼•ãƒ»æå¤±åˆ†æ</h3>
                        <div class="chart-container"><canvas id="lossChart"></canvas></div>
                        <p class="mt-4 text-right text-sm text-mavie-500">æå¤±åˆè¨ˆ: <span class="font-bold text-mavie-800 text-lg" id="val-total-loss">Â¥0</span></p>
                    </div>
                </div>
            </section>

            <!-- TAB: CALENDAR VIEW -->
            <section id="content-calendar" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <!-- Calendar Header -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-serif font-bold text-mavie-800">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼</h2>
                            <p class="text-sm text-mavie-500 mt-1">æ—¥åˆ¥ã®å£²ä¸Šã‚’ä¸€ç›®ã§ç¢ºèª</p>
                        </div>
                        <div class="flex items-center gap-2 bg-mavie-50 px-4 py-2 rounded-lg border border-mavie-200">
                            <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-mavie-100 rounded transition-colors" title="å‰æœˆ">
                                <span>â—€</span>
                            </button>
                            <span id="calendar-month-display" class="text-lg font-bold text-mavie-800 min-w-[120px] text-center">2025å¹´1æœˆ</span>
                            <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-mavie-100 rounded transition-colors" title="æ¬¡æœˆ">
                                <span>â–¶</span>
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="overflow-x-auto">
                        <!-- Day Headers -->
                        <div class="grid grid-cols-7 gap-1 mb-2 min-w-[600px]">
                            <div class="text-center font-bold text-sm py-2 text-red-500">æ—¥</div>
                            <div class="text-center font-bold text-sm py-2 text-mavie-800">æœˆ</div>
                            <div class="text-center font-bold text-sm py-2 text-mavie-800">ç«</div>
                            <div class="text-center font-bold text-sm py-2 text-mavie-800">æ°´</div>
                            <div class="text-center font-bold text-sm py-2 text-mavie-800">æœ¨</div>
                            <div class="text-center font-bold text-sm py-2 text-mavie-800">é‡‘</div>
                            <div class="text-center font-bold text-sm py-2 text-blue-500">åœŸ</div>
                        </div>
                        <!-- Calendar Days -->
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 min-w-[600px]">
                            <!-- Generated by JavaScript -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-6 pt-6 border-t border-mavie-200">
                        <p class="text-xs text-mavie-600 mb-2 font-semibold">å£²ä¸Šãƒ¬ãƒ™ãƒ«</p>
                        <div class="flex flex-wrap gap-3 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-gray-100 border border-gray-200"></div>
                                <span class="text-mavie-600">ä¼‘æ¥­/ãƒ‡ãƒ¼ã‚¿ãªã—</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-blue-50 border border-blue-200"></div>
                                <span class="text-mavie-600">~Â¥50,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-green-50 border border-green-200"></div>
                                <span class="text-mavie-600">Â¥50,000~Â¥100,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-yellow-50 border border-yellow-200"></div>
                                <span class="text-mavie-600">Â¥100,000~Â¥150,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-orange-50 border border-orange-200"></div>
                                <span class="text-mavie-600">Â¥150,000~Â¥200,000</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 rounded bg-red-50 border border-red-200"></div>
                                <span class="text-mavie-600">Â¥200,000~</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Day Details -->
                <div id="calendar-day-details" class="hidden bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4" id="calendar-day-title">0æœˆ0æ—¥ã®è©³ç´°</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4" id="calendar-day-stats">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Monthly Summary -->
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">æœˆé–“ã‚µãƒãƒªãƒ¼</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-mavie-50 rounded-lg p-4 border border-mavie-200">
                            <p class="text-xs text-mavie-500 mb-1">å–¶æ¥­æ—¥æ•°</p>
                            <p class="text-2xl font-bold text-mavie-800" id="calendar-summary-days">0<span class="text-sm font-normal ml-1">æ—¥</span></p>
                        </div>
                        <div class="bg-mavie-50 rounded-lg p-4 border border-mavie-200">
                            <p class="text-xs text-mavie-500 mb-1">æœˆé–“ç·å£²ä¸Š</p>
                            <p class="text-2xl font-bold text-mavie-800" id="calendar-summary-sales">Â¥0</p>
                        </div>
                        <div class="bg-mavie-50 rounded-lg p-4 border border-mavie-200">
                            <p class="text-xs text-mavie-500 mb-1">æ—¥å¹³å‡å£²ä¸Š</p>
                            <p class="text-2xl font-bold text-mavie-800" id="calendar-summary-avg">Â¥0</p>
                        </div>
                        <div class="bg-mavie-50 rounded-lg p-4 border border-mavie-200">
                            <p class="text-xs text-mavie-500 mb-1">æœ€é«˜å£²ä¸Šæ—¥</p>
                            <p class="text-2xl font-bold text-mavie-400" id="calendar-summary-max">Â¥0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: KPI -->
            <section id="content-kpi" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-400"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">æ–°è¦æ¬¡å›äºˆç´„ç‡(HPB)</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-400" id="kpi-rate-hpb-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-800"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">æ—¢å­˜æ¬¡å›äºˆç´„ç‡</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-800" id="kpi-rate-exist-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-300"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">ç·æ¬¡å›äºˆç´„ç‡</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-300" id="kpi-rate-total-lg">0%</div>
                    </div>
                </div>
                <div class="bg-white rounded shadow-sm border border-mavie-200 overflow-hidden mt-8">
                    <div class="px-6 py-4 bg-mavie-50 border-b border-mavie-200">
                        <h3 class="text-sm font-bold text-mavie-800 uppercase">Daily Report (ç›´è¿‘ãƒ‡ãƒ¼ã‚¿)</h3>
                    </div>
                    <div class="overflow-x-auto custom-scroll">
                        <table class="min-w-full divide-y divide-mavie-200">
                            <thead class="bg-mavie-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">åº—èˆ—</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">ã‚¹ã‚¿ãƒƒãƒ•</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">æ—¥ä»˜</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">å£²ä¸Š</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">æ¥åº—æ•°</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">HPBäºˆç´„ç‡</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-mavie-100" id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: GOAL SETTING -->
            <section id="content-goal" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-mavie-50 to-white rounded-lg shadow-lg border border-mavie-200 overflow-hidden">
                    <div class="bg-mavie-800 text-white px-6 py-4">
                        <h3 class="text-xl font-serif font-bold flex items-center gap-2">
                            <span class="text-2xl">ğŸ¯</span> å£²ä¸Šç›®æ¨™è¨ˆç®—ãƒ„ãƒ¼ãƒ«
                        </h3>
                        <p class="text-xs text-mavie-200 mt-1">å¹³æ—¥ã¨ä¼‘æ—¥ã®å‡ºå‹¤æ—¥æ•°ã‚’å…¥åŠ›ã—ã¦ã€æœˆé–“ç›®æ¨™ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã™</p>
                        <div class="mt-3 pt-3 border-t border-mavie-700">
                            <p class="text-xs font-bold text-mavie-200 mb-2">è¨­å®šå¯¾è±¡:</p>
                            <div class="flex items-center gap-3">
                                <!-- Store Selector for Goal Setting -->
                                <div class="relative">
                                    <select id="goal-store-selector" onchange="handleGoalStoreChange()" class="appearance-none bg-mavie-900 border border-mavie-700 text-white py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 font-medium text-sm cursor-pointer min-w-[140px]">
                                        <option value="all">å…¨åº—èˆ—</option>
                                        <option value="chiba">åƒè‘‰åº—</option>
                                        <option value="honatsugi">æœ¬åšæœ¨åº—</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">â–¼</div>
                                </div>

                                <!-- Staff Selector for Goal Setting -->
                                <div class="relative">
                                    <select id="goal-staff-selector" onchange="loadGoalInputs()" class="appearance-none bg-mavie-900 border border-mavie-700 text-white py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 font-medium text-sm cursor-pointer min-w-[140px]">
                                        <option value="all">åº—èˆ—åˆè¨ˆ</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">â–¼</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 md:p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Input Form - Column 1: Days & Sales -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">å‡ºå‹¤æ—¥æ•°ãƒ»å£²ä¸Š</h4>

                                <!-- Weekday Days -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">å¹³æ—¥å‡ºå‹¤æ—¥æ•°</label>
                                    <input type="number" id="goal-weekdays" value="20" min="0" max="31"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®å¹³æ—¥å‡ºå‹¤æ—¥æ•°</p>
                                </div>

                                <!-- Weekend Days -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°</label>
                                    <input type="number" id="goal-weekends" value="6" min="0" max="31"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°</p>
                                </div>

                                <!-- Weekday Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">å¹³æ—¥ã®1æ—¥ã‚ãŸã‚Šç›®æ¨™å£²ä¸Š (å††)</label>
                                    <input type="number" id="goal-weekday-target" value="40000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">å¹³æ—¥ã®ç›®æ¨™å£²ä¸Šé¡</p>
                                </div>

                                <!-- Weekend Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">ä¼‘æ—¥ã®1æ—¥ã‚ãŸã‚Šç›®æ¨™å£²ä¸Š (å††)</label>
                                    <input type="number" id="goal-weekend-target" value="50000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">ä¼‘æ—¥ã®ç›®æ¨™å£²ä¸Šé¡</p>
                                </div>

                                <!-- Retail Sales Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">æœˆé–“ç‰©è²©ç›®æ¨™ (å††)</label>
                                    <input type="number" id="goal-retail" value="50000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®ç‰©è²©å£²ä¸Šç›®æ¨™</p>
                                </div>
                            </div>

                            <!-- Input Form - Column 2: Customer Targets -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">åŸºæœ¬çµ¦ãƒ»æ¥åº—ç›®æ¨™</h4>

                                <!-- Base Salary -->
                                <div class="bg-gradient-to-br from-green-50 to-white p-4 rounded border-2 border-green-300">
                                    <label class="block text-sm font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <span>ğŸ’°</span> åŸºæœ¬çµ¦ (å††)
                                    </label>
                                    <input type="number" id="goal-base-salary" value="200000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-400 text-lg font-medium"
                                           onchange="saveBaseSalaryAndCalculate()">
                                    <p class="text-xs text-green-600 mt-1">ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–è¨ˆç®—ã«ä½¿ç”¨</p>
                                </div>

                                <!-- New Customers Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">æœˆé–“æ–°è¦æ•°ç›®æ¨™ (å)</label>
                                    <input type="number" id="goal-new-customers" value="30" min="0"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®æ–°è¦é¡§å®¢ç›®æ¨™æ•°</p>
                                </div>

                                <!-- Existing Customers Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">æœˆé–“æ—¢å­˜æ•°ç›®æ¨™ (å)</label>
                                    <input type="number" id="goal-existing-customers" value="90" min="0"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®æ—¢å­˜é¡§å®¢ç›®æ¨™æ•°</p>
                                </div>

                                <!-- Unit Price Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">ç›®æ¨™å®¢å˜ä¾¡ (å††)</label>
                                    <input type="number" id="goal-unit-price" value="9000" min="0" step="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">ç›®æ¨™ã¨ã™ã‚‹å¹³å‡å®¢å˜ä¾¡</p>
                                </div>

                                <!-- New Customer Next Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">ç›®æ¨™æ–°è¦æ¬¡å›äºˆç´„ç‡ (%)</label>
                                    <input type="number" id="goal-new-reservation-rate" value="50" min="0" max="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æ–°è¦é¡§å®¢ã®æ¬¡å›äºˆç´„ç‡ç›®æ¨™</p>
                                </div>

                                <!-- Overall Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">ç›®æ¨™æ¬¡å›äºˆç´„ç‡ (%)</label>
                                    <input type="number" id="goal-reservation-rate" value="70" min="0" max="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">å…¨ä½“ã®æ¬¡å›äºˆç´„ç‡ç›®æ¨™</p>
                                </div>

                                <!-- 5 Star Reviews Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">â˜…5å£ã‚³ãƒŸç²å¾—ç›®æ¨™ (ä»¶)</label>
                                    <input type="number" id="goal-reviews-5star" value="0" min="0"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">æœˆé–“ã®â˜…5å£ã‚³ãƒŸç²å¾—ç›®æ¨™</p>
                                </div>

                                <button onclick="calculateGoal()" class="w-full bg-mavie-800 text-white py-3 rounded shadow hover:bg-mavie-900 transition font-bold text-base">
                                    è¨ˆç®—ã™ã‚‹
                                </button>

                                <button onclick="saveGoalsToSpreadsheet()" id="btn-save-goals" class="w-full bg-green-600 text-white py-3 rounded shadow hover:bg-green-700 transition font-bold text-base flex items-center justify-center gap-2">
                                    <span>â˜</span> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
                                </button>
                            </div>

                            <!-- Results Display -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">è¨ˆç®—çµæœ</h4>

                                <div class="bg-gradient-to-br from-mavie-800 to-mavie-900 text-white p-6 rounded-lg shadow-lg">
                                    <p class="text-xs font-bold text-mavie-200 uppercase tracking-wider mb-2">æœˆé–“å£²ä¸Šç›®æ¨™</p>
                                    <div class="text-4xl font-serif font-bold" id="goal-total">Â¥1,100,000</div>
                                    <div class="mt-4 pt-4 border-t border-mavie-700 space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">å¹³æ—¥å£²ä¸Š:</span>
                                            <span class="font-bold" id="goal-weekday-total">Â¥800,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">ä¼‘æ—¥å£²ä¸Š:</span>
                                            <span class="font-bold" id="goal-weekend-total">Â¥300,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">ç‰©è²©ç›®æ¨™:</span>
                                            <span class="font-bold" id="goal-retail-display">Â¥50,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-mavie-200">
                                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-4">å£²ä¸Šé”æˆçŠ¶æ³</p>
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-mavie-600">ç¾åœ¨ã®å£²ä¸Š</span>
                                                <span class="font-bold text-mavie-800" id="goal-current-sales">Â¥0</span>
                                            </div>
                                            <div class="w-full bg-mavie-100 h-3 rounded-full overflow-hidden">
                                                <div class="bg-mavie-400 h-3 transition-all duration-500" id="goal-progress-bar" style="width:0%"></div>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-mavie-500">é”æˆç‡</span>
                                            <span class="text-2xl font-serif font-bold text-mavie-800" id="goal-percentage">0%</span>
                                        </div>
                                        <div class="flex justify-between items-center pt-4 border-t border-mavie-200">
                                            <span class="text-xs text-mavie-500">ç›®æ¨™ã¾ã§æ®‹ã‚Š</span>
                                            <span class="text-lg font-bold text-mavie-600" id="goal-remaining">Â¥1,100,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-mavie-200">
                                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-4">æ¥åº—æ•°ãƒ»å®¢å˜ä¾¡ãƒ»äºˆç´„ç‡</p>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">æ–°è¦æ•°</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-new-current">0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-new-target">30å</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">æ—¢å­˜æ•°</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-existing-current">0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-existing-target">90å</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">å®¢å˜ä¾¡</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-unit-price-current">Â¥0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-unit-price-target">Â¥9,000</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">æ–°è¦æ¬¡å›äºˆç´„ç‡</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-new-res-rate-current">0%</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-new-res-rate-target">50%</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-mavie-600">æ¬¡å›äºˆç´„ç‡</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-res-rate-current">0%</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-res-rate-target">70%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-mavie-50 p-4 rounded border-l-4 border-mavie-400">
                                    <p class="text-xs font-bold text-mavie-800 mb-1">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</p>
                                    <p class="text-xs text-mavie-600" id="goal-hint-text">å„é …ç›®ã®ç›®æ¨™ã‚’è¨­å®šã—ã¦ã€é”æˆçŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™ã€‚ç¾åœ¨ã®æ•°å€¤ã¯é¸æŠä¸­ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒ»åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
                                </div>

                                <div class="bg-green-50 p-4 rounded border-l-4 border-green-500" id="goal-save-notice" style="display:none;">
                                    <p class="text-xs font-bold text-green-800 mb-1">âœ“ ä¿å­˜å®Œäº†</p>
                                    <p class="text-xs text-green-600">ç›®æ¨™ãŒè‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚ã‚¹ã‚¿ãƒƒãƒ•ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: EDIT -->
            <section id="content-edit" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-mavie-100 p-4 rounded border-l-4 border-mavie-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <p class="text-sm text-mavie-800 font-bold">ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ãƒ¢ãƒ¼ãƒ‰</p>
                        <p class="text-xs text-mavie-600">ä¿®æ­£ã—ã¦ã€Œä¿å­˜ã€ã‚’æŠ¼ã™ã¨ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæœ¬ä½“ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="applyEditsLocally()" class="bg-white border border-mavie-300 text-mavie-600 px-4 py-2 rounded hover:bg-mavie-50 transition text-sm font-bold">
                            è¡¨ç¤ºã®ã¿æ›´æ–° (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)
                        </button>
                        <button onclick="saveToSpreadsheet()" id="btn-save-sheet" class="bg-mavie-800 text-white px-6 py-2 rounded shadow hover:bg-mavie-900 transition text-sm font-bold flex items-center gap-2">
                            <span>â˜</span> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded shadow-sm border border-mavie-200 overflow-hidden">
                    <div class="overflow-x-auto custom-scroll" style="max-height: 70vh;">
                        <table class="min-w-full divide-y divide-mavie-200" id="edit-table">
                            <thead class="bg-mavie-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">æ—¥ä»˜</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">åº—èˆ—</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">ã‚¹ã‚¿ãƒƒãƒ•</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">å£²ä¸Š(ç¾é‡‘)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">å£²ä¸Š(ã‚¯ãƒ¬ã‚«)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">å£²ä¸Š(QR)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">HPBæ–°è¦</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">Mini/Nailieæ–°è¦</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">ç´¹ä»‹æ–°è¦</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">çŸ¥ã‚Šåˆã„æ–°è¦</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">æ—¢å­˜å®¢</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">æ¬¡å›äºˆç´„(HPB)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">æ¬¡å›äºˆç´„(Mini/Nailie)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">æ¬¡å›äºˆç´„(æ—¢å­˜)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">â˜…5å£ã‚³ãƒŸ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-mavie-100" id="edit-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: SETTINGS -->
            <section id="content-settings" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-mavie-50 to-white rounded-lg shadow-lg border border-mavie-200 overflow-hidden">
                    <div class="bg-mavie-800 text-white px-6 py-4">
                        <h3 class="text-xl font-serif font-bold flex items-center gap-2">
                            <span class="text-2xl">âš™</span> ã‚¹ã‚¿ãƒƒãƒ•ãƒ»åº—èˆ—ç®¡ç†
                        </h3>
                        <p class="text-xs text-mavie-200 mt-1">ã‚¹ã‚¿ãƒƒãƒ•ã¨åº—èˆ—ã®è¿½åŠ ãƒ»å‰Šé™¤ã‚’è¡Œã„ã¾ã™</p>
                    </div>

                    <div class="p-6 md:p-8 space-y-8">
                        <!-- Spreadsheet API Settings -->
                        <div class="bg-white p-6 rounded-lg border border-mavie-200" id="spreadsheet-api-settings">
                            <h4 class="text-lg font-bold text-mavie-800 mb-4 flex items-center gap-2">
                                <i data-lucide="table" class="w-5 h-5 text-primary-500"></i>
                                ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-mavie-600 mb-2">Google Apps Script Web App URL</label>
                                    <input type="text" id="spreadsheet-api-url" placeholder="https://script.google.com/macros/s/..." class="w-full px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                    <p class="text-xs text-mavie-500 mt-1">â€»ãƒšãƒ¼ã‚¸ã‚’é–‹ããŸã³ã«è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="saveSpreadsheetApiUrl()" class="bg-mavie-700 text-white px-6 py-2 rounded hover:bg-mavie-800 transition font-bold flex items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i>
                                        ä¿å­˜
                                    </button>
                                    <button onclick="testSpreadsheetConnection()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold flex items-center gap-2">
                                        <i data-lucide="wifi" class="w-4 h-4"></i>
                                        æ¥ç¶šãƒ†ã‚¹ãƒˆ
                                    </button>
                                </div>
                                <div id="spreadsheet-connection-status" class="hidden"></div>
                                <div class="bg-mavie-50 p-4 rounded border-l-4 border-primary-500">
                                    <p class="text-xs font-bold text-mavie-800 mb-2">ğŸ“‹ è¨­å®šæ‰‹é †</p>
                                    <ol class="text-xs text-mavie-600 space-y-1 list-decimal list-inside">
                                        <li>Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã™</li>
                                        <li>ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é¸æŠ</li>
                                        <li>ãƒ‡ãƒ¼ã‚¿å–å¾—ç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã€Web Appã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤</li>
                                        <li>ç”Ÿæˆã•ã‚ŒãŸURLã‚’ã“ã¡ã‚‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- API Key Settings -->
                        <div class="bg-white p-6 rounded-lg border border-mavie-200" id="gemini-api-settings">
                            <h4 class="text-lg font-bold text-mavie-800 mb-4 flex items-center gap-2">
                                <span>ğŸ’¡</span> Gemini APIè¨­å®š
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-mavie-600 mb-2">Gemini APIã‚­ãƒ¼</label>
                                    <input type="password" id="gemini-api-key" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                    <p class="text-xs text-mavie-500 mt-1">â€»ç›®æ¨™é”æˆã‚¢ãƒ‰ãƒã‚¤ã‚¹æ©Ÿèƒ½ã§ä½¿ç”¨ã—ã¾ã™</p>
                                </div>
                                <button onclick="saveGeminiApiKey()" class="bg-mavie-700 text-white px-6 py-2 rounded hover:bg-mavie-800 transition font-bold">ä¿å­˜</button>
                                <div class="bg-mavie-50 p-3 rounded border-l-4 border-mavie-400">
                                    <p class="text-xs font-bold text-mavie-800 mb-1">ğŸ’¡ Gemini APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•</p>
                                    <p class="text-xs text-mavie-600">Google AI Studioã‹ã‚‰ç„¡æ–™ã§APIã‚­ãƒ¼ã‚’å–å¾—ã§ãã¾ã™: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline">https://aistudio.google.com/app/apikey</a></p>
                                </div>
                            </div>
                        </div>

                        <!-- Store Management -->
                        <div class="bg-white p-6 rounded-lg border border-mavie-200">
                            <h4 class="text-lg font-bold text-mavie-800 mb-4 flex items-center gap-2">
                                <span>ğŸ¢</span> åº—èˆ—ç®¡ç†
                            </h4>
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <input type="text" id="new-store-id" placeholder="åº—èˆ—ID (ä¾‹: chiba)" class="flex-1 px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                    <input type="text" id="new-store-name" placeholder="åº—èˆ—å (ä¾‹: åƒè‘‰åº—)" class="flex-1 px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                    <button onclick="addStore()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold">è¿½åŠ </button>
                                </div>
                                <div class="mt-4">
                                    <h5 class="text-sm font-bold text-mavie-600 mb-2">ç¾åœ¨ã®åº—èˆ—:</h5>
                                    <div id="store-list" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Staff Management -->
                        <div class="bg-white p-6 rounded-lg border border-mavie-200">
                            <h4 class="text-lg font-bold text-mavie-800 mb-4 flex items-center gap-2">
                                <span>ğŸ‘¥</span> ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
                            </h4>
                            <div class="space-y-4">
                                <div class="flex gap-2">
                                    <select id="staff-store-selector" class="px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                        <option value="">åº—èˆ—ã‚’é¸æŠ</option>
                                    </select>
                                    <input type="text" id="new-staff-name" placeholder="ã‚¹ã‚¿ãƒƒãƒ•å (ä¾‹: kiki)" class="flex-1 px-4 py-2 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400">
                                    <button onclick="addStaff()" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition font-bold">è¿½åŠ </button>
                                </div>
                                <div class="mt-4">
                                    <h5 class="text-sm font-bold text-mavie-600 mb-2">ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒãƒ•:</h5>
                                    <div id="staff-list" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-400">
                            <p class="text-xs font-bold text-yellow-800 mb-1">âš ï¸ æ³¨æ„</p>
                            <p class="text-xs text-yellow-700">ã‚¹ã‚¿ãƒƒãƒ•ã‚„åº—èˆ—ã‚’å‰Šé™¤ã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚å‰Šé™¤ã¯æ…é‡ã«è¡Œã£ã¦ãã ã•ã„ã€‚</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="bg-mavie-900 text-mavie-300 py-8 mt-12 text-center text-xs">
            <p>&copy; Mavie Eyelash Salon</p>
        </footer>
    </div>

    <!-- Application Logic -->
    <script>
        // â˜… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆAPIè¨­å®š (localStorageã‹ã‚‰èª­ã¿è¾¼ã¿)
        const SPREADSHEET_API_KEY = 'mavie_spreadsheet_api_url';
        let API_URL = localStorage.getItem(SPREADSHEET_API_KEY) || "";

        const STAFF_ROSTER = {
            honatsugi: ['haruka', 'vienna'],
            chiba: ['kiki', 'karin', 'nanami', 'kanon', 'ayami', 'miki']
        };

        // Premium Color Palette
        const BrandColors = {
            // Primary - Rose Gold
            primary: '#c97458',
            primaryLight: '#db9179',
            primaryDark: '#b85d42',
            // Accent - Deep Navy
            accent: '#334e68',
            accentLight: '#486581',
            accentDark: '#243b53',
            // Surface
            surface: '#faf9f7',
            surfaceAlt: '#f5f3f0',
            surfaceDark: '#e8e6e1',
            // Charts
            gold: '#c97458',
            brown: '#334e68',
            beige: '#9fb3c8',
            light: '#e8e6e1',
            white: '#ffffff',
            darkBrown: '#243b53',
            // Additional accent colors
            success: '#10b981',
            warning: '#f59e0b',
            purple: '#8b5cf6'
        };

        let rawData = [];
        let charts = {};
        let lockedStore = null;
        let lockedStaff = null;
        let changedRows = new Set();
        let monthlyGoal = 1100000; // Default goal

        // --- GOAL STORAGE FUNCTIONS ---
        const GOAL_STORAGE_KEY = 'mavie_staff_goals';
        const BASE_SALARY_STORAGE_KEY = 'mavie_staff_base_salary';
        const DEFAULT_GOAL = {
            weekdays: 0,
            weekends: 0,
            weekdayTarget: 0,
            weekendTarget: 0,
            retail: 0,
            newCustomers: 0,
            existingCustomers: 0,
            unitPrice: 0,
            newReservationRate: 0,
            reservationRate: 0,
            reviews5Star: 0
        };
        const DEFAULT_BASE_SALARY = 0; // Default base salary

        function loadGoalsFromStorage() {
            const stored = localStorage.getItem(GOAL_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveGoalsToStorage(goals) {
            localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify(goals));
        }

        function getStaffGoal(store, staff) {
            const goals = loadGoalsFromStorage();
            if (goals[store] && goals[store][staff]) {
                return goals[store][staff];
            }
            return { ...DEFAULT_GOAL };
        }

        function saveStaffGoal(store, staff, goalData) {
            const goals = loadGoalsFromStorage();
            if (!goals[store]) goals[store] = {};
            goals[store][staff] = goalData;
            saveGoalsToStorage(goals);
        }

        function getStoreAggregateGoal(store) {
            const goals = loadGoalsFromStorage();
            const staffList = STAFF_ROSTER[store] || [];

            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0
            };

            let staffCount = 0;
            staffList.forEach(staff => {
                const staffGoal = getStaffGoal(store, staff);
                aggregate.weekdays += staffGoal.weekdays;
                aggregate.weekends += staffGoal.weekends;
                aggregate.weekdayTarget += staffGoal.weekdayTarget;
                aggregate.weekendTarget += staffGoal.weekendTarget;
                aggregate.retail += staffGoal.retail;
                aggregate.newCustomers += staffGoal.newCustomers;
                aggregate.existingCustomers += staffGoal.existingCustomers;
                aggregate.unitPrice += staffGoal.unitPrice;
                aggregate.newReservationRate += staffGoal.newReservationRate;
                aggregate.reservationRate += staffGoal.reservationRate;
                staffCount++;
            });

            // Average for rates and unit price
            if (staffCount > 0) {
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getAllStoresAggregateGoal() {
            const goals = loadGoalsFromStorage();
            const allStores = Object.keys(STAFF_ROSTER);

            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0
            };

            let staffCount = 0;
            allStores.forEach(store => {
                const staffList = STAFF_ROSTER[store] || [];
                staffList.forEach(staff => {
                    const staffGoal = getStaffGoal(store, staff);
                    aggregate.weekdays += staffGoal.weekdays;
                    aggregate.weekends += staffGoal.weekends;
                    aggregate.weekdayTarget += staffGoal.weekdayTarget;
                    aggregate.weekendTarget += staffGoal.weekendTarget;
                    aggregate.retail += staffGoal.retail;
                    aggregate.newCustomers += staffGoal.newCustomers;
                    aggregate.existingCustomers += staffGoal.existingCustomers;
                    aggregate.unitPrice += staffGoal.unitPrice;
                    aggregate.newReservationRate += staffGoal.newReservationRate;
                    aggregate.reservationRate += staffGoal.reservationRate;
                    staffCount++;
                });
            });

            // Average for rates and unit price
            if (staffCount > 0) {
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getCurrentGoalContext() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal !== 'all') {
                return { type: 'staff', store: storeVal, staff: staffVal };
            } else if (storeVal !== 'all') {
                return { type: 'store', store: storeVal };
            } else {
                return { type: 'all' };
            }
        }

        // --- BASE SALARY FUNCTIONS ---
        function loadBaseSalariesFromStorage() {
            const stored = localStorage.getItem(BASE_SALARY_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveBaseSalariesToStorage(salaries) {
            localStorage.setItem(BASE_SALARY_STORAGE_KEY, JSON.stringify(salaries));
        }

        function getStaffBaseSalary(store, staff) {
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[store] && salaries[store][staff] !== undefined) {
                return salaries[store][staff];
            }
            return DEFAULT_BASE_SALARY;
        }

        function saveStaffBaseSalary(store, staff, salary) {
            const salaries = loadBaseSalariesFromStorage();
            if (!salaries[store]) salaries[store] = {};
            salaries[store][staff] = salary;
            saveBaseSalariesToStorage(salaries);
        }

        // --- INCENTIVE CALCULATION ---
        function calculateIncentive(data, store, staff) {
            // Get base salary
            const baseSalary = getStaffBaseSalary(store, staff);

            // Calculate service sales (cash + credit + qr)
            let serviceSales = 0;
            let retailSales = 0;

            data.forEach(d => {
                serviceSales += d.sales.cash + d.sales.credit + d.sales.qr;
                retailSales += d.sales.product || 0;
            });

            // Incentive from service sales (5%)
            const serviceIncentive = serviceSales * 0.05;

            // Incentive from retail sales (5% if < 100k, 10% if >= 100k)
            const retailIncentive = retailSales >= 100000
                ? retailSales * 0.1
                : retailSales * 0.05;

            // Total incentive = base salary + service incentive + retail incentive
            const totalIncentive = baseSalary + serviceIncentive + retailIncentive;

            return {
                baseSalary,
                serviceSales,
                serviceIncentive,
                retailSales,
                retailIncentive,
                totalIncentive
            };
        }
        
        // --- 0. INIT & DATE SELECTOR ---
        function initDateSelector() {
            const sel = document.getElementById('date-selector');
            const startYear = 2024;
            const endYear = 2030;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 1; m <= 12; m++) {
                    const opt = document.createElement('option');
                    const val = `${y}/${m}`; 
                    opt.value = val;
                    opt.text = `${y}å¹´ ${m}æœˆ`;
                    if (y === currentYear && m === currentMonth) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
        }

        function handleDateChange() {
            const dateVal = document.getElementById('date-selector').value;
            if (!API_URL) rawData = generateData(dateVal);
            updateDashboard();
        }

        // --- 1. MOCK DATA ---
        function generateData(yearMonthStr = "2024/1") {
            const data = [];
            const [year, month] = yearMonthStr.split('/').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            let idCounter = 1;

            Object.keys(STAFF_ROSTER).forEach(storeKey => {
                STAFF_ROSTER[storeKey].forEach(staffName => {
                    for (let i = 1; i <= daysInMonth; i++) {
                        if (Math.random() > 0.8) continue;

                        // All values set to 0
                        const salesCash = 0;
                        const salesCredit = 0;
                        const salesQr = 0;
                        const salesProduct = 0;

                        // All customer values set to 0
                        let newHPB = 0;
                        let newMiniNai = 0;
                        const referral = 0;
                        const acquaintance = 0;
                        const existing = 0;

                        const nextResNewHPB = 0;
                        const nextResMiniNai = 0;
                        const nextResExisting = 0;
                        
                        data.push({
                            id: idCounter++,
                            date: `${year}/${month}/${i}`,
                            store: storeKey,
                            storeName: storeKey === 'chiba' ? 'åƒè‘‰åº—' : 'æœ¬åšæœ¨åº—',
                            staff: staffName,
                            sales: { cash: salesCash, credit: salesCredit, qr: salesQr, product: salesProduct },
                            discounts: { hpbPoints: Math.random()>0.9?500:0, hpbGift: 0, other: 0, refund: Math.random()>0.98?3000:0 },
                            customers: { newHPB, newMiniNai, referral, acquaintance, existing },
                            nextRes: { newHPB: nextResNewHPB, newMiniNai: nextResMiniNai, existing: nextResExisting },
                            reviews5Star: 0
                        });
                    }
                });
            });
            return data;
        }

        // --- 2. DATA LOADING ---

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®è¡¨ç¤º/éè¡¨ç¤º
        function showLoading(text = 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', subtext = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã™') {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            const loadingSubtext = document.getElementById('loading-subtext');
            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.style.opacity = '1';
            }
            if (loadingText) loadingText.textContent = text;
            if (loadingSubtext) loadingSubtext.textContent = subtext;
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆAPI URLç®¡ç†
        function saveSpreadsheetApiUrl() {
            const urlInput = document.getElementById('spreadsheet-api-url');
            const url = urlInput ? urlInput.value.trim() : '';
            localStorage.setItem(SPREADSHEET_API_KEY, url);
            API_URL = url;

            const status = document.getElementById('spreadsheet-connection-status');
            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>APIã®URLãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</div>';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => status.classList.add('hidden'), 3000);
            }
        }

        function loadSpreadsheetApiUrl() {
            const urlInput = document.getElementById('spreadsheet-api-url');
            const savedUrl = localStorage.getItem(SPREADSHEET_API_KEY) || '';
            if (urlInput) urlInput.value = savedUrl;
        }

        async function testSpreadsheetConnection() {
            const status = document.getElementById('spreadsheet-connection-status');
            const url = document.getElementById('spreadsheet-api-url')?.value.trim() || API_URL;

            if (!url) {
                if (status) {
                    status.classList.remove('hidden');
                    status.innerHTML = '<div class="bg-yellow-50 border border-yellow-400 text-yellow-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i>URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
                return;
            }

            if (status) {
                status.classList.remove('hidden');
                status.innerHTML = '<div class="bg-blue-50 border border-blue-400 text-blue-700 px-4 py-2 rounded text-sm flex items-center gap-2"><svg class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...</div>';
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (status) {
                    status.innerHTML = `<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>æ¥ç¶šæˆåŠŸï¼ ${Array.isArray(data) ? data.length + 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—' : 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ'}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            } catch (e) {
                if (status) {
                    status.innerHTML = `<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-2 rounded text-sm flex items-center gap-2"><i data-lucide="x-circle" class="w-4 h-4"></i>æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        }

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆæ‰‹å‹•ï¼‰
        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-data-btn');
            const refreshIcon = document.getElementById('refresh-icon');

            // ãƒœã‚¿ãƒ³ã‚’ã‚¹ãƒ”ãƒ³çŠ¶æ…‹ã«
            if (refreshIcon) refreshIcon.classList.add('animate-spin');
            if (refreshBtn) refreshBtn.disabled = true;

            showLoading('ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...', 'æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ã—ã¦ã„ã¾ã™');

            try {
                await loadDataFromSpreadsheet();
                updateDashboard();
            } finally {
                hideLoading();
                if (refreshIcon) refreshIcon.classList.remove('animate-spin');
                if (refreshBtn) refreshBtn.disabled = false;
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadDataFromSpreadsheet() {
            // APIã®URLã‚’æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–°
            API_URL = localStorage.getItem(SPREADSHEET_API_KEY) || '';

            if (API_URL) {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    rawData = await response.json();
                    rawData = rawData.map((d, i) => ({...d, id: i+1}));
                    console.log(`âœ“ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ ${rawData.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ`);
                    return true;
                } catch (e) {
                    console.error("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                    return false;
                }
            }
            return false;
        }

        async function loadData() {
            showLoading();
            initDateSelector();
            const initialDate = document.getElementById('date-selector').value;

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            const loaded = await loadDataFromSpreadsheet();

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
            if (!loaded) {
                console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                rawData = generateData(initialDate);
            }

            checkUrlParams();
            updateDashboard();
            hideLoading();
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const pStore = params.get('store');
            const pStaff = params.get('staff');
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const staffModeBadge = document.getElementById('staff-mode-badge');

            if (pStore && STAFF_ROSTER[pStore]) {
                lockedStore = pStore;
                storeSel.value = pStore;
                storeSel.disabled = true;
                staffSel.innerHTML = '<option value="all">åº—èˆ—åˆè¨ˆ</option>';

                if (pStaff && STAFF_ROSTER[pStore].includes(pStaff)) {
                    lockedStaff = pStaff;
                    const opt = document.createElement('option');
                    opt.value = pStaff;
                    opt.text = pStaff;
                    staffSel.appendChild(opt);
                    staffSel.value = pStaff;
                    staffSel.disabled = true;

                    // Show staff mode badge
                    staffModeBadge.classList.remove('hidden');
                    staffModeBadge.innerText = `${pStaff} å°‚ç”¨`;

                    // Hide goal setting tab and settings tab for staff-specific URLs
                    const goalTab = document.getElementById('tab-goal');
                    if (goalTab) goalTab.style.display = 'none';
                    const settingsTab = document.getElementById('tab-settings');
                    if (settingsTab) settingsTab.style.display = 'none';

                    // Hide AI advice section for staff-specific URLs
                    const aiAdviceSection = document.getElementById('ai-advice-section');
                    if (aiAdviceSection) aiAdviceSection.style.display = 'none';
                } else {
                    STAFF_ROSTER[pStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            } else {
                handleStoreChange(false);
            }
        }

        let currentPeriodFilter = 'month'; // 'month', '3months', '6months', 'year'

        function getFilteredData() {
            const storeFilter = document.getElementById('store-selector').value;
            const staffFilter = document.getElementById('staff-selector').value;
            const dateSelector = document.getElementById('date-selector');
            const selectedDate = dateSelector ? dateSelector.value : null;

            return rawData.filter(d => {
                if (storeFilter !== 'all' && d.store !== storeFilter) return false;
                if (staffFilter !== 'all' && d.staff !== staffFilter) return false;

                // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ã®é©ç”¨
                if (currentPeriodFilter && d.date) {
                    const recordDate = new Date(d.date);
                    const today = new Date();
                    let startDate;

                    switch (currentPeriodFilter) {
                        case 'month':
                            // é¸æŠã•ã‚ŒãŸæœˆã®ã¿
                            if (selectedDate) {
                                const [year, month] = selectedDate.split('/').map(Number);
                                return recordDate.getFullYear() === year && (recordDate.getMonth() + 1) === month &&
                                       (storeFilter === 'all' || d.store === storeFilter) &&
                                       (staffFilter === 'all' || d.staff === staffFilter);
                            }
                            break;
                        case '3months':
                            startDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
                            if (recordDate < startDate) return false;
                            break;
                        case '6months':
                            startDate = new Date(today.getFullYear(), today.getMonth() - 5, 1);
                            if (recordDate < startDate) return false;
                            break;
                        case 'year':
                            startDate = new Date(today.getFullYear() - 1, today.getMonth(), 1);
                            if (recordDate < startDate) return false;
                            break;
                    }
                }

                return true;
            });
        }

        function setPeriodFilter(period) {
            currentPeriodFilter = period;

            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-surface-600', 'hover:bg-surface-200');
            });
            const activeBtn = document.getElementById(`period-${period}`);
            if (activeBtn) {
                activeBtn.classList.remove('text-surface-600', 'hover:bg-surface-200');
                activeBtn.classList.add('active');
            }

            // æ—¥ä»˜ã‚»ãƒ¬ã‚¯ã‚¿ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            const dateSelectorWrapper = document.getElementById('date-selector').parentElement;
            if (period === 'month') {
                dateSelectorWrapper.style.display = '';
            } else {
                dateSelectorWrapper.style.display = 'none';
            }

            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
            updateDashboard();
        }

        function calculateMetrics(data) {
            let agg = {
                salesTotal: 0, salesCash: 0, salesCredit: 0, salesQR: 0,
                customersTotal: 0, customersNew: 0, customersExisting: 0,
                newByChannel: { hpb: 0, mininai: 0 },
                nextRes: { hpbNew: 0, mininaiNew: 0, existing: 0, total: 0 },
                hpbNewCount: 0, lossTotal: 0, reviews5StarTotal: 0, daily: {}
            };
            data.forEach(d => { if(!agg.daily[d.date]) agg.daily[d.date] = { sales: 0, customers: 0, new: 0, existing: 0, hpb: 0, mininai: 0 }; });

            data.forEach(d => {
                const totalSales = d.sales.cash + d.sales.credit + d.sales.qr;
                agg.salesTotal += totalSales;
                agg.salesCash += d.sales.cash;
                agg.salesCredit += d.sales.credit;
                agg.salesQR += d.sales.qr;
                agg.lossTotal += (d.discounts.hpbPoints + d.discounts.hpbGift + d.discounts.other + d.discounts.refund);
                
                const totalCust = d.customers.newHPB + d.customers.newMiniNai + d.customers.existing;
                const newCust = d.customers.newHPB + d.customers.newMiniNai;
                
                agg.customersTotal += totalCust;
                agg.customersNew += newCust;
                agg.customersExisting += d.customers.existing;
                agg.newByChannel.hpb += d.customers.newHPB;
                agg.newByChannel.mininai += d.customers.newMiniNai;
                
                agg.nextRes.hpbNew += d.nextRes.newHPB;
                agg.nextRes.mininaiNew += d.nextRes.newMiniNai;
                agg.nextRes.existing += d.nextRes.existing;
                agg.nextRes.total += (d.nextRes.newHPB + d.nextRes.newMiniNai + d.nextRes.existing);
                agg.hpbNewCount += d.customers.newHPB;
                agg.reviews5StarTotal += (d.reviews5Star || 0);

                if(agg.daily[d.date]) {
                    agg.daily[d.date].sales += totalSales;
                    agg.daily[d.date].customers += totalCust;
                    agg.daily[d.date].new += newCust;
                    agg.daily[d.date].existing += d.customers.existing;
                    agg.daily[d.date].hpb += d.customers.newHPB;
                    agg.daily[d.date].mininai += d.customers.newMiniNai;
                }
            });
            return agg;
        }

        // --- 3. UI LOGIC ---
        function handleStoreChange(isUserAction = true) {
            if (isUserAction && lockedStore) return;
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="all">åº—èˆ—åˆè¨ˆ</option>';
            if (selectedStore === 'all') {
                staffSel.disabled = true;
            } else {
                staffSel.disabled = false;
                if(STAFF_ROSTER[selectedStore]){
                    STAFF_ROSTER[selectedStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            }
            if(isUserAction) updateDashboard();
        }

        function updateDashboard() {
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);
            const fmt = n => n.toLocaleString();

            // Get current goal based on context
            const context = getCurrentGoalContext();
            let currentGoalData;
            if (context.type === 'staff') {
                currentGoalData = getStaffGoal(context.store, context.staff);
            } else if (context.type === 'store') {
                currentGoalData = getStoreAggregateGoal(context.store);
            } else {
                currentGoalData = getAllStoresAggregateGoal();
            }
            const currentGoal = currentGoalData.weekdays * currentGoalData.weekdayTarget + currentGoalData.weekends * currentGoalData.weekendTarget;
            monthlyGoal = currentGoal; // Update global for backwards compatibility

            document.getElementById('kpi-sales').innerText = `Â¥${fmt(metrics.salesTotal)}`;
            document.getElementById('kpi-customers').innerHTML = `${fmt(metrics.customersTotal)}<span class="text-base font-normal ml-1">å</span>`;
            document.getElementById('kpi-new').innerText = fmt(metrics.customersNew);
            document.getElementById('kpi-existing').innerText = fmt(metrics.customersExisting);

            // Update goal ratio
            const goalRatio = currentGoal > 0 ? Math.round((metrics.salesTotal / currentGoal) * 100) : 0;
            document.getElementById('kpi-goal-ratio').innerText = `${goalRatio}%`;

            const unitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('kpi-unit-price').innerText = `Â¥${fmt(unitPrice)}`;

            const hpbRate = metrics.hpbNewCount > 0 ? ((metrics.nextRes.hpbNew / metrics.hpbNewCount)*100).toFixed(1) : 0;
            document.getElementById('kpi-hpb-rate').innerText = `${hpbRate}%`;

            // Update 5 Star Reviews
            document.getElementById('kpi-reviews-5star').innerText = fmt(metrics.reviews5StarTotal);
            const reviews5StarGoal = currentGoalData.reviews5Star || 0;
            const reviews5StarRate = reviews5StarGoal > 0 ? Math.round((metrics.reviews5StarTotal / reviews5StarGoal) * 100) : 0;
            document.getElementById('kpi-reviews-5star-rate').innerText = `${reviews5StarRate}%`;

            // Incentive Card & Staff Dashboard Tab Logic
            const staffSel = document.getElementById('staff-selector');
            const incCard = document.getElementById('kpi-incentive-card');
            const staffDashboardTab = document.getElementById('tab-staff-dashboard');

            if (staffSel.value !== 'all') {
                incCard.classList.remove('hidden');
                staffDashboardTab.classList.remove('hidden');

                // Calculate real incentive
                const storeVal = document.getElementById('store-selector').value;
                const incentiveData = calculateIncentive(filtered, storeVal, staffSel.value);
                document.getElementById('val-incentive').innerText = `Â¥${Math.round(incentiveData.totalIncentive).toLocaleString()}`;

                // Update Staff Dashboard
                updateStaffDashboard(staffSel.value, metrics, incentiveData);
            } else {
                incCard.classList.add('hidden');
                staffDashboardTab.classList.add('hidden');
            }

            updateTable(filtered);
            updateCharts(metrics);
            renderEditTable(filtered);
        }

        function updateStaffDashboard(staffName, personalMetrics, incentiveData) {
            const fmt = n => n.toLocaleString();

            // Update staff name
            document.getElementById('staff-dashboard-name').innerText = staffName;

            // Get store total (filter by current store only)
            const storeFilter = document.getElementById('store-selector').value;
            const storeData = rawData.filter(d => storeFilter !== 'all' ? d.store === storeFilter : true);
            const storeMetrics = calculateMetrics(storeData);

            // Get staff goals from storage
            const staffGoalData = getStaffGoal(storeFilter, staffName);
            const salesGoal = staffGoalData.weekdays * staffGoalData.weekdayTarget + staffGoalData.weekends * staffGoalData.weekendTarget;
            const newGoal = staffGoalData.newCustomers;
            const existingGoal = staffGoalData.existingCustomers;
            const unitPriceGoal = staffGoalData.unitPrice;
            const newResRateGoal = staffGoalData.newReservationRate;
            const resRateGoal = staffGoalData.reservationRate;

            // Store goals (aggregate from all staff in store)
            const storeGoalData = getStoreAggregateGoal(storeFilter);
            const storeSalesGoal = storeGoalData.weekdays * storeGoalData.weekdayTarget + storeGoalData.weekends * storeGoalData.weekendTarget;
            const storeNewGoal = storeGoalData.newCustomers;
            const storeExistingGoal = storeGoalData.existingCustomers;

            // Personal metrics
            const personalUnitPrice = personalMetrics.customersTotal > 0 ? Math.round(personalMetrics.salesTotal / personalMetrics.customersTotal) : 0;
            const personalNewResRate = personalMetrics.hpbNewCount > 0 ? ((personalMetrics.nextRes.hpbNew / personalMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const personalResRate = personalMetrics.customersTotal > 0 ? ((personalMetrics.nextRes.total / personalMetrics.customersTotal)*100).toFixed(1) : 0;
            const personalSalesPercent = salesGoal > 0 ? Math.round((personalMetrics.salesTotal / salesGoal) * 100) : 0;

            // Store metrics
            const storeUnitPrice = storeMetrics.customersTotal > 0 ? Math.round(storeMetrics.salesTotal / storeMetrics.customersTotal) : 0;
            const storeNewResRate = storeMetrics.hpbNewCount > 0 ? ((storeMetrics.nextRes.hpbNew / storeMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const storeResRate = storeMetrics.customersTotal > 0 ? ((storeMetrics.nextRes.total / storeMetrics.customersTotal)*100).toFixed(1) : 0;
            const storeSalesPercent = storeSalesGoal > 0 ? Math.round((storeMetrics.salesTotal / storeSalesGoal) * 100) : 0;

            // Update Personal Section
            document.getElementById('staff-personal-sales').innerText = `Â¥${fmt(personalMetrics.salesTotal)}`;
            document.getElementById('staff-personal-goal').innerText = `Â¥${fmt(salesGoal)}`;
            document.getElementById('staff-personal-goal-rate').innerText = `${personalSalesPercent}%`;
            document.getElementById('staff-personal-customers').innerText = `${fmt(personalMetrics.customersTotal)}å`;
            document.getElementById('staff-personal-new').innerText = fmt(personalMetrics.customersNew);
            document.getElementById('staff-personal-new-goal').innerText = newGoal;
            document.getElementById('staff-personal-existing').innerText = fmt(personalMetrics.customersExisting);
            document.getElementById('staff-personal-existing-goal').innerText = existingGoal;
            document.getElementById('staff-personal-unit-price').innerText = `Â¥${fmt(personalUnitPrice)}`;
            document.getElementById('staff-personal-unit-price-goal').innerText = `Â¥${fmt(unitPriceGoal)}`;
            document.getElementById('staff-personal-new-res-rate').innerText = `${personalNewResRate}%`;
            document.getElementById('staff-personal-new-res-rate-goal').innerText = `${newResRateGoal}%`;
            document.getElementById('staff-personal-res-rate').innerText = `${personalResRate}%`;
            document.getElementById('staff-personal-res-rate-goal').innerText = `${resRateGoal}%`;
            document.getElementById('staff-personal-reviews').innerText = fmt(personalMetrics.reviews5StarTotal);
            document.getElementById('staff-personal-reviews-goal').innerText = staffGoalData.reviews5Star || 0;

            // Update Store Section
            document.getElementById('staff-store-sales').innerText = `Â¥${fmt(storeMetrics.salesTotal)}`;
            document.getElementById('staff-store-goal').innerText = `Â¥${fmt(storeSalesGoal)}`;
            document.getElementById('staff-store-goal-rate').innerText = `${storeSalesPercent}%`;
            document.getElementById('staff-store-customers').innerText = `${fmt(storeMetrics.customersTotal)}å`;
            document.getElementById('staff-store-new').innerText = fmt(storeMetrics.customersNew);
            document.getElementById('staff-store-new-goal').innerText = storeNewGoal;
            document.getElementById('staff-store-existing').innerText = fmt(storeMetrics.customersExisting);
            document.getElementById('staff-store-existing-goal').innerText = storeExistingGoal;
            document.getElementById('staff-store-unit-price').innerText = `Â¥${fmt(storeUnitPrice)}`;
            document.getElementById('staff-store-unit-price-goal').innerText = `Â¥${fmt(unitPriceGoal)}`;
            document.getElementById('staff-store-new-res-rate').innerText = `${storeNewResRate}%`;
            document.getElementById('staff-store-new-res-rate-goal').innerText = `${newResRateGoal}%`;
            document.getElementById('staff-store-res-rate').innerText = `${storeResRate}%`;
            document.getElementById('staff-store-res-rate-goal').innerText = `${resRateGoal}%`;
            document.getElementById('staff-store-reviews').innerText = fmt(storeMetrics.reviews5StarTotal);
            document.getElementById('staff-store-reviews-goal').innerText = storeGoalData.reviews5Star || 0;

            // Update Progress Bars
            const newPercent = newGoal > 0 ? Math.min(Math.round((personalMetrics.customersNew / newGoal) * 100), 100) : 0;
            const existingPercent = existingGoal > 0 ? Math.min(Math.round((personalMetrics.customersExisting / existingGoal) * 100), 100) : 0;

            document.getElementById('staff-progress-sales-percent').innerText = personalSalesPercent;
            document.getElementById('staff-progress-sales-bar').style.width = `${Math.min(personalSalesPercent, 100)}%`;
            document.getElementById('staff-progress-new-percent').innerText = newPercent;
            document.getElementById('staff-progress-new-bar').style.width = `${newPercent}%`;
            document.getElementById('staff-progress-existing-percent').innerText = existingPercent;
            document.getElementById('staff-progress-existing-bar').style.width = `${existingPercent}%`;

            // Update Incentive Details
            if (incentiveData) {
                document.getElementById('staff-incentive-total').innerText = `Â¥${Math.round(incentiveData.totalIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-base').innerText = `Â¥${incentiveData.baseSalary.toLocaleString()}`;
                document.getElementById('staff-incentive-service-sales').innerText = `æ–½è¡“å£²ä¸Š: Â¥${Math.round(incentiveData.serviceSales).toLocaleString()}`;
                document.getElementById('staff-incentive-service').innerText = `Â¥${Math.round(incentiveData.serviceIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-sales').innerText = `ç‰©è²©å£²ä¸Š: Â¥${Math.round(incentiveData.retailSales).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-rate').innerText = incentiveData.retailSales >= 100000 ? '(10%é©ç”¨)' : '(5%é©ç”¨)';
                document.getElementById('staff-incentive-retail').innerText = `Â¥${Math.round(incentiveData.retailIncentive).toLocaleString()}`;
            }
        }

        function updateTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20);

            sorted.forEach(d => {
                const total = d.sales.cash + d.sales.credit + d.sales.qr;
                const hpbRate = d.customers.newHPB > 0 ? Math.round((d.nextRes.newHPB/d.customers.newHPB)*100) : '-';
                const storeLabel = d.store === 'chiba' ? 'åƒè‘‰åº—' : 'æœ¬åšæœ¨åº—';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-xs font-bold text-mavie-800">${storeLabel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-mavie-600">${d.staff}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-mavie-500">${d.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right font-medium text-mavie-800">Â¥${total.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right text-mavie-600">${d.customers.newHPB + d.customers.newMiniNai + d.customers.existing}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right ${hpbRate < 40 && hpbRate !== '-' ? 'text-red-400' : ''}">${hpbRate !== '-' ? hpbRate+'%' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. CHARTS ---
        function initCharts() {
            const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: {family: 'sans-serif'} } } } };
            
            // Overview Chart: Line (Unit Price) + Stacked Bar (New/Existing)
            charts.overview = new Chart(document.getElementById('overviewChart'), {
                type: 'bar', // Base type
                data: {},
                options: {
                    ...common,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { 
                            type: 'linear', position: 'left', 
                            title: { display: true, text: 'å˜ä¾¡ (Â¥)' },
                            grid: { display: false } 
                        },
                        y1: { 
                            type: 'linear', position: 'right', stacked: true,
                            title: { display: true, text: 'æ¥åº—æ•° (å)' },
                            grid: { borderDash: [4, 4], color: '#e8e6e1' } 
                        }
                    }
                }
            });

            charts.ratio = new Chart(document.getElementById('customerRatioChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '70%' } });
            charts.share = new Chart(document.getElementById('channelShareChart'), { type: 'pie', data: {}, options: common });
            charts.trend = new Chart(document.getElementById('channelTrendChart'), { type: 'bar', data: {}, options: { ...common, scales: { x:{stacked:true}, y:{stacked:true} } } });
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '60%' } });
            charts.loss = new Chart(document.getElementById('lossChart'), { type: 'bar', indexAxis: 'y', data: {}, options: common });
        }

        function updateCharts(metrics) {
            const labels = Object.keys(metrics.daily).sort((a,b) => new Date(a) - new Date(b));
            const d = metrics.daily;
            
            // Calculate Daily Unit Price
            const unitPriceData = labels.map(k => {
                const totalCust = d[k].customers;
                return totalCust > 0 ? Math.round(d[k].sales / totalCust) : 0;
            });

            // Update Overview Chart
            charts.overview.data = { 
                labels: labels, 
                datasets: [
                    {
                        type: 'line',
                        label: 'å¹³å‡å®¢å˜ä¾¡',
                        data: unitPriceData,
                        borderColor: BrandColors.brown,
                        backgroundColor: BrandColors.brown,
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y',
                        pointRadius: 2
                    },
                    {
                        type: 'bar',
                        label: 'æ–°è¦æ¥åº—',
                        data: labels.map(k => d[k].new),
                        backgroundColor: BrandColors.gold,
                        yAxisID: 'y1',
                        stack: 'visits'
                    },
                    {
                        type: 'bar',
                        label: 'æ—¢å­˜æ¥åº—',
                        data: labels.map(k => d[k].existing),
                        backgroundColor: BrandColors.beige,
                        yAxisID: 'y1',
                        stack: 'visits'
                    }
                ]
            }; 
            charts.overview.update();

            charts.ratio.data = { labels: ['æ–°è¦', 'æ—¢å­˜'], datasets: [{ data: [metrics.customersNew, metrics.customersExisting], backgroundColor: [BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.ratio.update();
            charts.share.data = { labels: ['HPB', 'minimo/Nailie'], datasets: [{ data: [metrics.newByChannel.hpb, metrics.newByChannel.mininai], backgroundColor: [BrandColors.gold, BrandColors.beige], borderWidth:1, borderColor:'#fff' }] }; charts.share.update();
            charts.trend.data = { labels: labels, datasets: [
                { label: 'HPB', data: labels.map(k=>d[k].hpb), backgroundColor: BrandColors.gold },
                { label: 'minimo/Nailie', data: labels.map(k=>d[k].mininai), backgroundColor: BrandColors.beige }
            ]}; charts.trend.update();
            charts.payment.data = { labels: ['ç¾é‡‘', 'ã‚¯ãƒ¬ã‚«', 'QR'], datasets: [{ data: [metrics.salesCash, metrics.salesCredit, metrics.salesQR], backgroundColor: [BrandColors.beige, BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.payment.update();
            charts.loss.data = { labels: ['æå¤±'], datasets: [{ label: 'å‰²å¼•ãƒ»è¿”é‡‘', data: [metrics.lossTotal], backgroundColor: BrandColors.brown, barThickness:40 }] }; charts.loss.update();
        }

        // --- 5. EDIT & SAVE LOGIC ---
        function renderEditTable(data) {
            const tbody = document.getElementById('edit-table-body');
            tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                tr.dataset.id = row.id;
                if (changedRows.has(row.id)) tr.classList.add('changed-row');

                tr.innerHTML = `
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.date}" readonly></td>
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.storeName}" readonly></td>
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.staff}" readonly></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.cash" value="${row.sales.cash}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.credit" value="${row.sales.credit}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.qr" value="${row.sales.qr}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newHPB" value="${row.customers.newHPB}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newMiniNai" value="${row.customers.newMiniNai}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.referral" value="${row.customers.referral || 0}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.acquaintance" value="${row.customers.acquaintance || 0}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.existing" value="${row.customers.existing}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.newHPB" value="${row.nextRes.newHPB}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.newMiniNai" value="${row.nextRes.newMiniNai}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.existing" value="${row.nextRes.existing}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="reviews5Star" value="${row.reviews5Star || 0}" onchange="markChanged(${row.id})"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function markChanged(id) {
            changedRows.add(id);
            const row = document.querySelector(`tr[data-id='${id}']`);
            if(row) row.classList.add('changed-row');
        }

        function applyEditsLocally() {
            const inputs = document.querySelectorAll('#edit-table-body input:not([readonly])');
            inputs.forEach(input => {
                const tr = input.closest('tr');
                const id = parseInt(tr.dataset.id);
                if (!changedRows.has(id)) return;

                const fieldPath = input.dataset.field.split('.');
                const val = parseInt(input.value) || 0;
                const item = rawData.find(d => d.id === id);
                if (item) {
                    if (fieldPath.length === 2) {
                        item[fieldPath[0]][fieldPath[1]] = val;
                    } else if (fieldPath.length === 1) {
                        // Handle top-level fields like reviews5Star
                        item[fieldPath[0]] = val;
                    }
                }
            });
            alert("è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã—ãŸ (æœªä¿å­˜)");
            updateDashboard();
        }

        async function saveToSpreadsheet() {
            if (!API_URL) {
                alert("API URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ä¿å­˜ã§ãã¾ã›ã‚“ã€‚GASã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚");
                applyEditsLocally();
                return;
            }

            const btn = document.getElementById('btn-save-sheet');
            const originalText = btn.innerHTML;
            btn.innerHTML = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            applyEditsLocally(); 
            const modifiedData = rawData.filter(d => changedRows.has(d.id));
            
            if (modifiedData.length === 0) {
                alert("å¤‰æ›´ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "update",
                        rows: modifiedData
                    })
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    alert("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    changedRows.clear();
                    renderEditTable(getFilteredData());
                } else {
                    alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + result.message);
                }

            } catch (e) {
                console.error(e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function saveGoalsToSpreadsheet() {
            if (!API_URL) {
                alert("API URLãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã§ãã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚");
                return;
            }

            const btn = document.getElementById('btn-save-goals');
            const originalText = btn.innerHTML;
            btn.innerHTML = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            try {
                const goals = loadGoalsFromStorage();
                const salaries = loadBaseSalariesFromStorage();

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "save_goals",
                        goals: goals,
                        salaries: salaries
                    })
                });

                const result = await response.json();

                if (result.status === "success") {
                    alert("ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ãŒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼");
                } else {
                    alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + result.message);
                }

            } catch (e) {
                console.error(e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- 6. GOAL CALCULATOR ---
        function handleGoalStoreChange() {
            const storeSel = document.getElementById('goal-store-selector');
            const staffSel = document.getElementById('goal-staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="all">åº—èˆ—åˆè¨ˆ</option>';
            if (selectedStore === 'all') {
                staffSel.disabled = true;
            } else {
                staffSel.disabled = false;
                if(STAFF_ROSTER[selectedStore]){
                    STAFF_ROSTER[selectedStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            }
            loadGoalInputs();
        }

        function getCurrentGoalContextForGoalTab() {
            const storeVal = document.getElementById('goal-store-selector').value;
            const staffVal = document.getElementById('goal-staff-selector').value;

            if (staffVal !== 'all') {
                return { type: 'staff', store: storeVal, staff: staffVal };
            } else if (storeVal !== 'all') {
                return { type: 'store', store: storeVal };
            } else {
                return { type: 'all' };
            }
        }

        function loadGoalInputs() {
            const context = getCurrentGoalContextForGoalTab();
            let goalData;

            if (context.type === 'staff') {
                goalData = getStaffGoal(context.store, context.staff);
            } else if (context.type === 'store') {
                goalData = getStoreAggregateGoal(context.store);
            } else {
                goalData = getAllStoresAggregateGoal();
            }

            // Load values into inputs
            document.getElementById('goal-weekdays').value = goalData.weekdays;
            document.getElementById('goal-weekends').value = goalData.weekends;
            document.getElementById('goal-weekday-target').value = goalData.weekdayTarget;
            document.getElementById('goal-weekend-target').value = goalData.weekendTarget;
            document.getElementById('goal-retail').value = goalData.retail;
            document.getElementById('goal-new-customers').value = goalData.newCustomers;
            document.getElementById('goal-existing-customers').value = goalData.existingCustomers;
            document.getElementById('goal-unit-price').value = goalData.unitPrice;
            document.getElementById('goal-new-reservation-rate').value = goalData.newReservationRate;
            document.getElementById('goal-reservation-rate').value = goalData.reservationRate;
            document.getElementById('goal-reviews-5star').value = goalData.reviews5Star || 0;

            // Load base salary
            if (context.type === 'staff') {
                const baseSalary = getStaffBaseSalary(context.store, context.staff);
                document.getElementById('goal-base-salary').value = baseSalary;
            } else {
                document.getElementById('goal-base-salary').value = DEFAULT_BASE_SALARY;
            }

            // Disable inputs if viewing aggregate (store or all)
            const inputs = document.querySelectorAll('#content-goal input');
            const hintText = document.getElementById('goal-hint-text');

            if (context.type === 'staff') {
                inputs.forEach(input => input.disabled = false);
                hintText.innerHTML = 'å„é …ç›®ã®ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨<strong>è‡ªå‹•ä¿å­˜</strong>ã•ã‚Œã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã¾ã™ã€‚åº—èˆ—åˆè¨ˆã¯æ‰€å±ã‚¹ã‚¿ãƒƒãƒ•ã®ç›®æ¨™ã®<strong>åˆç®—å€¤</strong>ã¨ãªã‚Šã¾ã™ã€‚';
            } else {
                inputs.forEach(input => input.disabled = true);
                if (context.type === 'store') {
                    hintText.innerHTML = '<strong>åº—èˆ—åˆè¨ˆè¡¨ç¤ºä¸­</strong>: ã“ã®ç›®æ¨™ã¯æ‰€å±ã‚¹ã‚¿ãƒƒãƒ•ã®ç›®æ¨™ã®åˆç®—å€¤ã§ã™ã€‚å€‹åˆ¥ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€å€‹äººç›®æ¨™ã‚’ç·¨é›†ã§ãã¾ã™ã€‚';
                } else {
                    hintText.innerHTML = '<strong>å…¨åº—èˆ—è¡¨ç¤ºä¸­</strong>: ã“ã®ç›®æ¨™ã¯å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®ç›®æ¨™ã®åˆç®—å€¤ã§ã™ã€‚å€‹åˆ¥ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã¨ã€å€‹äººç›®æ¨™ã‚’ç·¨é›†ã§ãã¾ã™ã€‚';
                }
            }

            calculateGoal();
        }

        function saveBaseSalaryAndCalculate() {
            const context = getCurrentGoalContextForGoalTab();
            if (context.type === 'staff') {
                const baseSalary = parseInt(document.getElementById('goal-base-salary').value) || DEFAULT_BASE_SALARY;
                saveStaffBaseSalary(context.store, context.staff, baseSalary);
            }
            calculateGoal();
        }

        function calculateGoal() {
            const weekdays = parseInt(document.getElementById('goal-weekdays').value) || 0;
            const weekends = parseInt(document.getElementById('goal-weekends').value) || 0;
            const weekdayTarget = parseInt(document.getElementById('goal-weekday-target').value) || 0;
            const weekendTarget = parseInt(document.getElementById('goal-weekend-target').value) || 0;
            const retailTarget = parseInt(document.getElementById('goal-retail').value) || 0;
            const newCustomersTarget = parseInt(document.getElementById('goal-new-customers').value) || 0;
            const existingCustomersTarget = parseInt(document.getElementById('goal-existing-customers').value) || 0;
            const unitPriceTarget = parseInt(document.getElementById('goal-unit-price').value) || 0;
            const newResRateTarget = parseInt(document.getElementById('goal-new-reservation-rate').value) || 0;
            const resRateTarget = parseInt(document.getElementById('goal-reservation-rate').value) || 0;
            const reviews5StarTarget = parseInt(document.getElementById('goal-reviews-5star').value) || 0;

            const weekdayTotal = weekdays * weekdayTarget;
            const weekendTotal = weekends * weekendTarget;
            const totalGoal = weekdayTotal + weekendTotal;

            // Save goal if we're in staff context
            const context = getCurrentGoalContextForGoalTab();
            if (context.type === 'staff') {
                const goalData = {
                    weekdays, weekends, weekdayTarget, weekendTarget,
                    retail: retailTarget,
                    newCustomers: newCustomersTarget,
                    existingCustomers: existingCustomersTarget,
                    unitPrice: unitPriceTarget,
                    newReservationRate: newResRateTarget,
                    reservationRate: resRateTarget,
                    reviews5Star: reviews5StarTarget
                };
                saveStaffGoal(context.store, context.staff, goalData);

                // Show save notice briefly
                const saveNotice = document.getElementById('goal-save-notice');
                saveNotice.style.display = 'block';
                setTimeout(() => {
                    saveNotice.style.display = 'none';
                }, 2000);
            }

            // Update global goal
            monthlyGoal = totalGoal;

            // Format numbers
            const fmt = n => n.toLocaleString();

            // Update display
            document.getElementById('goal-total').innerText = `Â¥${fmt(totalGoal)}`;
            document.getElementById('goal-weekday-total').innerText = `Â¥${fmt(weekdayTotal)}`;
            document.getElementById('goal-weekend-total').innerText = `Â¥${fmt(weekendTotal)}`;
            document.getElementById('goal-retail-display').innerText = `Â¥${fmt(retailTarget)}`;

            // Get current metrics
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);

            // Update achievement status - Sales
            const currentSales = metrics.salesTotal;
            const percentage = totalGoal > 0 ? Math.round((currentSales / totalGoal) * 100) : 0;
            const remaining = totalGoal - currentSales;
            const progressWidth = Math.min(percentage, 100);

            document.getElementById('goal-current-sales').innerText = `Â¥${fmt(currentSales)}`;
            document.getElementById('goal-percentage').innerText = `${percentage}%`;
            document.getElementById('goal-remaining').innerText = `Â¥${fmt(Math.max(remaining, 0))}`;
            document.getElementById('goal-progress-bar').style.width = `${progressWidth}%`;

            // Update achievement status - Customers & KPIs
            document.getElementById('goal-new-current').innerText = `${fmt(metrics.customersNew)}å`;
            document.getElementById('goal-new-target').innerText = `${fmt(newCustomersTarget)}å`;

            document.getElementById('goal-existing-current').innerText = `${fmt(metrics.customersExisting)}å`;
            document.getElementById('goal-existing-target').innerText = `${fmt(existingCustomersTarget)}å`;

            const currentUnitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('goal-unit-price-current').innerText = `Â¥${fmt(currentUnitPrice)}`;
            document.getElementById('goal-unit-price-target').innerText = `Â¥${fmt(unitPriceTarget)}`;

            const currentNewResRate = metrics.hpbNewCount > 0 ? ((metrics.nextRes.hpbNew / metrics.hpbNewCount)*100).toFixed(1) : 0;
            document.getElementById('goal-new-res-rate-current').innerText = `${currentNewResRate}%`;
            document.getElementById('goal-new-res-rate-target').innerText = `${newResRateTarget}%`;

            const currentResRate = metrics.customersTotal > 0 ? ((metrics.nextRes.total / metrics.customersTotal)*100).toFixed(1) : 0;
            document.getElementById('goal-res-rate-current').innerText = `${currentResRate}%`;
            document.getElementById('goal-res-rate-target').innerText = `${resRateTarget}%`;

            // Update main KPI card
            updateDashboard();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-accent-800');
                btn.classList.add('text-surface-500');
            });
            const active = document.getElementById(`tab-${id}`);
            active.classList.remove('text-surface-500');
            active.classList.add('active', 'text-accent-800');

            // Load goal when switching to goal tab
            if (id === 'goal') {
                // Initialize goal selectors from main selectors
                const mainStore = document.getElementById('store-selector').value;
                const mainStaff = document.getElementById('staff-selector').value;
                document.getElementById('goal-store-selector').value = mainStore;
                handleGoalStoreChange();
                // Try to set staff selector if available
                const goalStaffSel = document.getElementById('goal-staff-selector');
                const matchingOption = Array.from(goalStaffSel.options).find(opt => opt.value === mainStaff);
                if (matchingOption) {
                    goalStaffSel.value = mainStaff;
                }
                loadGoalInputs();
            }

            // Update settings list when switching to settings tab
            if (id === 'settings') {
                updateSettingsList();
                loadGeminiApiKey(); // Load API key
                loadSpreadsheetApiUrl(); // Load spreadsheet API URL
                // Re-render Lucide icons for settings tab
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Render calendar when switching to calendar tab
            if (id === 'calendar') {
                renderCalendar();
            }
        }

        function generateStaffURL() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal === 'all') {
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const baseURL = window.location.origin + window.location.pathname;
            const staffURL = `${baseURL}?store=${storeVal}&staff=${staffVal}`;

            // Copy to clipboard
            navigator.clipboard.writeText(staffURL).then(() => {
                alert(`å°‚ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n\n${staffURL}\n\nã“ã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€${staffVal}å°‚ç”¨ã®ãƒ“ãƒ¥ãƒ¼ã«ãªã‚Šã¾ã™ã€‚`);
            }).catch(err => {
                prompt('ã“ã®å°‚ç”¨URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', staffURL);
            });
        }

        // --- STAFF & STORE MANAGEMENT ---
        function updateSettingsList() {
            // Update store list
            const storeList = document.getElementById('store-list');
            storeList.innerHTML = '';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'flex items-center justify-between bg-mavie-50 p-3 rounded';
                storeDiv.innerHTML = `
                    <span class="font-medium">${storeId}</span>
                    <button onclick="deleteStore('${storeId}')" class="text-red-600 hover:text-red-800 text-sm font-bold">å‰Šé™¤</button>
                `;
                storeList.appendChild(storeDiv);
            });

            // Update staff list
            const staffList = document.getElementById('staff-list');
            staffList.innerHTML = '';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                STAFF_ROSTER[storeId].forEach(staffName => {
                    const staffDiv = document.createElement('div');
                    staffDiv.className = 'flex items-center justify-between bg-mavie-50 p-3 rounded';
                    staffDiv.innerHTML = `
                        <span><strong>${storeId}</strong>: ${staffName}</span>
                        <button onclick="deleteStaff('${storeId}', '${staffName}')" class="text-red-600 hover:text-red-800 text-sm font-bold">å‰Šé™¤</button>
                    `;
                    staffList.appendChild(staffDiv);
                });
            });

            // Update staff store selector
            const staffStoreSel = document.getElementById('staff-store-selector');
            staffStoreSel.innerHTML = '<option value="">åº—èˆ—ã‚’é¸æŠ</option>';
            Object.keys(STAFF_ROSTER).forEach(storeId => {
                const opt = document.createElement('option');
                opt.value = storeId;
                opt.text = storeId;
                staffStoreSel.appendChild(opt);
            });
        }

        function addStore() {
            const storeId = document.getElementById('new-store-id').value.trim();
            const storeName = document.getElementById('new-store-name').value.trim();

            if (!storeId) {
                alert('åº—èˆ—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (STAFF_ROSTER[storeId]) {
                alert('ã“ã®åº—èˆ—IDã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            // Confirmation dialog
            if (!confirm(`åº—èˆ—ã€Œ${storeId}ã€ã‚’è¿½åŠ ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nåº—èˆ—ID: ${storeId}\nåº—èˆ—å: ${storeName || '(æœªè¨­å®š)'}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã®ã§ã€å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`)) {
                return;
            }

            STAFF_ROSTER[storeId] = [];
            document.getElementById('new-store-id').value = '';
            document.getElementById('new-store-name').value = '';

            updateSettingsList();
            alert(`åº—èˆ—ã€Œ${storeId}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function deleteStore(storeId) {
            if (!confirm(`åº—èˆ—ã€Œ${storeId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ã¨ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            delete STAFF_ROSTER[storeId];

            // Delete related goal data
            const goals = loadGoalsFromStorage();
            if (goals[storeId]) {
                delete goals[storeId];
                saveGoalsToStorage(goals);
            }

            // Delete related salary data
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[storeId]) {
                delete salaries[storeId];
                saveBaseSalariesToStorage(salaries);
            }

            updateSettingsList();
            alert(`åº—èˆ—ã€Œ${storeId}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        function addStaff() {
            const storeId = document.getElementById('staff-store-selector').value;
            const staffName = document.getElementById('new-staff-name').value.trim();

            if (!storeId) {
                alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (!staffName) {
                alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (!STAFF_ROSTER[storeId]) {
                alert('é¸æŠã•ã‚ŒãŸåº—èˆ—ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                return;
            }

            if (STAFF_ROSTER[storeId].includes(staffName)) {
                alert('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
                return;
            }

            // Confirmation dialog
            if (!confirm(`ã‚¹ã‚¿ãƒƒãƒ•ã€Œ${staffName}ã€ã‚’${storeId}ã«è¿½åŠ ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã‚¹ã‚¿ãƒƒãƒ•å: ${staffName}\nåº—èˆ—: ${storeId}\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã®ã§ã€å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`)) {
                return;
            }

            STAFF_ROSTER[storeId].push(staffName);
            document.getElementById('new-staff-name').value = '';

            updateSettingsList();
            alert(`ã‚¹ã‚¿ãƒƒãƒ•ã€Œ${staffName}ã€ã‚’${storeId}ã«è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function deleteStaff(storeId, staffName) {
            if (!confirm(`ã‚¹ã‚¿ãƒƒãƒ•ã€Œ${staffName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            const index = STAFF_ROSTER[storeId].indexOf(staffName);
            if (index > -1) {
                STAFF_ROSTER[storeId].splice(index, 1);
            }

            // Delete related goal data
            const goals = loadGoalsFromStorage();
            if (goals[storeId] && goals[storeId][staffName]) {
                delete goals[storeId][staffName];
                saveGoalsToStorage(goals);
            }

            // Delete related salary data
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[storeId] && salaries[storeId][staffName]) {
                delete salaries[storeId][staffName];
                saveBaseSalariesToStorage(salaries);
            }

            updateSettingsList();
            alert(`ã‚¹ã‚¿ãƒƒãƒ•ã€Œ${staffName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // --- GEMINI API FUNCTIONS ---
        const GEMINI_API_KEY_STORAGE = 'mavie_gemini_api_key';

        function saveGeminiApiKey() {
            const apiKey = document.getElementById('gemini-api-key').value.trim();
            if (!apiKey) {
                alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            localStorage.setItem(GEMINI_API_KEY_STORAGE, apiKey);
            alert('Gemini APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function loadGeminiApiKey() {
            const apiKey = localStorage.getItem(GEMINI_API_KEY_STORAGE);
            if (apiKey) {
                document.getElementById('gemini-api-key').value = apiKey;
            }
            return apiKey;
        }

        async function getAIAdvice() {
            const apiKey = loadGeminiApiKey();
            if (!apiKey) {
                alert('å…ˆã«è¨­å®šã‚¿ãƒ–ã§Gemini APIã‚­ãƒ¼ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„');
                return;
            }

            const btn = document.getElementById('btn-ai-advice');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'åˆ†æä¸­...';
            btn.disabled = true;

            try {
                // Get current metrics and goals
                const filtered = getFilteredData();
                const metrics = calculateMetrics(filtered);
                const context = getCurrentGoalContext();

                let goalData;
                if (context.type === 'staff') {
                    goalData = getStaffGoal(context.store, context.staff);
                } else if (context.type === 'store') {
                    goalData = getStoreAggregateGoal(context.store);
                } else {
                    goalData = getAllStoresAggregateGoal();
                }

                const salesGoal = goalData.weekdays * goalData.weekdayTarget + goalData.weekends * goalData.weekendTarget;
                const currentSales = metrics.salesTotal;
                const goalAchievementRate = salesGoal > 0 ? ((currentSales / salesGoal) * 100).toFixed(1) : 0;

                // Prepare prompt for Gemini
                const prompt = `ã‚ãªãŸã¯ã‚¢ã‚¤ãƒ©ãƒƒã‚·ãƒ¥ã‚µãƒ­ãƒ³ã®çµŒå–¶ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€ç›®æ¨™é”æˆã®ãŸã‚ã®å…·ä½“çš„ãªæ¥­å‹™æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€ç¾åœ¨ã®çŠ¶æ³ã€‘
- å£²ä¸Šç›®æ¨™: Â¥${salesGoal.toLocaleString()}
- ç¾åœ¨ã®å£²ä¸Š: Â¥${currentSales.toLocaleString()}
- é”æˆç‡: ${goalAchievementRate}%
- ç·æ¥åº—æ•°: ${metrics.customersTotal}å
- æ–°è¦å®¢: ${metrics.customersNew}å
- æ—¢å­˜å®¢: ${metrics.customersExisting}å
- å¹³å‡å®¢å˜ä¾¡: Â¥${metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal).toLocaleString() : 0}
- HPBæ–°è¦æ¬¡å›äºˆç´„ç‡: ${metrics.hpbNewCount > 0 ? ((metrics.nextRes.hpbNew / metrics.hpbNewCount)*100).toFixed(1) : 0}%

ã€ç›®æ¨™å€¤ã€‘
- æ–°è¦å®¢ç›®æ¨™: ${goalData.newCustomers}å
- æ—¢å­˜å®¢ç›®æ¨™: ${goalData.existingCustomers}å
- ç›®æ¨™å®¢å˜ä¾¡: Â¥${goalData.unitPrice.toLocaleString()}
- HPBæ–°è¦æ¬¡å›äºˆç´„ç‡ç›®æ¨™: ${goalData.newReservationRate}%

ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦ã€å…·ä½“çš„ã‹ã¤å®Ÿè¡Œå¯èƒ½ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’3ã€œ5é …ç›®ã§æä¾›ã—ã¦ãã ã•ã„ï¼š
1. å£²ä¸Šã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã®æ–½ç­–
2. æ–°è¦ãƒ»æ—¢å­˜å®¢ç²å¾—ã®ãŸã‚ã®å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
3. å®¢å˜ä¾¡å‘ä¸Šã®æ–¹æ³•
4. æ¬¡å›äºˆç´„ç‡ã‚’é«˜ã‚ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ä¾‹ã‚„æ–½ç­–
5. ãã®ä»–ã€ç›®æ¨™é”æˆã«å¿…è¦ãªæ”¹å–„ç‚¹

â€»ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ç®‡æ¡æ›¸ãã§ã€ã™ãã«å®Ÿè¡Œã§ãã‚‹å…·ä½“çš„ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚`;

                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const advice = data.candidates[0].content.parts[0].text;
                    displayAIAdvice(advice, goalAchievementRate);
                } else {
                    throw new Error('APIã‹ã‚‰ã®å¿œç­”ãŒä¸æ­£ã§ã™');
                }

            } catch (error) {
                console.error(error);
                alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nAPIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function displayAIAdvice(advice, achievementRate) {
            const contentDiv = document.getElementById('ai-advice-content');
            const statusColor = achievementRate >= 100 ? 'green' : achievementRate >= 80 ? 'blue' : achievementRate >= 60 ? 'yellow' : 'red';
            const statusText = achievementRate >= 100 ? 'ç›®æ¨™é”æˆï¼' : achievementRate >= 80 ? 'é †èª¿ã§ã™' : achievementRate >= 60 ? 'è¦æ³¨æ„' : 'æ”¹å–„ãŒå¿…è¦';

            contentDiv.innerHTML = `
                <div class="mb-4 p-4 bg-${statusColor}-50 border-l-4 border-${statusColor}-500 rounded">
                    <div class="flex items-center gap-2">
                        <span class="text-${statusColor}-800 font-bold">ğŸ“Š é”æˆç‡: ${achievementRate}%</span>
                        <span class="text-${statusColor}-600">- ${statusText}</span>
                    </div>
                </div>
                <div class="prose prose-sm max-w-none">
                    <div class="whitespace-pre-wrap text-mavie-800">${advice}</div>
                </div>
                <div class="mt-4 text-xs text-mavie-400 text-right">
                    ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}
                </div>
            `;
        }

        // --- DEVICE MODE TOGGLE ---
        function toggleDeviceMode() {
            const currentMode = localStorage.getItem('deviceMode') || 'mobile';
            const newMode = currentMode === 'mobile' ? 'pc' : 'mobile';

            localStorage.setItem('deviceMode', newMode);
            applyDeviceMode(newMode);
        }

        function applyDeviceMode(mode) {
            const body = document.body;
            const iconEl = document.getElementById('device-icon-lucide');
            const label = document.getElementById('device-label');

            if (mode === 'mobile') {
                body.classList.remove('pc-mode');
                body.classList.add('mobile-mode');
                if (iconEl) iconEl.setAttribute('data-lucide', 'smartphone');
                label.innerText = 'ã‚¹ãƒãƒ›';
                enableMobileAccordions();
            } else {
                body.classList.remove('mobile-mode');
                body.classList.add('pc-mode');
                if (iconEl) iconEl.setAttribute('data-lucide', 'monitor');
                label.innerText = 'PC';
                disableMobileAccordions();
            }
            // Re-render Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function enableMobileAccordions() {
            // Wrap sections in accordions for mobile
            const overviewSection = document.getElementById('content-overview');
            const staffDashboardSection = document.getElementById('content-staff-dashboard');

            if (overviewSection && !overviewSection.dataset.accordionEnabled) {
                wrapSectionInAccordion(overviewSection, 'ã‚µãƒãƒªãƒ¼');
                overviewSection.dataset.accordionEnabled = 'true';
            }

            if (staffDashboardSection && !staffDashboardSection.dataset.accordionEnabled) {
                wrapSectionInAccordion(staffDashboardSection, 'ãƒã‚¤ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰');
                staffDashboardSection.dataset.accordionEnabled = 'true';
            }
        }

        function disableMobileAccordions() {
            // Remove accordion wrappers for PC mode
            document.querySelectorAll('[data-accordion-enabled]').forEach(section => {
                const accordions = section.querySelectorAll('.mobile-accordion-header');
                accordions.forEach(header => {
                    const content = header.nextElementSibling;
                    if (content && content.classList.contains('mobile-accordion-content')) {
                        content.classList.add('open');
                        content.style.maxHeight = 'none';
                    }
                });
            });
        }

        function wrapSectionInAccordion(section, title) {
            const children = Array.from(section.children);
            children.forEach((child, index) => {
                if (!child.classList.contains('mobile-accordion-header') && !child.classList.contains('mobile-accordion-content')) {
                    const header = document.createElement('div');
                    header.className = 'mobile-accordion-header';
                    header.innerHTML = `<span>${child.querySelector('h3')?.textContent || `ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ${index + 1}`}</span><span class="accordion-arrow">â–¼</span>`;

                    const content = document.createElement('div');
                    content.className = 'mobile-accordion-content';
                    content.appendChild(child.cloneNode(true));

                    header.onclick = () => {
                        content.classList.toggle('open');
                        header.querySelector('.accordion-arrow').textContent = content.classList.contains('open') ? 'â–²' : 'â–¼';
                    };

                    child.replaceWith(header, content);
                }
            });
        }

        function initDeviceMode() {
            const savedMode = localStorage.getItem('deviceMode') || 'mobile';
            applyDeviceMode(savedMode);
        }

        // --- CALENDAR VIEW ---
        let currentCalendarDate = new Date();

        function changeCalendarMonth(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            // æœˆè¡¨ç¤ºã‚’æ›´æ–°
            document.getElementById('calendar-month-display').textContent = `${year}å¹´${month + 1}æœˆ`;

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚’ç”Ÿæˆ
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // ç©ºç™½ã‚»ãƒ«ï¼ˆæœˆåˆã®æ›œæ—¥ã¾ã§ï¼‰
            for (let i = 0; i < startingDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'min-h-20 md:min-h-24';
                grid.appendChild(emptyCell);
            }

            // æ—¥åˆ¥å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const filteredData = getFilteredData();
            const dailySalesMap = {};

            filteredData.forEach(record => {
                const recordDate = new Date(record.date);
                if (recordDate.getFullYear() === year && recordDate.getMonth() === month) {
                    const day = recordDate.getDate();
                    if (!dailySalesMap[day]) {
                        dailySalesMap[day] = {
                            sales: 0,
                            customers: 0,
                            newCustomers: 0,
                            existingCustomers: 0,
                            product: 0
                        };
                    }
                    const totalSales = (record.sales?.cash || 0) + (record.sales?.credit || 0) + (record.sales?.qr || 0);
                    const productSales = record.sales?.product || 0;
                    const newCount = (record.customers?.newHPB || 0) + (record.customers?.newMiniNai || 0) +
                                     (record.customers?.referral || 0) + (record.customers?.acquaintance || 0);
                    const existCount = record.customers?.existing || 0;

                    dailySalesMap[day].sales += totalSales;
                    dailySalesMap[day].product += productSales;
                    dailySalesMap[day].newCustomers += newCount;
                    dailySalesMap[day].existingCustomers += existCount;
                    dailySalesMap[day].customers += newCount + existCount;
                }
            });

            // æ—¥ä»˜ã‚»ãƒ«ã‚’ç”Ÿæˆ
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const dayData = dailySalesMap[day];
                const salesAmount = dayData?.sales || 0;
                const colorClass = getSalesColorClass(salesAmount);
                const dayOfWeek = new Date(year, month, day).getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                cell.className = `min-h-20 md:min-h-24 border-2 rounded-lg p-2 cursor-pointer transition-all hover:shadow-md hover:scale-105 ${colorClass}`;
                cell.onclick = () => showDayDetails(year, month, day, dayData);

                const dayNumber = document.createElement('div');
                dayNumber.className = `font-bold text-sm mb-1 ${dayOfWeek === 0 ? 'text-red-500' : dayOfWeek === 6 ? 'text-blue-500' : 'text-mavie-800'}`;
                dayNumber.textContent = day;
                cell.appendChild(dayNumber);

                if (dayData && salesAmount > 0) {
                    const salesDiv = document.createElement('div');
                    salesDiv.className = 'text-xs text-mavie-700 font-bold';
                    salesDiv.textContent = `Â¥${salesAmount.toLocaleString()}`;
                    cell.appendChild(salesDiv);

                    const custDiv = document.createElement('div');
                    custDiv.className = 'text-xs text-mavie-500 mt-1 hidden md:block';
                    custDiv.textContent = `${dayData.customers}å`;
                    cell.appendChild(custDiv);
                } else {
                    const noData = document.createElement('div');
                    noData.className = 'text-xs text-gray-400';
                    noData.textContent = '-';
                    cell.appendChild(noData);
                }

                grid.appendChild(cell);
            }

            // æœˆé–“ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
            updateCalendarSummary(dailySalesMap, daysInMonth);
        }

        function getSalesColorClass(sales) {
            if (!sales || sales === 0) return 'bg-gray-50 border-gray-200';
            if (sales < 50000) return 'bg-blue-50 border-blue-200';
            if (sales < 100000) return 'bg-green-50 border-green-200';
            if (sales < 150000) return 'bg-yellow-50 border-yellow-200';
            if (sales < 200000) return 'bg-orange-50 border-orange-200';
            return 'bg-red-50 border-red-200';
        }

        function showDayDetails(year, month, day, dayData) {
            const detailsSection = document.getElementById('calendar-day-details');
            const titleEl = document.getElementById('calendar-day-title');
            const statsEl = document.getElementById('calendar-day-stats');

            if (!dayData || dayData.sales === 0) {
                detailsSection.classList.add('hidden');
                return;
            }

            detailsSection.classList.remove('hidden');
            titleEl.textContent = `${month + 1}æœˆ${day}æ—¥ã®è©³ç´°`;

            statsEl.innerHTML = `
                <div class="bg-mavie-50 border border-mavie-200 rounded-lg p-3">
                    <p class="text-xs text-mavie-500 mb-1">æ–½è¡“å£²ä¸Š</p>
                    <p class="text-lg font-bold text-mavie-800">Â¥${dayData.sales.toLocaleString()}</p>
                </div>
                <div class="bg-mavie-50 border border-mavie-200 rounded-lg p-3">
                    <p class="text-xs text-mavie-500 mb-1">ç‰©è²©å£²ä¸Š</p>
                    <p class="text-lg font-bold text-mavie-800">Â¥${dayData.product.toLocaleString()}</p>
                </div>
                <div class="bg-mavie-50 border border-mavie-200 rounded-lg p-3">
                    <p class="text-xs text-mavie-500 mb-1">ç·æ¥åº—æ•°</p>
                    <p class="text-lg font-bold text-mavie-800">${dayData.customers}å</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-600 mb-1">æ–°è¦</p>
                    <p class="text-lg font-bold text-blue-800">${dayData.newCustomers}å</p>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p class="text-xs text-green-600 mb-1">æ—¢å­˜</p>
                    <p class="text-lg font-bold text-green-800">${dayData.existingCustomers}å</p>
                </div>
                <div class="bg-mavie-100 border border-mavie-300 rounded-lg p-3">
                    <p class="text-xs text-mavie-500 mb-1">å®¢å˜ä¾¡</p>
                    <p class="text-lg font-bold text-mavie-800">Â¥${dayData.customers > 0 ? Math.round((dayData.sales + dayData.product) / dayData.customers).toLocaleString() : 0}</p>
                </div>
            `;

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è©³ç´°ã‚’è¡¨ç¤º
            detailsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function updateCalendarSummary(dailySalesMap, daysInMonth) {
            const days = Object.keys(dailySalesMap).filter(d => dailySalesMap[d].sales > 0).length;
            const totalSales = Object.values(dailySalesMap).reduce((sum, d) => sum + d.sales + d.product, 0);
            const avgSales = days > 0 ? Math.round(totalSales / days) : 0;
            const maxSales = Math.max(...Object.values(dailySalesMap).map(d => d.sales + d.product), 0);

            document.getElementById('calendar-summary-days').innerHTML = `${days}<span class="text-sm font-normal ml-1">æ—¥</span>`;
            document.getElementById('calendar-summary-sales').textContent = `Â¥${totalSales.toLocaleString()}`;
            document.getElementById('calendar-summary-avg').textContent = `Â¥${avgSales.toLocaleString()}`;
            document.getElementById('calendar-summary-max').textContent = `Â¥${maxSales.toLocaleString()}`;
        }

        // --- DARK MODE TOGGLE ---
        function toggleDarkMode() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('darkMode', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('darkMode', 'dark');
            }
            updateDarkModeUI();
            updateChartsForDarkMode();
        }

        function updateDarkModeUI() {
            const isDark = document.documentElement.classList.contains('dark');
            const iconEl = document.getElementById('dark-mode-icon-lucide');
            const label = document.getElementById('dark-mode-label');
            const btn = document.getElementById('dark-mode-toggle');

            if (isDark) {
                if (iconEl) iconEl.setAttribute('data-lucide', 'sun');
                if (label) label.innerText = 'ãƒ©ã‚¤ãƒˆ';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                if (iconEl) iconEl.setAttribute('data-lucide', 'moon');
                if (label) label.innerText = 'ãƒ€ãƒ¼ã‚¯';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
            // Re-render Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function updateChartsForDarkMode() {
            const isDark = document.documentElement.classList.contains('dark');

            // Chart.js ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’æ›´æ–° - æ–°ã—ã„ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
            if (window.Chart) {
                const textColor = isDark ? '#e8e6e1' : '#334e68';
                const gridColor = isDark ? '#3a3e42' : '#e8e6e1';

                Chart.defaults.color = textColor;
                Chart.defaults.borderColor = gridColor;

                // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                Object.values(charts).forEach(chart => {
                    if (chart && chart.options) {
                        // ã‚¹ã‚±ãƒ¼ãƒ«ã®è‰²ã‚’æ›´æ–°
                        if (chart.options.scales) {
                            Object.values(chart.options.scales).forEach(scale => {
                                if (scale.ticks) scale.ticks.color = textColor;
                                if (scale.grid) scale.grid.color = gridColor;
                            });
                        }
                        // å‡¡ä¾‹ã®è‰²ã‚’æ›´æ–°
                        if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                            chart.options.plugins.legend.labels.color = textColor;
                        }
                        chart.update();
                    }
                });
            }
        }

        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateDarkModeUI();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            initDarkMode(); // Initialize dark mode
            initDeviceMode(); // Initialize device mode
            initCharts();
            loadData();
            calculateGoal(); // Initialize goal calculation

            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ãƒãƒ£ãƒ¼ãƒˆã‚’åˆæœŸåŒ–ã—ãŸå¾Œã«æ›´æ–°
            setTimeout(() => updateChartsForDarkMode(), 100);
        });
    </script>
</body>
</html>
