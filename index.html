<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mavie | Salon Management Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mavie: {
                            gold: '#b49a79', brown: '#604d39', 50: '#fbf9f6', 100: '#f5f0eb', 
                            200: '#eaddcf', 300: '#d4c0a5', 400: '#b49a79', 800: '#604d39', 900: '#4a3b2c'
                        }
                    },
                    fontFamily: {
                        sans: ['"Helvetica Neue"', 'Arial', 'sans-serif'],
                        serif: ['"Playfair Display"', 'Georgia', 'serif'], 
                    }
                }
            }
        }
    </script>

    <!-- Placeholder Comments -->
    <!-- Update: 
         1. Overview Chart now shows Unit Price (Line) and New/Existing Customers (Stacked Bar).
         2. Added 'Incentive' KPI card that appears only when a specific staff is selected.
    -->

    <style>
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f5f0eb; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #b49a79; border-radius: 4px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        select:disabled { background-color: #f3f4f6; color: #9ca3af; cursor: not-allowed; border-color: #e5e7eb; }
        
        /* Edit Table Styles */
        .edit-input { width: 100%; min-width: 60px; padding: 4px; border: 1px solid #eaddcf; border-radius: 4px; text-align: right; font-size: 0.875rem; }
        .edit-input:focus { outline: none; border-color: #b49a79; ring: 2px solid #b49a79; }
        .edit-readonly { background-color: #f9fafb; color: #6b7280; border: none; }
        .changed-row { background-color: #fff7ed; } /* Highlight rows with changes */
    </style>
</head>
<body class="bg-mavie-50 text-mavie-800 font-sans antialiased">

    <!-- Main App Container -->
    <div class="min-h-screen flex flex-col">
        
        <!-- Header Section -->
        <header class="bg-white shadow-sm border-b border-mavie-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Logo -->
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-mavie-800 text-white rounded-sm flex items-center justify-center text-xl font-serif tracking-widest">M</div>
                    <div>
                        <h1 class="text-2xl font-serif font-bold text-mavie-800 tracking-wide uppercase flex items-center gap-2">
                            Mavie
                            <span id="staff-mode-badge" class="hidden text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full font-sans normal-case tracking-normal">専用モード</span>
                        </h1>
                        <p class="text-xs text-mavie-400 font-medium tracking-widest uppercase">Eyelash Salon Dashboard</p>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Store Selector -->
                    <div class="relative">
                        <select id="store-selector" onchange="handleStoreChange()" class="appearance-none bg-mavie-100 border border-mavie-300 text-mavie-800 py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 font-medium text-sm cursor-pointer min-w-[140px]">
                            <option value="all">全店舗</option>
                            <option value="chiba">千葉店</option>
                            <option value="honatsugi">本厚木店</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-mavie-800">▼</div>
                    </div>

                    <!-- Staff Selector -->
                    <div class="relative">
                        <select id="staff-selector" onchange="updateDashboard()" class="appearance-none bg-white border border-mavie-300 text-mavie-800 py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 font-medium text-sm cursor-pointer min-w-[140px] disabled:opacity-50 disabled:bg-gray-100">
                            <option value="all">店舗合計</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-mavie-800">▼</div>
                    </div>
                    
                    <!-- Date Selector (Year/Month) -->
                    <div class="relative">
                        <select id="date-selector" onchange="handleDateChange()" class="appearance-none bg-white border border-mavie-200 text-mavie-800 py-2 pl-4 pr-8 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 font-medium text-sm cursor-pointer shadow-sm min-w-[140px]">
                            <!-- JS Populated (2024-2030) -->
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-mavie-800">▼</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8" id="kpi-grid">
                <!-- Sales -->
                <div class="bg-white p-6 rounded shadow-sm border-t-4 border-mavie-400">
                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">総売上</p>
                    <h2 class="text-2xl font-serif font-bold text-mavie-800" id="kpi-sales">¥0</h2>
                    <div class="mt-2 text-xs text-mavie-500">目標比: <span id="kpi-goal-ratio">0%</span></div>
                </div>
                <!-- Customers -->
                <div class="bg-white p-6 rounded shadow-sm border-t-4 border-mavie-800">
                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">総来店数</p>
                    <h2 class="text-2xl font-serif font-bold text-mavie-800" id="kpi-customers">0<span class="text-base font-sans font-normal ml-1">名</span></h2>
                    <div class="mt-2 text-xs text-mavie-500">新規: <span id="kpi-new" class="font-bold">0</span> / 既存: <span id="kpi-existing" class="font-bold">0</span></div>
                </div>
                <!-- Unit Price -->
                <div class="bg-white p-6 rounded shadow-sm border-t-4 border-mavie-300">
                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">平均客単価</p>
                    <h2 class="text-2xl font-serif font-bold text-mavie-800" id="kpi-unit-price">¥0</h2>
                    <div class="mt-2 text-xs text-mavie-500">物販込み平均</div>
                </div>
                <!-- HPB Rate -->
                <div class="bg-white p-6 rounded shadow-sm border-t-4 border-mavie-800">
                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">新規次回予約率 (HPB)</p>
                    <h2 class="text-2xl font-serif font-bold text-mavie-800" id="kpi-hpb-rate">0%</h2>
                    <p class="text-xs text-mavie-500 mt-2">※minimo/ネイリー除外</p>
                </div>
                
                <!-- Incentive Card (Hidden by default, shown when staff selected) -->
                <div id="kpi-incentive-card" class="hidden bg-gradient-to-br from-mavie-800 to-mavie-900 p-6 rounded shadow-sm text-white">
                    <p class="text-xs font-bold text-mavie-200 uppercase tracking-wider mb-1">推定インセンティブ</p>
                    <h2 class="text-2xl font-serif font-bold text-white" id="val-incentive">¥0</h2>
                    <p class="text-xs text-mavie-300 mt-2">※今月の推定獲得額</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="mb-8 border-b border-mavie-200">
                <nav class="flex space-x-6 overflow-x-auto">
                    <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn py-4 px-1 border-b-2 border-mavie-800 font-medium text-sm text-mavie-800">サマリー</button>
                    <!-- Staff Dashboard Tab (shown only when staff is selected) -->
                    <button onclick="switchTab('staff-dashboard')" id="tab-staff-dashboard" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-400 hidden">
                        <span class="text-lg">👤</span> マイダッシュボード
                    </button>
                    <button onclick="switchTab('customers')" id="tab-customers" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-400">顧客・媒体分析</button>
                    <button onclick="switchTab('sales')" id="tab-sales" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-400">売上詳細</button>
                    <button onclick="switchTab('kpi')" id="tab-kpi" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-400">KPI・日報</button>
                    <!-- Goal Setting Tab -->
                    <button onclick="switchTab('goal')" id="tab-goal" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-400 flex items-center gap-1">
                        <span class="text-lg">🎯</span> 売上目標設定
                    </button>
                    <!-- Edit Tab -->
                    <button onclick="switchTab('edit')" id="tab-edit" class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-mavie-800 flex items-center gap-1">
                        <span class="text-lg">✎</span> データ編集
                    </button>
                </nav>
            </div>

            <!-- TAB: OVERVIEW -->
            <section id="content-overview" class="tab-content block space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6">客単価・来店内訳推移</h3>
                    <p class="text-xs text-mavie-500 mb-4">棒グラフ: 新規/既存の内訳 (右軸) | 折れ線: 平均客単価 (左軸)</p>
                    <div class="chart-container"><canvas id="overviewChart"></canvas></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">新規 vs 既存</h3>
                        <div class="flex items-center gap-6">
                            <div class="chart-container h-64 flex-1"><canvas id="customerRatioChart"></canvas></div>
                            <div class="flex-1 space-y-4">
                                <div class="bg-mavie-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-mavie-500">新規</span><span class="font-bold" id="ratio-new-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-mavie-400 h-1.5" id="bar-new-rate" style="width:0%"></div></div>
                                </div>
                                <div class="bg-mavie-50 p-3 rounded">
                                    <div class="flex justify-between text-sm"><span class="text-mavie-500">既存</span><span class="font-bold" id="ratio-exist-count">0</span></div>
                                    <div class="w-full bg-white h-1.5 mt-1"><div class="bg-mavie-800 h-1.5" id="bar-exist-rate" style="width:0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">新規媒体シェア</h3>
                        <div class="chart-container h-64"><canvas id="channelShareChart"></canvas></div>
                        <div class="mt-4 flex justify-center gap-4 text-xs text-mavie-500">
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-mavie-400"></span>HPB</div>
                             <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-mavie-300"></span>minimo/Nailie</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: STAFF DASHBOARD -->
            <section id="content-staff-dashboard" class="tab-content hidden space-y-8 animate-fade-in">
                <!-- Header with Staff Name -->
                <div class="bg-gradient-to-r from-mavie-800 to-mavie-900 text-white p-6 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-4xl">👤</span>
                            <div>
                                <h2 class="text-2xl font-serif font-bold" id="staff-dashboard-name">スタッフ名</h2>
                                <p class="text-xs text-mavie-200 mt-1">個人と店舗全体の比較ダッシュボード</p>
                            </div>
                        </div>
                        <button onclick="generateStaffURL()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 transition">
                            <span>🔗</span> 専用URLをコピー
                        </button>
                    </div>
                </div>

                <!-- Comparison Grid: Personal vs Store -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Personal Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-mavie-400 overflow-hidden">
                        <div class="bg-mavie-400 text-white px-6 py-4">
                            <h3 class="text-lg font-serif font-bold flex items-center gap-2">
                                <span>👤</span> あなたの実績
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Sales -->
                            <div class="bg-mavie-50 p-4 rounded">
                                <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">総売上</p>
                                <h3 class="text-3xl font-serif font-bold text-mavie-800" id="staff-personal-sales">¥0</h3>
                                <div class="mt-2 text-xs text-mavie-600">
                                    目標: <span id="staff-personal-goal" class="font-bold">¥1,100,000</span>
                                    <span class="ml-2">達成率: <span id="staff-personal-goal-rate" class="font-bold text-mavie-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-mavie-600">総来店数</span>
                                    <span class="text-xl font-bold text-mavie-800" id="staff-personal-customers">0名</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">新規</span>
                                    <div>
                                        <span id="staff-personal-new" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-personal-new-goal" class="font-bold text-mavie-600">30</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">既存</span>
                                    <div>
                                        <span id="staff-personal-existing" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-personal-existing-goal" class="font-bold text-mavie-600">90</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">客単価</span>
                                    <div>
                                        <span id="staff-personal-unit-price" class="font-bold text-mavie-800">¥0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-personal-unit-price-goal" class="font-bold text-mavie-600">¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">新規次回予約率</span>
                                    <div>
                                        <span id="staff-personal-new-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-personal-new-res-rate-goal" class="font-bold text-mavie-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">次回予約率</span>
                                    <div>
                                        <span id="staff-personal-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-personal-res-rate-goal" class="font-bold text-mavie-600">70%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Store Total Metrics -->
                    <div class="bg-white rounded-lg shadow-lg border-2 border-mavie-800 overflow-hidden">
                        <div class="bg-mavie-800 text-white px-6 py-4">
                            <h3 class="text-lg font-serif font-bold flex items-center gap-2">
                                <span>🏢</span> 店舗全体の実績
                            </h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- Sales -->
                            <div class="bg-mavie-50 p-4 rounded">
                                <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-1">総売上</p>
                                <h3 class="text-3xl font-serif font-bold text-mavie-800" id="staff-store-sales">¥0</h3>
                                <div class="mt-2 text-xs text-mavie-600">
                                    目標: <span id="staff-store-goal" class="font-bold">¥3,000,000</span>
                                    <span class="ml-2">達成率: <span id="staff-store-goal-rate" class="font-bold text-mavie-800">0%</span></span>
                                </div>
                            </div>

                            <!-- Customers -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-mavie-600">総来店数</span>
                                    <span class="text-xl font-bold text-mavie-800" id="staff-store-customers">0名</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">新規</span>
                                    <div>
                                        <span id="staff-store-new" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-store-new-goal" class="font-bold text-mavie-600">100</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">既存</span>
                                    <div>
                                        <span id="staff-store-existing" class="font-bold text-mavie-800">0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-store-existing-goal" class="font-bold text-mavie-600">300</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">客単価</span>
                                    <div>
                                        <span id="staff-store-unit-price" class="font-bold text-mavie-800">¥0</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-store-unit-price-goal" class="font-bold text-mavie-600">¥9,000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Reservation Rates -->
                            <div class="border-t border-mavie-200 pt-4 space-y-3">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">新規次回予約率</span>
                                    <div>
                                        <span id="staff-store-new-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-store-new-res-rate-goal" class="font-bold text-mavie-600">50%</span>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-mavie-600">次回予約率</span>
                                    <div>
                                        <span id="staff-store-res-rate" class="font-bold text-mavie-800">0%</span>
                                        <span class="text-mavie-400"> / 目標: </span>
                                        <span id="staff-store-res-rate-goal" class="font-bold text-mavie-600">70%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Incentive Details -->
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6 flex items-center gap-2">
                        <span>💰</span> インセンティブ詳細
                    </h3>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-mavie-800 to-mavie-900 text-white p-4 rounded-lg">
                            <p class="text-xs font-bold text-mavie-200 uppercase mb-1">今月の推定インセンティブ</p>
                            <div class="text-3xl font-serif font-bold" id="staff-incentive-total">¥0</div>
                        </div>

                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">基本給</span>
                                <span class="font-bold text-mavie-800" id="staff-incentive-base">¥0</span>
                            </div>
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">施術売上 (5%)</span>
                                <div class="text-right">
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-service-sales">施術売上: ¥0</div>
                                    <span class="font-bold text-mavie-800" id="staff-incentive-service">¥0</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                <span class="text-mavie-600">物販インセンティブ</span>
                                <div class="text-right">
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-retail-sales">物販売上: ¥0</div>
                                    <div class="text-mavie-500 text-xs" id="staff-incentive-retail-rate">(5%適用)</div>
                                    <span class="font-bold text-mavie-800" id="staff-incentive-retail">¥0</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-400">
                            <p class="text-xs font-bold text-blue-800 mb-1">📊 計算式</p>
                            <p class="text-xs text-blue-600">
                                基本給 + 施術売上×5% + 物販インセンティブ<br>
                                <span class="text-blue-500">※物販が10万円以上の場合、物販インセンティブは10%で計算</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Achievement Progress Bars -->
                <div class="bg-white rounded-lg shadow-sm border border-mavie-200 p-6">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-6">目標達成の進捗</h3>
                    <div class="space-y-6">
                        <!-- Sales Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">売上目標</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-sales-percent">0%</span> 達成</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-400 to-mavie-800 h-4 transition-all duration-500" id="staff-progress-sales-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- New Customers Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">新規数目標</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-new-percent">0%</span> 達成</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-300 to-mavie-600 h-4 transition-all duration-500" id="staff-progress-new-bar" style="width:0%"></div>
                            </div>
                        </div>

                        <!-- Existing Customers Progress -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-mavie-600 font-medium">既存数目標</span>
                                <span class="text-mavie-800 font-bold"><span id="staff-progress-existing-percent">0%</span> 達成</span>
                            </div>
                            <div class="w-full bg-mavie-100 h-4 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-mavie-300 to-mavie-600 h-4 transition-all duration-500" id="staff-progress-existing-bar" style="width:0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-mavie-50 p-4 rounded border-l-4 border-mavie-400">
                        <p class="text-xs font-bold text-mavie-800 mb-1">💡 ヒント</p>
                        <p class="text-xs text-mavie-600">このダッシュボードでは、あなたの個人実績と店舗全体の実績を比較できます。目標は「売上目標設定」タブで設定できます。</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-400">
                        <p class="text-xs font-bold text-blue-800 mb-1">🔗 専用URL</p>
                        <p class="text-xs text-blue-600">上部の「専用URLをコピー」ボタンで、このスタッフ専用のURLを取得できます。そのURLでアクセスすると、他のスタッフの詳細は表示されません。</p>
                    </div>
                </div>
            </section>

            <!-- TAB: CUSTOMERS -->
            <section id="content-customers" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                    <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">媒体別 新規集客推移</h3>
                    <div class="chart-container"><canvas id="channelTrendChart"></canvas></div>
                </div>
            </section>

            <!-- TAB: SALES -->
            <section id="content-sales" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">決済方法</h3>
                        <div class="chart-container"><canvas id="paymentChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded p-6 shadow-sm border border-mavie-100">
                        <h3 class="text-lg font-serif font-bold text-mavie-800 mb-4">割引・損失分析</h3>
                        <div class="chart-container"><canvas id="lossChart"></canvas></div>
                        <p class="mt-4 text-right text-sm text-mavie-500">損失合計: <span class="font-bold text-mavie-800 text-lg" id="val-total-loss">¥0</span></p>
                    </div>
                </div>
            </section>

            <!-- TAB: KPI -->
            <section id="content-kpi" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-400"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">新規次回予約率(HPB)</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-400" id="kpi-rate-hpb-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-800"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">既存次回予約率</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-800" id="kpi-rate-exist-lg">0%</div>
                    </div>
                    <div class="bg-white rounded p-6 border border-mavie-200 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-mavie-300"></div>
                        <h4 class="text-sm font-bold text-mavie-800 mb-2">総次回予約率</h4>
                        <div class="text-4xl font-serif font-bold text-mavie-300" id="kpi-rate-total-lg">0%</div>
                    </div>
                </div>
                <div class="bg-white rounded shadow-sm border border-mavie-200 overflow-hidden mt-8">
                    <div class="px-6 py-4 bg-mavie-50 border-b border-mavie-200">
                        <h3 class="text-sm font-bold text-mavie-800 uppercase">Daily Report (直近データ)</h3>
                    </div>
                    <div class="overflow-x-auto custom-scroll">
                        <table class="min-w-full divide-y divide-mavie-200">
                            <thead class="bg-mavie-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">店舗</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">スタッフ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-mavie-800 uppercase">日付</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">売上</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">来店数</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-mavie-800 uppercase">HPB予約率</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-mavie-100" id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- TAB: GOAL SETTING -->
            <section id="content-goal" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-gradient-to-br from-mavie-50 to-white rounded-lg shadow-lg border border-mavie-200 overflow-hidden">
                    <div class="bg-mavie-800 text-white px-6 py-4">
                        <h3 class="text-xl font-serif font-bold flex items-center gap-2">
                            <span class="text-2xl">🎯</span> 売上目標計算ツール
                        </h3>
                        <p class="text-xs text-mavie-200 mt-1">平日と休日の出勤日数を入力して、月間目標を自動計算します</p>
                        <div class="mt-3 pt-3 border-t border-mavie-700">
                            <p class="text-xs font-bold text-mavie-200 mb-1">設定対象:</p>
                            <div class="bg-mavie-900 px-3 py-2 rounded inline-flex items-center gap-2">
                                <span class="text-lg" id="goal-context-icon">👤</span>
                                <span class="font-bold text-sm" id="goal-context-label">個人 (スタッフ名)</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 md:p-8">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Input Form - Column 1: Days & Sales -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">出勤日数・売上</h4>

                                <!-- Weekday Days -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">平日出勤日数</label>
                                    <input type="number" id="goal-weekdays" value="20" min="0" max="31"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">月間の平日出勤日数</p>
                                </div>

                                <!-- Weekend Days -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">休日出勤日数</label>
                                    <input type="number" id="goal-weekends" value="6" min="0" max="31"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">月間の休日出勤日数</p>
                                </div>

                                <!-- Weekday Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">平日の1日あたり目標売上 (円)</label>
                                    <input type="number" id="goal-weekday-target" value="40000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">平日の目標売上額</p>
                                </div>

                                <!-- Weekend Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">休日の1日あたり目標売上 (円)</label>
                                    <input type="number" id="goal-weekend-target" value="50000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">休日の目標売上額</p>
                                </div>

                                <!-- Retail Sales Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">月間物販目標 (円)</label>
                                    <input type="number" id="goal-retail" value="50000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">月間の物販売上目標</p>
                                </div>
                            </div>

                            <!-- Input Form - Column 2: Customer Targets -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">基本給・来店目標</h4>

                                <!-- Base Salary -->
                                <div class="bg-gradient-to-br from-green-50 to-white p-4 rounded border-2 border-green-300">
                                    <label class="block text-sm font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <span>💰</span> 基本給 (円)
                                    </label>
                                    <input type="number" id="goal-base-salary" value="200000" min="0" step="1000"
                                           class="w-full px-4 py-3 border border-green-300 rounded focus:outline-none focus:ring-2 focus:ring-green-400 text-lg font-medium"
                                           onchange="saveBaseSalaryAndCalculate()">
                                    <p class="text-xs text-green-600 mt-1">インセンティブ計算に使用</p>
                                </div>

                                <!-- New Customers Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">月間新規数目標 (名)</label>
                                    <input type="number" id="goal-new-customers" value="30" min="0"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">月間の新規顧客目標数</p>
                                </div>

                                <!-- Existing Customers Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">月間既存数目標 (名)</label>
                                    <input type="number" id="goal-existing-customers" value="90" min="0"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">月間の既存顧客目標数</p>
                                </div>

                                <!-- Unit Price Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">目標客単価 (円)</label>
                                    <input type="number" id="goal-unit-price" value="9000" min="0" step="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">目標とする平均客単価</p>
                                </div>

                                <!-- New Customer Next Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">目標新規次回予約率 (%)</label>
                                    <input type="number" id="goal-new-reservation-rate" value="50" min="0" max="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">新規顧客の次回予約率目標</p>
                                </div>

                                <!-- Overall Reservation Rate Target -->
                                <div class="bg-white p-4 rounded border border-mavie-200">
                                    <label class="block text-sm font-bold text-mavie-800 mb-2">目標次回予約率 (%)</label>
                                    <input type="number" id="goal-reservation-rate" value="70" min="0" max="100"
                                           class="w-full px-4 py-3 border border-mavie-300 rounded focus:outline-none focus:ring-2 focus:ring-mavie-400 text-lg font-medium"
                                           onchange="calculateGoal()">
                                    <p class="text-xs text-mavie-500 mt-1">全体の次回予約率目標</p>
                                </div>

                                <button onclick="calculateGoal()" class="w-full bg-mavie-800 text-white py-3 rounded shadow hover:bg-mavie-900 transition font-bold text-base">
                                    計算する
                                </button>
                            </div>

                            <!-- Results Display -->
                            <div class="space-y-6">
                                <h4 class="text-sm font-bold text-mavie-800 uppercase tracking-wider border-b border-mavie-200 pb-2">計算結果</h4>

                                <div class="bg-gradient-to-br from-mavie-800 to-mavie-900 text-white p-6 rounded-lg shadow-lg">
                                    <p class="text-xs font-bold text-mavie-200 uppercase tracking-wider mb-2">月間売上目標</p>
                                    <div class="text-4xl font-serif font-bold" id="goal-total">¥1,100,000</div>
                                    <div class="mt-4 pt-4 border-t border-mavie-700 space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">平日売上:</span>
                                            <span class="font-bold" id="goal-weekday-total">¥800,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">休日売上:</span>
                                            <span class="font-bold" id="goal-weekend-total">¥300,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-mavie-300">物販目標:</span>
                                            <span class="font-bold" id="goal-retail-display">¥50,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-mavie-200">
                                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-4">売上達成状況</p>
                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span class="text-mavie-600">現在の売上</span>
                                                <span class="font-bold text-mavie-800" id="goal-current-sales">¥0</span>
                                            </div>
                                            <div class="w-full bg-mavie-100 h-3 rounded-full overflow-hidden">
                                                <div class="bg-mavie-400 h-3 transition-all duration-500" id="goal-progress-bar" style="width:0%"></div>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-mavie-500">達成率</span>
                                            <span class="text-2xl font-serif font-bold text-mavie-800" id="goal-percentage">0%</span>
                                        </div>
                                        <div class="flex justify-between items-center pt-4 border-t border-mavie-200">
                                            <span class="text-xs text-mavie-500">目標まで残り</span>
                                            <span class="text-lg font-bold text-mavie-600" id="goal-remaining">¥1,100,000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded border border-mavie-200">
                                    <p class="text-xs font-bold text-mavie-400 uppercase tracking-wider mb-4">来店数・客単価・予約率</p>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">新規数</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-new-current">0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-new-target">30名</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">既存数</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-existing-current">0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-existing-target">90名</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">客単価</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-unit-price-current">¥0</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-unit-price-target">¥9,000</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center border-b border-mavie-100 pb-2">
                                            <span class="text-mavie-600">新規次回予約率</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-new-res-rate-current">0%</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-new-res-rate-target">50%</span>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-mavie-600">次回予約率</span>
                                            <div class="flex gap-2 items-center">
                                                <span class="text-mavie-500" id="goal-res-rate-current">0%</span>
                                                <span class="text-mavie-400">/</span>
                                                <span class="font-bold text-mavie-800" id="goal-res-rate-target">70%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-mavie-50 p-4 rounded border-l-4 border-mavie-400">
                                    <p class="text-xs font-bold text-mavie-800 mb-1">💡 ヒント</p>
                                    <p class="text-xs text-mavie-600" id="goal-hint-text">各項目の目標を設定して、達成状況を確認できます。現在の数値は選択中のスタッフ・店舗のデータから自動計算されます。</p>
                                </div>

                                <div class="bg-green-50 p-4 rounded border-l-4 border-green-500" id="goal-save-notice" style="display:none;">
                                    <p class="text-xs font-bold text-green-800 mb-1">✓ 保存完了</p>
                                    <p class="text-xs text-green-600">目標が自動保存されました。スタッフダッシュボードに反映されます。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: EDIT -->
            <section id="content-edit" class="tab-content hidden space-y-8 animate-fade-in">
                <div class="bg-mavie-100 p-4 rounded border-l-4 border-mavie-800 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div>
                        <p class="text-sm text-mavie-800 font-bold">データ修正モード</p>
                        <p class="text-xs text-mavie-600">修正して「保存」を押すと、スプレッドシート本体が更新されます。</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="applyEditsLocally()" class="bg-white border border-mavie-300 text-mavie-600 px-4 py-2 rounded hover:bg-mavie-50 transition text-sm font-bold">
                            表示のみ更新 (プレビュー)
                        </button>
                        <button onclick="saveToSpreadsheet()" id="btn-save-sheet" class="bg-mavie-800 text-white px-6 py-2 rounded shadow hover:bg-mavie-900 transition text-sm font-bold flex items-center gap-2">
                            <span>☁</span> スプレッドシートに保存
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded shadow-sm border border-mavie-200 overflow-hidden">
                    <div class="overflow-x-auto custom-scroll" style="max-height: 70vh;">
                        <table class="min-w-full divide-y divide-mavie-200" id="edit-table">
                            <thead class="bg-mavie-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">日付</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">店舗</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-mavie-800 whitespace-nowrap">スタッフ</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">売上(現金)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">売上(クレカ)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">売上(QR)</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">HPB新規</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">Mini/Nailie新規</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">HPB予約</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-mavie-800 whitespace-nowrap">既存予約</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-mavie-100" id="edit-table-body">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="bg-mavie-900 text-mavie-300 py-8 mt-12 text-center text-xs">
            <p>&copy; Mavie Eyelash Salon</p>
        </footer>
    </div>

    <!-- Application Logic -->
    <script>
        // ★ IMPORTANT: Set your GAS Web App URL here
        const API_URL = ""; 

        const STAFF_ROSTER = {
            honatsugi: ['haruka', 'vienna'],
            chiba: ['kiki', 'karin', 'nanami', 'kanon', 'ayami', 'miki']
        };

        const BrandColors = {
            gold: '#b49a79', brown: '#604d39', beige: '#d4c0a5', light: '#eaddcf', white: '#ffffff',
            darkBrown: '#4a3b2c'
        };

        let rawData = [];
        let charts = {};
        let lockedStore = null;
        let lockedStaff = null;
        let changedRows = new Set();
        let monthlyGoal = 1100000; // Default goal

        // --- GOAL STORAGE FUNCTIONS ---
        const GOAL_STORAGE_KEY = 'mavie_staff_goals';
        const BASE_SALARY_STORAGE_KEY = 'mavie_staff_base_salary';
        const DEFAULT_GOAL = {
            weekdays: 20,
            weekends: 6,
            weekdayTarget: 40000,
            weekendTarget: 50000,
            retail: 50000,
            newCustomers: 30,
            existingCustomers: 90,
            unitPrice: 9000,
            newReservationRate: 50,
            reservationRate: 70
        };
        const DEFAULT_BASE_SALARY = 200000; // Default base salary

        function loadGoalsFromStorage() {
            const stored = localStorage.getItem(GOAL_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveGoalsToStorage(goals) {
            localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify(goals));
        }

        function getStaffGoal(store, staff) {
            const goals = loadGoalsFromStorage();
            if (goals[store] && goals[store][staff]) {
                return goals[store][staff];
            }
            return { ...DEFAULT_GOAL };
        }

        function saveStaffGoal(store, staff, goalData) {
            const goals = loadGoalsFromStorage();
            if (!goals[store]) goals[store] = {};
            goals[store][staff] = goalData;
            saveGoalsToStorage(goals);
        }

        function getStoreAggregateGoal(store) {
            const goals = loadGoalsFromStorage();
            const staffList = STAFF_ROSTER[store] || [];

            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0
            };

            let staffCount = 0;
            staffList.forEach(staff => {
                const staffGoal = getStaffGoal(store, staff);
                aggregate.weekdays += staffGoal.weekdays;
                aggregate.weekends += staffGoal.weekends;
                aggregate.weekdayTarget += staffGoal.weekdayTarget;
                aggregate.weekendTarget += staffGoal.weekendTarget;
                aggregate.retail += staffGoal.retail;
                aggregate.newCustomers += staffGoal.newCustomers;
                aggregate.existingCustomers += staffGoal.existingCustomers;
                aggregate.unitPrice += staffGoal.unitPrice;
                aggregate.newReservationRate += staffGoal.newReservationRate;
                aggregate.reservationRate += staffGoal.reservationRate;
                staffCount++;
            });

            // Average for rates and unit price
            if (staffCount > 0) {
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getAllStoresAggregateGoal() {
            const goals = loadGoalsFromStorage();
            const allStores = Object.keys(STAFF_ROSTER);

            let aggregate = {
                weekdays: 0,
                weekends: 0,
                weekdayTarget: 0,
                weekendTarget: 0,
                retail: 0,
                newCustomers: 0,
                existingCustomers: 0,
                unitPrice: 0,
                newReservationRate: 0,
                reservationRate: 0
            };

            let staffCount = 0;
            allStores.forEach(store => {
                const staffList = STAFF_ROSTER[store] || [];
                staffList.forEach(staff => {
                    const staffGoal = getStaffGoal(store, staff);
                    aggregate.weekdays += staffGoal.weekdays;
                    aggregate.weekends += staffGoal.weekends;
                    aggregate.weekdayTarget += staffGoal.weekdayTarget;
                    aggregate.weekendTarget += staffGoal.weekendTarget;
                    aggregate.retail += staffGoal.retail;
                    aggregate.newCustomers += staffGoal.newCustomers;
                    aggregate.existingCustomers += staffGoal.existingCustomers;
                    aggregate.unitPrice += staffGoal.unitPrice;
                    aggregate.newReservationRate += staffGoal.newReservationRate;
                    aggregate.reservationRate += staffGoal.reservationRate;
                    staffCount++;
                });
            });

            // Average for rates and unit price
            if (staffCount > 0) {
                aggregate.unitPrice = Math.round(aggregate.unitPrice / staffCount);
                aggregate.newReservationRate = Math.round(aggregate.newReservationRate / staffCount);
                aggregate.reservationRate = Math.round(aggregate.reservationRate / staffCount);
            }

            return aggregate;
        }

        function getCurrentGoalContext() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal !== 'all') {
                return { type: 'staff', store: storeVal, staff: staffVal };
            } else if (storeVal !== 'all') {
                return { type: 'store', store: storeVal };
            } else {
                return { type: 'all' };
            }
        }

        // --- BASE SALARY FUNCTIONS ---
        function loadBaseSalariesFromStorage() {
            const stored = localStorage.getItem(BASE_SALARY_STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveBaseSalariesToStorage(salaries) {
            localStorage.setItem(BASE_SALARY_STORAGE_KEY, JSON.stringify(salaries));
        }

        function getStaffBaseSalary(store, staff) {
            const salaries = loadBaseSalariesFromStorage();
            if (salaries[store] && salaries[store][staff] !== undefined) {
                return salaries[store][staff];
            }
            return DEFAULT_BASE_SALARY;
        }

        function saveStaffBaseSalary(store, staff, salary) {
            const salaries = loadBaseSalariesFromStorage();
            if (!salaries[store]) salaries[store] = {};
            salaries[store][staff] = salary;
            saveBaseSalariesToStorage(salaries);
        }

        // --- INCENTIVE CALCULATION ---
        function calculateIncentive(data, store, staff) {
            // Get base salary
            const baseSalary = getStaffBaseSalary(store, staff);

            // Calculate service sales (cash + credit + qr)
            let serviceSales = 0;
            let retailSales = 0;

            data.forEach(d => {
                serviceSales += d.sales.cash + d.sales.credit + d.sales.qr;
                retailSales += d.sales.product || 0;
            });

            // Incentive from service sales (5%)
            const serviceIncentive = serviceSales * 0.05;

            // Incentive from retail sales (5% if < 100k, 10% if >= 100k)
            const retailIncentive = retailSales >= 100000
                ? retailSales * 0.1
                : retailSales * 0.05;

            // Total incentive = base salary + service incentive + retail incentive
            const totalIncentive = baseSalary + serviceIncentive + retailIncentive;

            return {
                baseSalary,
                serviceSales,
                serviceIncentive,
                retailSales,
                retailIncentive,
                totalIncentive
            };
        }
        
        // --- 0. INIT & DATE SELECTOR ---
        function initDateSelector() {
            const sel = document.getElementById('date-selector');
            const startYear = 2024;
            const endYear = 2030;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;

            for (let y = startYear; y <= endYear; y++) {
                for (let m = 1; m <= 12; m++) {
                    const opt = document.createElement('option');
                    const val = `${y}/${m}`; 
                    opt.value = val;
                    opt.text = `${y}年 ${m}月`;
                    if (y === currentYear && m === currentMonth) opt.selected = true;
                    sel.appendChild(opt);
                }
            }
        }

        function handleDateChange() {
            const dateVal = document.getElementById('date-selector').value;
            if (!API_URL) rawData = generateData(dateVal);
            updateDashboard();
        }

        // --- 1. MOCK DATA ---
        function generateData(yearMonthStr = "2024/1") {
            const data = [];
            const [year, month] = yearMonthStr.split('/').map(Number);
            const daysInMonth = new Date(year, month, 0).getDate();
            let idCounter = 1;

            Object.keys(STAFF_ROSTER).forEach(storeKey => {
                STAFF_ROSTER[storeKey].forEach(staffName => {
                    for (let i = 1; i <= daysInMonth; i++) {
                        if (Math.random() > 0.8) continue;

                        // All values set to 0
                        const salesCash = 0;
                        const salesCredit = 0;
                        const salesQr = 0;
                        const salesProduct = 0;

                        // All customer values set to 0
                        let newHPB = 0;
                        let newMiniNai = 0;
                        const existing = 0;

                        const nextResNewHPB = 0;
                        const nextResMiniNai = 0;
                        const nextResExisting = 0;
                        
                        data.push({
                            id: idCounter++,
                            date: `${year}/${month}/${i}`,
                            store: storeKey,
                            storeName: storeKey === 'chiba' ? '千葉店' : '本厚木店',
                            staff: staffName,
                            sales: { cash: salesCash, credit: salesCredit, qr: salesQr, product: salesProduct },
                            discounts: { hpbPoints: Math.random()>0.9?500:0, hpbGift: 0, other: 0, refund: Math.random()>0.98?3000:0 },
                            customers: { newHPB, newMiniNai, existing },
                            nextRes: { newHPB: nextResNewHPB, newMiniNai: nextResMiniNai, existing: nextResExisting }
                        });
                    }
                });
            });
            return data;
        }

        // --- 2. DATA LOADING ---
        async function loadData() {
            initDateSelector();
            const initialDate = document.getElementById('date-selector').value;

            if (API_URL) {
                try {
                    const response = await fetch(API_URL);
                    rawData = await response.json();
                    rawData = rawData.map((d, i) => ({...d, id: i+1}));
                } catch (e) { console.error("API Error", e); }
            } else {
                rawData = generateData(initialDate);
            }
            
            checkUrlParams();
            updateDashboard();
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const pStore = params.get('store');
            const pStaff = params.get('staff');
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const staffModeBadge = document.getElementById('staff-mode-badge');

            if (pStore && STAFF_ROSTER[pStore]) {
                lockedStore = pStore;
                storeSel.value = pStore;
                storeSel.disabled = true;
                staffSel.innerHTML = '<option value="all">店舗合計</option>';

                if (pStaff && STAFF_ROSTER[pStore].includes(pStaff)) {
                    lockedStaff = pStaff;
                    const opt = document.createElement('option');
                    opt.value = pStaff;
                    opt.text = pStaff;
                    staffSel.appendChild(opt);
                    staffSel.value = pStaff;
                    staffSel.disabled = true;

                    // Show staff mode badge
                    staffModeBadge.classList.remove('hidden');
                    staffModeBadge.innerText = `${pStaff} 専用`;

                    // Hide goal setting tab for staff-specific URLs
                    const goalTab = document.getElementById('tab-goal');
                    if (goalTab) goalTab.style.display = 'none';
                } else {
                    STAFF_ROSTER[pStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            } else {
                handleStoreChange(false);
            }
        }

        function getFilteredData() {
            const storeFilter = document.getElementById('store-selector').value;
            const staffFilter = document.getElementById('staff-selector').value;
            return rawData.filter(d => {
                if (storeFilter !== 'all' && d.store !== storeFilter) return false;
                if (staffFilter !== 'all' && d.staff !== staffFilter) return false;
                return true;
            });
        }

        function calculateMetrics(data) {
            let agg = {
                salesTotal: 0, salesCash: 0, salesCredit: 0, salesQR: 0,
                customersTotal: 0, customersNew: 0, customersExisting: 0,
                newByChannel: { hpb: 0, mininai: 0 },
                nextRes: { hpbNew: 0, mininaiNew: 0, existing: 0, total: 0 },
                hpbNewCount: 0, lossTotal: 0, daily: {}
            };
            data.forEach(d => { if(!agg.daily[d.date]) agg.daily[d.date] = { sales: 0, customers: 0, new: 0, existing: 0, hpb: 0, mininai: 0 }; });

            data.forEach(d => {
                const totalSales = d.sales.cash + d.sales.credit + d.sales.qr;
                agg.salesTotal += totalSales;
                agg.salesCash += d.sales.cash;
                agg.salesCredit += d.sales.credit;
                agg.salesQR += d.sales.qr;
                agg.lossTotal += (d.discounts.hpbPoints + d.discounts.hpbGift + d.discounts.other + d.discounts.refund);
                
                const totalCust = d.customers.newHPB + d.customers.newMiniNai + d.customers.existing;
                const newCust = d.customers.newHPB + d.customers.newMiniNai;
                
                agg.customersTotal += totalCust;
                agg.customersNew += newCust;
                agg.customersExisting += d.customers.existing;
                agg.newByChannel.hpb += d.customers.newHPB;
                agg.newByChannel.mininai += d.customers.newMiniNai;
                
                agg.nextRes.hpbNew += d.nextRes.newHPB;
                agg.nextRes.mininaiNew += d.nextRes.newMiniNai;
                agg.nextRes.existing += d.nextRes.existing;
                agg.nextRes.total += (d.nextRes.newHPB + d.nextRes.newMiniNai + d.nextRes.existing);
                agg.hpbNewCount += d.customers.newHPB;

                if(agg.daily[d.date]) {
                    agg.daily[d.date].sales += totalSales;
                    agg.daily[d.date].customers += totalCust;
                    agg.daily[d.date].new += newCust;
                    agg.daily[d.date].existing += d.customers.existing;
                    agg.daily[d.date].hpb += d.customers.newHPB;
                    agg.daily[d.date].mininai += d.customers.newMiniNai;
                }
            });
            return agg;
        }

        // --- 3. UI LOGIC ---
        function handleStoreChange(isUserAction = true) {
            if (isUserAction && lockedStore) return;
            const storeSel = document.getElementById('store-selector');
            const staffSel = document.getElementById('staff-selector');
            const selectedStore = storeSel.value;

            staffSel.innerHTML = '<option value="all">店舗合計</option>';
            if (selectedStore === 'all') {
                staffSel.disabled = true;
            } else {
                staffSel.disabled = false;
                if(STAFF_ROSTER[selectedStore]){
                    STAFF_ROSTER[selectedStore].forEach(name => {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.text = name;
                        staffSel.appendChild(opt);
                    });
                }
            }
            if(isUserAction) updateDashboard();
        }

        function updateDashboard() {
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);
            const fmt = n => n.toLocaleString();

            // Get current goal based on context
            const context = getCurrentGoalContext();
            let currentGoalData;
            if (context.type === 'staff') {
                currentGoalData = getStaffGoal(context.store, context.staff);
            } else if (context.type === 'store') {
                currentGoalData = getStoreAggregateGoal(context.store);
            } else {
                currentGoalData = getAllStoresAggregateGoal();
            }
            const currentGoal = currentGoalData.weekdays * currentGoalData.weekdayTarget + currentGoalData.weekends * currentGoalData.weekendTarget;
            monthlyGoal = currentGoal; // Update global for backwards compatibility

            document.getElementById('kpi-sales').innerText = `¥${fmt(metrics.salesTotal)}`;
            document.getElementById('kpi-customers').innerHTML = `${fmt(metrics.customersTotal)}<span class="text-base font-normal ml-1">名</span>`;
            document.getElementById('kpi-new').innerText = fmt(metrics.customersNew);
            document.getElementById('kpi-existing').innerText = fmt(metrics.customersExisting);

            // Update goal ratio
            const goalRatio = currentGoal > 0 ? Math.round((metrics.salesTotal / currentGoal) * 100) : 0;
            document.getElementById('kpi-goal-ratio').innerText = `${goalRatio}%`;

            const unitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('kpi-unit-price').innerText = `¥${fmt(unitPrice)}`;

            const hpbRate = metrics.hpbNewCount > 0 ? ((metrics.nextRes.hpbNew / metrics.hpbNewCount)*100).toFixed(1) : 0;
            document.getElementById('kpi-hpb-rate').innerText = `${hpbRate}%`;

            // Incentive Card & Staff Dashboard Tab Logic
            const staffSel = document.getElementById('staff-selector');
            const incCard = document.getElementById('kpi-incentive-card');
            const staffDashboardTab = document.getElementById('tab-staff-dashboard');

            if (staffSel.value !== 'all') {
                incCard.classList.remove('hidden');
                staffDashboardTab.classList.remove('hidden');

                // Calculate real incentive
                const storeVal = document.getElementById('store-selector').value;
                const incentiveData = calculateIncentive(filtered, storeVal, staffSel.value);
                document.getElementById('val-incentive').innerText = `¥${Math.round(incentiveData.totalIncentive).toLocaleString()}`;

                // Update Staff Dashboard
                updateStaffDashboard(staffSel.value, metrics, incentiveData);
            } else {
                incCard.classList.add('hidden');
                staffDashboardTab.classList.add('hidden');
            }

            updateTable(filtered);
            updateCharts(metrics);
            renderEditTable(filtered);
        }

        function updateStaffDashboard(staffName, personalMetrics, incentiveData) {
            const fmt = n => n.toLocaleString();

            // Update staff name
            document.getElementById('staff-dashboard-name').innerText = staffName;

            // Get store total (filter by current store only)
            const storeFilter = document.getElementById('store-selector').value;
            const storeData = rawData.filter(d => storeFilter !== 'all' ? d.store === storeFilter : true);
            const storeMetrics = calculateMetrics(storeData);

            // Get staff goals from storage
            const staffGoalData = getStaffGoal(storeFilter, staffName);
            const salesGoal = staffGoalData.weekdays * staffGoalData.weekdayTarget + staffGoalData.weekends * staffGoalData.weekendTarget;
            const newGoal = staffGoalData.newCustomers;
            const existingGoal = staffGoalData.existingCustomers;
            const unitPriceGoal = staffGoalData.unitPrice;
            const newResRateGoal = staffGoalData.newReservationRate;
            const resRateGoal = staffGoalData.reservationRate;

            // Store goals (aggregate from all staff in store)
            const storeGoalData = getStoreAggregateGoal(storeFilter);
            const storeSalesGoal = storeGoalData.weekdays * storeGoalData.weekdayTarget + storeGoalData.weekends * storeGoalData.weekendTarget;
            const storeNewGoal = storeGoalData.newCustomers;
            const storeExistingGoal = storeGoalData.existingCustomers;

            // Personal metrics
            const personalUnitPrice = personalMetrics.customersTotal > 0 ? Math.round(personalMetrics.salesTotal / personalMetrics.customersTotal) : 0;
            const personalNewResRate = personalMetrics.hpbNewCount > 0 ? ((personalMetrics.nextRes.hpbNew / personalMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const personalResRate = personalMetrics.customersTotal > 0 ? ((personalMetrics.nextRes.total / personalMetrics.customersTotal)*100).toFixed(1) : 0;
            const personalSalesPercent = salesGoal > 0 ? Math.round((personalMetrics.salesTotal / salesGoal) * 100) : 0;

            // Store metrics
            const storeUnitPrice = storeMetrics.customersTotal > 0 ? Math.round(storeMetrics.salesTotal / storeMetrics.customersTotal) : 0;
            const storeNewResRate = storeMetrics.hpbNewCount > 0 ? ((storeMetrics.nextRes.hpbNew / storeMetrics.hpbNewCount)*100).toFixed(1) : 0;
            const storeResRate = storeMetrics.customersTotal > 0 ? ((storeMetrics.nextRes.total / storeMetrics.customersTotal)*100).toFixed(1) : 0;
            const storeSalesPercent = storeSalesGoal > 0 ? Math.round((storeMetrics.salesTotal / storeSalesGoal) * 100) : 0;

            // Update Personal Section
            document.getElementById('staff-personal-sales').innerText = `¥${fmt(personalMetrics.salesTotal)}`;
            document.getElementById('staff-personal-goal').innerText = `¥${fmt(salesGoal)}`;
            document.getElementById('staff-personal-goal-rate').innerText = `${personalSalesPercent}%`;
            document.getElementById('staff-personal-customers').innerText = `${fmt(personalMetrics.customersTotal)}名`;
            document.getElementById('staff-personal-new').innerText = fmt(personalMetrics.customersNew);
            document.getElementById('staff-personal-new-goal').innerText = newGoal;
            document.getElementById('staff-personal-existing').innerText = fmt(personalMetrics.customersExisting);
            document.getElementById('staff-personal-existing-goal').innerText = existingGoal;
            document.getElementById('staff-personal-unit-price').innerText = `¥${fmt(personalUnitPrice)}`;
            document.getElementById('staff-personal-unit-price-goal').innerText = `¥${fmt(unitPriceGoal)}`;
            document.getElementById('staff-personal-new-res-rate').innerText = `${personalNewResRate}%`;
            document.getElementById('staff-personal-new-res-rate-goal').innerText = `${newResRateGoal}%`;
            document.getElementById('staff-personal-res-rate').innerText = `${personalResRate}%`;
            document.getElementById('staff-personal-res-rate-goal').innerText = `${resRateGoal}%`;

            // Update Store Section
            document.getElementById('staff-store-sales').innerText = `¥${fmt(storeMetrics.salesTotal)}`;
            document.getElementById('staff-store-goal').innerText = `¥${fmt(storeSalesGoal)}`;
            document.getElementById('staff-store-goal-rate').innerText = `${storeSalesPercent}%`;
            document.getElementById('staff-store-customers').innerText = `${fmt(storeMetrics.customersTotal)}名`;
            document.getElementById('staff-store-new').innerText = fmt(storeMetrics.customersNew);
            document.getElementById('staff-store-new-goal').innerText = storeNewGoal;
            document.getElementById('staff-store-existing').innerText = fmt(storeMetrics.customersExisting);
            document.getElementById('staff-store-existing-goal').innerText = storeExistingGoal;
            document.getElementById('staff-store-unit-price').innerText = `¥${fmt(storeUnitPrice)}`;
            document.getElementById('staff-store-unit-price-goal').innerText = `¥${fmt(unitPriceGoal)}`;
            document.getElementById('staff-store-new-res-rate').innerText = `${storeNewResRate}%`;
            document.getElementById('staff-store-new-res-rate-goal').innerText = `${newResRateGoal}%`;
            document.getElementById('staff-store-res-rate').innerText = `${storeResRate}%`;
            document.getElementById('staff-store-res-rate-goal').innerText = `${resRateGoal}%`;

            // Update Progress Bars
            const newPercent = newGoal > 0 ? Math.min(Math.round((personalMetrics.customersNew / newGoal) * 100), 100) : 0;
            const existingPercent = existingGoal > 0 ? Math.min(Math.round((personalMetrics.customersExisting / existingGoal) * 100), 100) : 0;

            document.getElementById('staff-progress-sales-percent').innerText = personalSalesPercent;
            document.getElementById('staff-progress-sales-bar').style.width = `${Math.min(personalSalesPercent, 100)}%`;
            document.getElementById('staff-progress-new-percent').innerText = newPercent;
            document.getElementById('staff-progress-new-bar').style.width = `${newPercent}%`;
            document.getElementById('staff-progress-existing-percent').innerText = existingPercent;
            document.getElementById('staff-progress-existing-bar').style.width = `${existingPercent}%`;

            // Update Incentive Details
            if (incentiveData) {
                document.getElementById('staff-incentive-total').innerText = `¥${Math.round(incentiveData.totalIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-base').innerText = `¥${incentiveData.baseSalary.toLocaleString()}`;
                document.getElementById('staff-incentive-service-sales').innerText = `施術売上: ¥${Math.round(incentiveData.serviceSales).toLocaleString()}`;
                document.getElementById('staff-incentive-service').innerText = `¥${Math.round(incentiveData.serviceIncentive).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-sales').innerText = `物販売上: ¥${Math.round(incentiveData.retailSales).toLocaleString()}`;
                document.getElementById('staff-incentive-retail-rate').innerText = incentiveData.retailSales >= 100000 ? '(10%適用)' : '(5%適用)';
                document.getElementById('staff-incentive-retail').innerText = `¥${Math.round(incentiveData.retailIncentive).toLocaleString()}`;
            }
        }

        function updateTable(data) {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 20);

            sorted.forEach(d => {
                const total = d.sales.cash + d.sales.credit + d.sales.qr;
                const hpbRate = d.customers.newHPB > 0 ? Math.round((d.nextRes.newHPB/d.customers.newHPB)*100) : '-';
                const storeLabel = d.store === 'chiba' ? '千葉店' : '本厚木店';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-xs font-bold text-mavie-800">${storeLabel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-mavie-600">${d.staff}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-mavie-500">${d.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right font-medium text-mavie-800">¥${total.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right text-mavie-600">${d.customers.newHPB + d.customers.newMiniNai + d.customers.existing}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-right ${hpbRate < 40 && hpbRate !== '-' ? 'text-red-400' : ''}">${hpbRate !== '-' ? hpbRate+'%' : '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 4. CHARTS ---
        function initCharts() {
            const common = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: {family: 'sans-serif'} } } } };
            
            // Overview Chart: Line (Unit Price) + Stacked Bar (New/Existing)
            charts.overview = new Chart(document.getElementById('overviewChart'), {
                type: 'bar', // Base type
                data: {},
                options: {
                    ...common,
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { 
                            type: 'linear', position: 'left', 
                            title: { display: true, text: '単価 (¥)' },
                            grid: { display: false } 
                        },
                        y1: { 
                            type: 'linear', position: 'right', stacked: true,
                            title: { display: true, text: '来店数 (名)' },
                            grid: { borderDash: [4, 4], color: '#eaddcf' } 
                        }
                    }
                }
            });

            charts.ratio = new Chart(document.getElementById('customerRatioChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '70%' } });
            charts.share = new Chart(document.getElementById('channelShareChart'), { type: 'pie', data: {}, options: common });
            charts.trend = new Chart(document.getElementById('channelTrendChart'), { type: 'bar', data: {}, options: { ...common, scales: { x:{stacked:true}, y:{stacked:true} } } });
            charts.payment = new Chart(document.getElementById('paymentChart'), { type: 'doughnut', data: {}, options: { ...common, cutout: '60%' } });
            charts.loss = new Chart(document.getElementById('lossChart'), { type: 'bar', indexAxis: 'y', data: {}, options: common });
        }

        function updateCharts(metrics) {
            const labels = Object.keys(metrics.daily).sort((a,b) => new Date(a) - new Date(b));
            const d = metrics.daily;
            
            // Calculate Daily Unit Price
            const unitPriceData = labels.map(k => {
                const totalCust = d[k].customers;
                return totalCust > 0 ? Math.round(d[k].sales / totalCust) : 0;
            });

            // Update Overview Chart
            charts.overview.data = { 
                labels: labels, 
                datasets: [
                    {
                        type: 'line',
                        label: '平均客単価',
                        data: unitPriceData,
                        borderColor: BrandColors.brown,
                        backgroundColor: BrandColors.brown,
                        borderWidth: 2,
                        tension: 0.3,
                        yAxisID: 'y',
                        pointRadius: 2
                    },
                    {
                        type: 'bar',
                        label: '新規来店',
                        data: labels.map(k => d[k].new),
                        backgroundColor: BrandColors.gold,
                        yAxisID: 'y1',
                        stack: 'visits'
                    },
                    {
                        type: 'bar',
                        label: '既存来店',
                        data: labels.map(k => d[k].existing),
                        backgroundColor: BrandColors.beige,
                        yAxisID: 'y1',
                        stack: 'visits'
                    }
                ]
            }; 
            charts.overview.update();

            charts.ratio.data = { labels: ['新規', '既存'], datasets: [{ data: [metrics.customersNew, metrics.customersExisting], backgroundColor: [BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.ratio.update();
            charts.share.data = { labels: ['HPB', 'minimo/Nailie'], datasets: [{ data: [metrics.newByChannel.hpb, metrics.newByChannel.mininai], backgroundColor: [BrandColors.gold, BrandColors.beige], borderWidth:1, borderColor:'#fff' }] }; charts.share.update();
            charts.trend.data = { labels: labels, datasets: [
                { label: 'HPB', data: labels.map(k=>d[k].hpb), backgroundColor: BrandColors.gold },
                { label: 'minimo/Nailie', data: labels.map(k=>d[k].mininai), backgroundColor: BrandColors.beige }
            ]}; charts.trend.update();
            charts.payment.data = { labels: ['現金', 'クレカ', 'QR'], datasets: [{ data: [metrics.salesCash, metrics.salesCredit, metrics.salesQR], backgroundColor: [BrandColors.beige, BrandColors.gold, BrandColors.brown], borderWidth:0 }] }; charts.payment.update();
            charts.loss.data = { labels: ['損失'], datasets: [{ label: '割引・返金', data: [metrics.lossTotal], backgroundColor: BrandColors.brown, barThickness:40 }] }; charts.loss.update();
        }

        // --- 5. EDIT & SAVE LOGIC ---
        function renderEditTable(data) {
            const tbody = document.getElementById('edit-table-body');
            tbody.innerHTML = '';
            const sorted = [...data].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                tr.dataset.id = row.id;
                if (changedRows.has(row.id)) tr.classList.add('changed-row');

                tr.innerHTML = `
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.date}" readonly></td>
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.storeName}" readonly></td>
                    <td class="px-4 py-2"><input type="text" class="edit-input edit-readonly" value="${row.staff}" readonly></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.cash" value="${row.sales.cash}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.credit" value="${row.sales.credit}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="sales.qr" value="${row.sales.qr}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newHPB" value="${row.customers.newHPB}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="customers.newMiniNai" value="${row.customers.newMiniNai}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.newHPB" value="${row.nextRes.newHPB}" onchange="markChanged(${row.id})"></td>
                    <td class="px-4 py-2"><input type="number" class="edit-input" data-field="nextRes.existing" value="${row.nextRes.existing}" onchange="markChanged(${row.id})"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function markChanged(id) {
            changedRows.add(id);
            const row = document.querySelector(`tr[data-id='${id}']`);
            if(row) row.classList.add('changed-row');
        }

        function applyEditsLocally() {
            const inputs = document.querySelectorAll('#edit-table-body input:not([readonly])');
            inputs.forEach(input => {
                const tr = input.closest('tr');
                const id = parseInt(tr.dataset.id);
                if (!changedRows.has(id)) return;
                
                const fieldPath = input.dataset.field.split('.');
                const val = parseInt(input.value) || 0;
                const item = rawData.find(d => d.id === id);
                if (item && fieldPath.length === 2) {
                    item[fieldPath[0]][fieldPath[1]] = val;
                }
            });
            alert("表示を更新しました (未保存)");
            updateDashboard();
        }

        async function saveToSpreadsheet() {
            if (!API_URL) {
                alert("API URLが設定されていないため、保存できません。GASをデプロイしてください。");
                applyEditsLocally();
                return;
            }

            const btn = document.getElementById('btn-save-sheet');
            const originalText = btn.innerHTML;
            btn.innerHTML = "保存中...";
            btn.disabled = true;

            applyEditsLocally(); 
            const modifiedData = rawData.filter(d => changedRows.has(d.id));
            
            if (modifiedData.length === 0) {
                alert("変更されたデータがありません");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify({
                        action: "update",
                        rows: modifiedData
                    })
                });
                
                const result = await response.json();
                
                if (result.status === "success") {
                    alert("スプレッドシートへの保存が完了しました！");
                    changedRows.clear();
                    renderEditTable(getFilteredData());
                } else {
                    alert("保存エラー: " + result.message);
                }

            } catch (e) {
                console.error(e);
                alert("通信エラーが発生しました。コンソールを確認してください。");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- 6. GOAL CALCULATOR ---
        function loadGoalInputs() {
            const context = getCurrentGoalContext();
            let goalData;

            // Update context display
            const contextIcon = document.getElementById('goal-context-icon');
            const contextLabel = document.getElementById('goal-context-label');

            if (context.type === 'staff') {
                goalData = getStaffGoal(context.store, context.staff);
                contextIcon.innerText = '👤';
                contextLabel.innerText = `個人: ${context.staff} (${context.store === 'chiba' ? '千葉店' : '本厚木店'})`;
            } else if (context.type === 'store') {
                goalData = getStoreAggregateGoal(context.store);
                contextIcon.innerText = '🏢';
                contextLabel.innerText = `店舗合計: ${context.store === 'chiba' ? '千葉店' : '本厚木店'} (所属スタッフの合算)`;
            } else {
                goalData = getAllStoresAggregateGoal();
                contextIcon.innerText = '🌐';
                contextLabel.innerText = '全店舗合計 (全スタッフの合算)';
            }

            // Load values into inputs
            document.getElementById('goal-weekdays').value = goalData.weekdays;
            document.getElementById('goal-weekends').value = goalData.weekends;
            document.getElementById('goal-weekday-target').value = goalData.weekdayTarget;
            document.getElementById('goal-weekend-target').value = goalData.weekendTarget;
            document.getElementById('goal-retail').value = goalData.retail;
            document.getElementById('goal-new-customers').value = goalData.newCustomers;
            document.getElementById('goal-existing-customers').value = goalData.existingCustomers;
            document.getElementById('goal-unit-price').value = goalData.unitPrice;
            document.getElementById('goal-new-reservation-rate').value = goalData.newReservationRate;
            document.getElementById('goal-reservation-rate').value = goalData.reservationRate;

            // Load base salary
            if (context.type === 'staff') {
                const baseSalary = getStaffBaseSalary(context.store, context.staff);
                document.getElementById('goal-base-salary').value = baseSalary;
            } else {
                document.getElementById('goal-base-salary').value = DEFAULT_BASE_SALARY;
            }

            // Disable inputs if viewing aggregate (store or all)
            const inputs = document.querySelectorAll('#content-goal input');
            const hintText = document.getElementById('goal-hint-text');

            if (context.type === 'staff') {
                inputs.forEach(input => input.disabled = false);
                hintText.innerHTML = '各項目の目標を設定すると<strong>自動保存</strong>されます。スタッフダッシュボードに反映されます。店舗合計は所属スタッフの目標の<strong>合算値</strong>となります。';
            } else {
                inputs.forEach(input => input.disabled = true);
                if (context.type === 'store') {
                    hintText.innerHTML = '<strong>店舗合計表示中</strong>: この目標は所属スタッフの目標の合算値です。個別のスタッフを選択すると、個人目標を編集できます。';
                } else {
                    hintText.innerHTML = '<strong>全店舗表示中</strong>: この目標は全スタッフの目標の合算値です。個別のスタッフを選択すると、個人目標を編集できます。';
                }
            }

            calculateGoal();
        }

        function saveBaseSalaryAndCalculate() {
            const context = getCurrentGoalContext();
            if (context.type === 'staff') {
                const baseSalary = parseInt(document.getElementById('goal-base-salary').value) || DEFAULT_BASE_SALARY;
                saveStaffBaseSalary(context.store, context.staff, baseSalary);
            }
            calculateGoal();
        }

        function calculateGoal() {
            const weekdays = parseInt(document.getElementById('goal-weekdays').value) || 0;
            const weekends = parseInt(document.getElementById('goal-weekends').value) || 0;
            const weekdayTarget = parseInt(document.getElementById('goal-weekday-target').value) || 0;
            const weekendTarget = parseInt(document.getElementById('goal-weekend-target').value) || 0;
            const retailTarget = parseInt(document.getElementById('goal-retail').value) || 0;
            const newCustomersTarget = parseInt(document.getElementById('goal-new-customers').value) || 0;
            const existingCustomersTarget = parseInt(document.getElementById('goal-existing-customers').value) || 0;
            const unitPriceTarget = parseInt(document.getElementById('goal-unit-price').value) || 0;
            const newResRateTarget = parseInt(document.getElementById('goal-new-reservation-rate').value) || 0;
            const resRateTarget = parseInt(document.getElementById('goal-reservation-rate').value) || 0;

            const weekdayTotal = weekdays * weekdayTarget;
            const weekendTotal = weekends * weekendTarget;
            const totalGoal = weekdayTotal + weekendTotal;

            // Save goal if we're in staff context
            const context = getCurrentGoalContext();
            if (context.type === 'staff') {
                const goalData = {
                    weekdays, weekends, weekdayTarget, weekendTarget,
                    retail: retailTarget,
                    newCustomers: newCustomersTarget,
                    existingCustomers: existingCustomersTarget,
                    unitPrice: unitPriceTarget,
                    newReservationRate: newResRateTarget,
                    reservationRate: resRateTarget
                };
                saveStaffGoal(context.store, context.staff, goalData);

                // Show save notice briefly
                const saveNotice = document.getElementById('goal-save-notice');
                saveNotice.style.display = 'block';
                setTimeout(() => {
                    saveNotice.style.display = 'none';
                }, 2000);
            }

            // Update global goal
            monthlyGoal = totalGoal;

            // Format numbers
            const fmt = n => n.toLocaleString();

            // Update display
            document.getElementById('goal-total').innerText = `¥${fmt(totalGoal)}`;
            document.getElementById('goal-weekday-total').innerText = `¥${fmt(weekdayTotal)}`;
            document.getElementById('goal-weekend-total').innerText = `¥${fmt(weekendTotal)}`;
            document.getElementById('goal-retail-display').innerText = `¥${fmt(retailTarget)}`;

            // Get current metrics
            const filtered = getFilteredData();
            const metrics = calculateMetrics(filtered);

            // Update achievement status - Sales
            const currentSales = metrics.salesTotal;
            const percentage = totalGoal > 0 ? Math.round((currentSales / totalGoal) * 100) : 0;
            const remaining = totalGoal - currentSales;
            const progressWidth = Math.min(percentage, 100);

            document.getElementById('goal-current-sales').innerText = `¥${fmt(currentSales)}`;
            document.getElementById('goal-percentage').innerText = `${percentage}%`;
            document.getElementById('goal-remaining').innerText = `¥${fmt(Math.max(remaining, 0))}`;
            document.getElementById('goal-progress-bar').style.width = `${progressWidth}%`;

            // Update achievement status - Customers & KPIs
            document.getElementById('goal-new-current').innerText = `${fmt(metrics.customersNew)}名`;
            document.getElementById('goal-new-target').innerText = `${fmt(newCustomersTarget)}名`;

            document.getElementById('goal-existing-current').innerText = `${fmt(metrics.customersExisting)}名`;
            document.getElementById('goal-existing-target').innerText = `${fmt(existingCustomersTarget)}名`;

            const currentUnitPrice = metrics.customersTotal > 0 ? Math.round(metrics.salesTotal / metrics.customersTotal) : 0;
            document.getElementById('goal-unit-price-current').innerText = `¥${fmt(currentUnitPrice)}`;
            document.getElementById('goal-unit-price-target').innerText = `¥${fmt(unitPriceTarget)}`;

            const currentNewResRate = metrics.hpbNewCount > 0 ? ((metrics.nextRes.hpbNew / metrics.hpbNewCount)*100).toFixed(1) : 0;
            document.getElementById('goal-new-res-rate-current').innerText = `${currentNewResRate}%`;
            document.getElementById('goal-new-res-rate-target').innerText = `${newResRateTarget}%`;

            const currentResRate = metrics.customersTotal > 0 ? ((metrics.nextRes.total / metrics.customersTotal)*100).toFixed(1) : 0;
            document.getElementById('goal-res-rate-current').innerText = `${currentResRate}%`;
            document.getElementById('goal-res-rate-target').innerText = `${resRateTarget}%`;

            // Update main KPI card
            updateDashboard();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-mavie-800', 'text-mavie-800');
                btn.classList.add('border-transparent', 'text-mavie-400');
            });
            const active = document.getElementById(`tab-${id}`);
            active.classList.remove('border-transparent', 'text-mavie-400');
            active.classList.add('border-mavie-800', 'text-mavie-800');

            // Load goal when switching to goal tab
            if (id === 'goal') {
                loadGoalInputs();
            }
        }

        function generateStaffURL() {
            const storeVal = document.getElementById('store-selector').value;
            const staffVal = document.getElementById('staff-selector').value;

            if (staffVal === 'all') {
                alert('スタッフを選択してください');
                return;
            }

            const baseURL = window.location.origin + window.location.pathname;
            const staffURL = `${baseURL}?store=${storeVal}&staff=${staffVal}`;

            // Copy to clipboard
            navigator.clipboard.writeText(staffURL).then(() => {
                alert(`専用URLをコピーしました！\n\n${staffURL}\n\nこのURLでアクセスすると、${staffVal}専用のビューになります。`);
            }).catch(err => {
                prompt('この専用URLをコピーしてください:', staffURL);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadData();
            calculateGoal(); // Initialize goal calculation
        });
    </script>
</body>
</html>
