# Mavie Dashboard - Google Apps Script 連携設定

## 概要

このGASコードは、Mavieダッシュボードとスプレッドシートを連携させるためのWeb APIを提供します。

## スプレッドシートのシート構成

以下のシート名で作成してください：

| シート名 | 用途 |
|---------|------|
| `フォーム_売上日報` | 日々の売上データ（Googleフォームから自動連携可） |
| `フォーム回答_千葉店` | 千葉店の顧客アンケート回答 |
| `フォーム回答_本厚木店` | 本厚木店の顧客アンケート回答 |
| `目標設定` | 月別目標データ（自動作成） |
| `基本給設定` | スタッフ基本給データ（自動作成） |
| `スタッフパスワード` | スタッフログインパスワード（自動作成） |
| `ダッシュボード設定` | ダッシュボード設定データ（自動作成） |

## セットアップ手順

### 1. スプレッドシートの準備

1. Google スプレッドシートを開く（または新規作成）
2. 必要なシートを作成（上記参照）

### 2. Apps Scriptの設定

1. スプレッドシートのメニューから **「拡張機能」→「Apps Script」** を選択
2. `Code.gs` の内容をすべてコピーして貼り付け
3. **保存**（Ctrl+S / Cmd+S）

### 3. 売上日報シートのヘッダー作成（初回のみ）

1. Apps Scriptエディタで、関数選択ドロップダウンから `createSalesReportHeaders` を選択
2. **「実行」** をクリック
3. 初回は権限の承認が必要です（「詳細」→「安全でないページに移動」→「許可」）

### 4. Web Appとしてデプロイ

1. Apps Scriptエディタで **「デプロイ」→「新しいデプロイ」** をクリック
2. **「種類の選択」** で歯車アイコン → **「ウェブアプリ」** を選択
3. 以下を設定：
   - **説明**: `Mavie Dashboard API v1`
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員`
4. **「デプロイ」** をクリック
5. **URLをコピー**（`https://script.google.com/macros/s/xxx/exec` 形式）

### 5. ダッシュボードに設定

1. Mavieダッシュボードを開く
2. **「設定」タブ** へ移動
3. **「スプレッドシート連携設定」** にコピーしたURLを貼り付け
4. **「保存」** → **「接続テスト」** で確認

## 売上日報シートの列構成

`フォーム_売上日報` シートは以下の列構成で作成してください：

| 列 | 項目名 | 説明 |
|----|-------|------|
| A | タイムスタンプ | 入力日時（自動） |
| B | 日付 | 売上の日付 |
| C | 店舗 | `千葉店` or `本厚木店` |
| D | スタッフ名 | 小文字英字（例: kiki, haruka） |
| E | 現金売上 | 数値 |
| F | クレジット売上 | 数値 |
| G | QR売上 | 数値 |
| H | 物販売上 | 数値 |
| I | HPBポイント値引き | 数値 |
| J | HPBギフト値引き | 数値 |
| K | その他値引き | 数値 |
| L | 返金 | 数値 |
| M | 新規HPB | 人数 |
| N | 新規ミニナイ | 人数 |
| O | 紹介客 | 人数 |
| P | 知人 | 人数 |
| Q | 既存 | 人数 |
| R | 次回予約_新規HPB | 人数 |
| S | 次回予約_新規ミニナイ | 人数 |
| T | 次回予約_既存 | 人数 |
| U | 5つ星レビュー | 件数 |

## 顧客アンケートシートの列構成

`フォーム回答_千葉店` / `フォーム回答_本厚木店` は、Googleフォームの回答と自動連携できます。
GASは以下のキーワードでヘッダーを自動検出します：

- **タイムスタンプ**: `タイムスタンプ`, `timestamp`, `回答日時`
- **名前**: `名前`, `氏名`, `お名前`, `name`
- **年齢**: `年齢`, `年代`, `age`
- **性別**: `性別`, `gender`
- **地域**: `地域`, `エリア`, `住所`, `area`, `最寄り`
- **来店経路**: `きっかけ`, `経路`, `来店理由`, `どこで`, `source`
- **来店回数**: `来店回数`, `来店`, `visit`
- **満足度**: `満足度`, `満足`, `satisfaction`
- **コメント**: `コメント`, `感想`, `ご意見`, `comment`, `自由`

## API仕様

### GET リクエスト

| パラメータ | 説明 |
|-----------|------|
| `?action=get_data` | 売上データを取得（デフォルト） |
| `?action=get_customers` | 顧客データを取得 |
| `?action=load_goals` | 目標データを取得 |

### POST リクエスト

```javascript
// 売上データの更新
{
  "action": "update",
  "rows": [{ id: 1, sales: {...}, customers: {...}, ... }]
}

// 目標データの保存
{
  "action": "save_goals",
  "goals": { "2024/01": { "chiba": { "kiki": {...} } } },
  "salaries": { "chiba": { "kiki": 200000 } }
}

// 新規レコードの追加
{
  "action": "add_record",
  "record": { date: "2024/1/15", store: "chiba", staff: "kiki", ... }
}
```

## トラブルシューティング

### 「権限がありません」エラー

1. Apps Scriptエディタで関数を1回実行して権限を承認
2. デプロイを更新（「デプロイを管理」→「新バージョン」）

### データが表示されない

1. シート名が正確か確認（全角・半角に注意）
2. 列の順序が正しいか確認
3. 接続テストでエラーメッセージを確認

### 更新が反映されない

デプロイのURLを更新した場合は、新しいURLをダッシュボードに設定し直してください。
